<!DOCTYPE html>
<!-- ============================================================
     meal-planner/meal-planner.html  ‚Äî  Generic Student Meal Planner
     Updated: 2026-02-19 by Claude
     - uid-based storage (localStorage key = mealPlan_{uid})
     - Base plan loaded from Firestore via AA.getMealBasePlan(),
       falls back to local base-meal-plan.json
     - Admin can set custom base plans per student in Firestore
     - Mary's individual planner (meal-planner-mary/) is unchanged
     ============================================================ -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meal Planner ‚Äî Academic Allies</title>
  <link rel="icon" href="/Academic-Allies/favicon.ico">
  <style>
    body { font-family: 'Atkinson Hyperlegible', Arial, sans-serif; max-width: 1100px; margin: 0 auto; padding: 20px; background: #FAFAF9; color: #333; }
    h1 { color: #2e6b4f; }
    .subtitle { color: #666; font-size: 0.95rem; margin: -10px 0 20px; }

    /* Controls */
    .meal-controls { display: flex; gap: 10px; margin: 18px 0; flex-wrap: wrap; align-items: center; }
    .meal-controls button { padding: 9px 18px; font-size: 15px; cursor: pointer; border-radius: 6px; border: none; font-family: inherit; }
    .btn-primary  { background: #2e6b4f; color: #fff; }
    .btn-secondary{ background: #2196F3; color: #fff; }
    .btn-danger   { background: #f44336; color: #fff; }
    .btn-suggest  { background: #ff9800; color: #fff; }
    .btn-base     { background: #7b5ea7; color: #fff; }

    /* Add meal form */
    .meal-entry { background: #f0f7f4; padding: 18px 20px; border-radius: 10px; margin: 18px 0; border: 1px solid #c9e4d8; }
    .meal-entry h3 { margin: 0 0 12px; color: #2e6b4f; font-size: 1rem; }
    .meal-entry input,
    .meal-entry textarea,
    .meal-entry select { width: 100%; padding: 9px 11px; margin: 5px 0 10px; border-radius: 5px; border: 1px solid #ccc; font-family: inherit; font-size: 14px; box-sizing: border-box; }
    .meal-entry select { background: #fff; }

    /* Meal list */
    .meal-list { margin-top: 16px; }
    .meal-item {
      background: #fff; padding: 14px 16px; margin: 9px 0; border-radius: 8px;
      border-left: 4px solid #2e6b4f; box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;
    }
    .meal-item-body { flex: 1; }
    .meal-item strong { font-size: 1rem; }
    .meal-item .meta { font-size: 0.82rem; color: #666; margin-top: 4px; }
    .meal-item .mtype { display: inline-block; background: #e8f5ee; color: #2e6b4f; border-radius: 4px; padding: 1px 7px; font-size: 0.75rem; font-weight: 600; margin-right: 6px; }
    .btn-remove { background: #f44336; color: #fff; border: none; border-radius: 5px; padding: 4px 12px; cursor: pointer; font-size: 13px; flex-shrink: 0; }

    /* Base plan panel */
    .base-plan-panel { background: #fff; border: 1px solid #c9e4d8; border-radius: 10px; padding: 18px 20px; margin: 18px 0; display: none; }
    .base-plan-panel h3 { margin: 0 0 12px; color: #7b5ea7; }
    .base-plan-section { margin-bottom: 14px; }
    .base-plan-section h4 { margin: 0 0 6px; font-size: 0.9rem; color: #555; }
    .base-plan-section ul { margin: 0; padding-left: 18px; }
    .base-plan-section li { font-size: 0.88rem; color: #444; margin: 3px 0; }

    /* Sign-in notice */
    #signin-notice { padding: 30px; text-align: center; color: #888; font-size: 0.95rem; }
  </style>
</head>
<body>
  <div id="site-header"></div>

  <!-- Load shared header + Firebase -->
  <script>
    fetch('/Academic-Allies/modular/shared-header.html')
      .then(function(r) { return r.text(); })
      .then(function(html) {
        var c = document.getElementById('site-header');
        c.innerHTML = html;
        c.querySelectorAll('script').forEach(function(old) {
          var s = document.createElement('script');
          Array.from(old.attributes).forEach(function(a) { s.setAttribute(a.name, a.value); });
          s.textContent = old.textContent;
          old.replaceWith(s);
        });
      });
  </script>

  <div id="signin-notice">Loading‚Ä¶</div>
  <div id="planner-body" style="display:none;">

    <h1 id="planner-title">Meal Planner</h1>
    <p class="subtitle" id="planner-subtitle">Track daily meals. Base plan can be customized by your admin.</p>

    <!-- Controls row -->
    <div class="meal-controls">
      <button class="btn-suggest" onclick="suggestFromBase()">üí° Suggest a Meal</button>
      <button class="btn-base"    onclick="toggleBasePlan()">üìã View Base Plan</button>
      <button class="btn-danger"  onclick="resetPlan()">üóë Clear Today</button>
    </div>

    <!-- Base plan panel (hidden until toggled) -->
    <div class="base-plan-panel" id="base-plan-panel">
      <h3>üìã Base Meal Plan</h3>
      <p style="font-size:0.85rem;color:#888;margin:0 0 12px;">These are the default meal suggestions for your plan. Your admin can customize this for you.</p>
      <div id="base-plan-sections"></div>
    </div>

    <!-- Add meal form -->
    <div class="meal-entry">
      <h3>Add a Meal</h3>
      <select id="mealType">
        <option value="">Meal type (optional)</option>
        <option value="Breakfast">Breakfast</option>
        <option value="Lunch">Lunch</option>
        <option value="Dinner">Dinner</option>
        <option value="Snack">Snack</option>
      </select>
      <input  type="text"  id="mealName"  placeholder="Meal name (e.g. Grilled chicken, rice, broccoli)">
      <input  type="time"  id="mealTime">
      <textarea id="mealNotes" placeholder="Notes (optional)" rows="2"></textarea>
      <button class="btn-primary" onclick="addMeal()">+ Add Meal</button>
    </div>

    <!-- Today's meals -->
    <div>
      <h3 style="color:#2e6b4f;">Today's Meals: <span id="mealCount">0</span></h3>
      <div id="mealList" class="meal-list"></div>
    </div>

  </div><!-- /planner-body -->

  <script>
    // ‚îÄ‚îÄ Meal Planner ‚Äî Generic version
    // Updated 2026-02-19 by Claude
    // Firestore-only: no localStorage. Meals sync across devices in real-time.

    var currentUid    = null;
    var currentName   = null;
    var todaysMeals   = [];
    var basePlan      = {};
    var basePanelOpen = false;
    var unsubMealLog  = null;
    var dateKey       = new Date().toISOString().split('T')[0];

    /* ‚îÄ‚îÄ Wait for AA to be ready ‚îÄ‚îÄ */
    function waitForAA(cb, tries) {
      tries = tries || 0;
      if (window.AA && window.AA.auth && window.AA.db) { cb(); return; }
      if (tries > 40) {
        document.getElementById('signin-notice').textContent = 'Could not connect ‚Äî please refresh.';
        return;
      }
      setTimeout(function() { waitForAA(cb, tries + 1); }, 200);
    }

    function boot() {
      AA.auth.onAuthStateChanged(function(user) {
        if (!user) {
          document.getElementById('signin-notice').textContent = 'Please sign in to use the meal planner.';
          return;
        }
        currentUid  = user.uid;
        currentName = user.displayName || user.email;

        document.getElementById('signin-notice').style.display   = 'none';
        document.getElementById('planner-body').style.display    = 'block';
        document.getElementById('planner-title').textContent     = currentName + "'s Meal Planner";

        startMealListener();
        loadBasePlan();
      });
    }

    /* ‚îÄ‚îÄ Real-time Firestore listener for today's meals ‚îÄ‚îÄ
       Updated 2026-02-19 by Claude ‚Äî replaced localStorage with Firestore.
       AA.watchMealLog keeps todaysMeals in sync across all devices. */
    function startMealListener() {
      if (unsubMealLog) { unsubMealLog(); }
      unsubMealLog = AA.watchMealLog(currentUid, dateKey, function(data) {
        todaysMeals = (data && Array.isArray(data.meals)) ? data.meals : [];
        displayMeals();
      });
    }

    /* ‚îÄ‚îÄ Load base plan: Firestore first, fallback to local JSON ‚îÄ‚îÄ */
    function loadBasePlan() {
      AA.getMealBasePlan(currentUid)
        .then(function(plan) {
          if (plan && Object.keys(plan).length > 1) {
            // Firestore custom plan exists
            basePlan = plan;
            renderBasePlanPanel();
          } else {
            // Fall back to bundled JSON
            return fetch('base-meal-plan.json')
              .then(function(r) { return r.json(); })
              .then(function(json) {
                basePlan = json;
                renderBasePlanPanel();
              });
          }
        })
        .catch(function() {
          // Offline or not found ‚Äî try local JSON
          fetch('base-meal-plan.json')
            .then(function(r) { return r.json(); })
            .then(function(json) { basePlan = json; renderBasePlanPanel(); })
            .catch(function() {});
        });
    }

    /* ‚îÄ‚îÄ Render base plan panel sections ‚îÄ‚îÄ */
    function renderBasePlanPanel() {
      var container = document.getElementById('base-plan-sections');
      container.innerHTML = '';
      var categories = ['Breakfast', 'Lunch', 'Dinner', 'Snacks', 'Snack'];
      categories.forEach(function(cat) {
        var items = basePlan[cat];
        if (!items || !items.length) return;
        var section = document.createElement('div');
        section.className = 'base-plan-section';
        section.innerHTML = '<h4>' + cat + '</h4><ul>' +
          items.map(function(i) { return '<li>' + esc(i) + '</li>'; }).join('') +
          '</ul>';
        container.appendChild(section);
      });
    }

    /* ‚îÄ‚îÄ Toggle base plan panel ‚îÄ‚îÄ */
    function toggleBasePlan() {
      var panel = document.getElementById('base-plan-panel');
      basePanelOpen = !basePanelOpen;
      panel.style.display = basePanelOpen ? 'block' : 'none';
    }

    /* ‚îÄ‚îÄ Suggest a random meal from base plan ‚îÄ‚îÄ */
    function suggestFromBase() {
      var type = document.getElementById('mealType').value || 'Lunch';
      var options = basePlan[type] || basePlan['Lunch'] || [];
      if (!options.length) {
        alert('No suggestions available for ' + type + ' in the base plan.');
        return;
      }
      var pick = options[Math.floor(Math.random() * options.length)];
      document.getElementById('mealName').value = pick;
      document.getElementById('mealType').value = type;
    }

    /* ‚îÄ‚îÄ Display meals list ‚îÄ‚îÄ */
    function displayMeals() {
      var list  = document.getElementById('mealList');
      var count = document.getElementById('mealCount');
      count.textContent = todaysMeals.length;

      if (todaysMeals.length === 0) {
        list.innerHTML = '<p style="color:#aaa;font-size:0.9rem;">No meals added yet today.</p>';
        return;
      }

      list.innerHTML = todaysMeals.map(function(meal, i) {
        var timeStr = meal.time ? to12HourSafe(meal.time) : '';
        return '<div class="meal-item">' +
          '<div class="meal-item-body">' +
            (meal.type ? '<span class="mtype">' + esc(meal.type) + '</span>' : '') +
            '<strong>' + esc(meal.name || '(unnamed)') + '</strong>' +
            '<div class="meta">' +
              (timeStr ? 'üïê ' + timeStr + '  ' : '') +
              (meal.notes ? 'üìù ' + esc(meal.notes) : '') +
            '</div>' +
          '</div>' +
          '<button class="btn-remove" onclick="removeMeal(' + i + ')">Remove</button>' +
        '</div>';
      }).join('');
    }

    /* ‚îÄ‚îÄ Add a meal ‚îÄ‚îÄ */
    function addMeal() {
      var name  = document.getElementById('mealName').value.trim();
      var time  = document.getElementById('mealTime').value;
      var notes = document.getElementById('mealNotes').value.trim();
      var type  = document.getElementById('mealType').value;

      if (!name && !time) {
        alert('Please enter at least a meal name or time.');
        return;
      }

      todaysMeals.push({ name: name || '(unnamed)', time: time, notes: notes, type: type, addedAt: Date.now() });
      AA.saveMealLog(currentUid, dateKey, todaysMeals)
        .catch(function(err) { console.error('[AA] saveMealLog:', err); });
      // onSnapshot will refresh displayMeals() automatically

      document.getElementById('mealName').value  = '';
      document.getElementById('mealTime').value  = '';
      document.getElementById('mealNotes').value = '';
      document.getElementById('mealType').value  = '';
    }

    /* ‚îÄ‚îÄ Remove a meal ‚îÄ‚îÄ */
    function removeMeal(index) {
      todaysMeals.splice(index, 1);
      AA.saveMealLog(currentUid, dateKey, todaysMeals)
        .catch(function(err) { console.error('[AA] saveMealLog:', err); });
    }

    /* ‚îÄ‚îÄ Reset today's plan ‚îÄ‚îÄ */
    function resetPlan() {
      if (confirm('Clear all meals for today?')) {
        todaysMeals = [];
        AA.saveMealLog(currentUid, dateKey, [])
          .catch(function(err) { console.error('[AA] saveMealLog:', err); });
      }
    }

    /* ‚îÄ‚îÄ 12-hour time helper (safe fallback if time-utils.js not loaded) ‚îÄ‚îÄ */
    function to12HourSafe(t) {
      if (typeof to12Hour === 'function') return to12Hour(t);
      if (!t) return '';
      var parts = t.split(':');
      var h = parseInt(parts[0], 10);
      var m = parts[1];
      var ampm = h >= 12 ? 'PM' : 'AM';
      h = h % 12 || 12;
      return h + ':' + m + ' ' + ampm;
    }

    /* ‚îÄ‚îÄ HTML escape ‚îÄ‚îÄ */
    function esc(s) {
      return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    waitForAA(boot);
  </script>
</body>
</html>
