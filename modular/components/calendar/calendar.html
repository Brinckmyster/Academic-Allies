<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendar ‚Äî Academic Allies</title>
  <link rel="icon" href="/Academic-Allies/favicon.ico">
  <style>
    body { font-family: 'Atkinson Hyperlegible', Arial, sans-serif; background: #FAFAF9; color: #333; margin: 0; padding: 0 0 60px; }
    .container { max-width: 900px; margin: 0 auto; padding: 0 16px; }

    /* ‚îÄ‚îÄ Nav bar ‚îÄ‚îÄ */
    .cal-nav {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 0 10px;
    }
    .cal-nav h2 { margin: 0; font-size: 1.3rem; color: #4a7f82; }
    .cal-nav-btns { display: flex; gap: 8px; }
    .cal-btn {
      padding: 6px 14px; border: 1px solid #ccc; border-radius: 6px;
      background: #fff; cursor: pointer; font-size: 0.88rem; color: #555;
    }
    .cal-btn:hover { background: #e8f2f3; border-color: #4a7f82; color: #4a7f82; }
    .cal-btn.today-btn { background: #4a7f82; color: #fff; border-color: #4a7f82; }
    .cal-btn.today-btn:hover { background: #3d6e71; }

    /* ‚îÄ‚îÄ Grid ‚îÄ‚îÄ */
    .cal-grid {
      display: grid; grid-template-columns: repeat(7, 1fr);
      border: 1px solid #e1e5e9; border-radius: 10px; overflow: hidden;
      background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }
    .cal-dow {
      text-align: center; padding: 8px 4px; font-size: 0.75rem; font-weight: 700;
      color: #888; background: #f8fafc; border-bottom: 1px solid #e1e5e9;
      text-transform: uppercase; letter-spacing: 0.05em;
    }
    .cal-dow:not(:last-child) { border-right: 1px solid #f0f0f0; }

    .cal-day {
      min-height: 72px; padding: 6px 8px; border-bottom: 1px solid #f0f0f0;
      border-right: 1px solid #f0f0f0; position: relative; cursor: pointer;
      transition: background 0.15s;
    }
    .cal-day:nth-child(7n) { border-right: none; }
    .cal-day:hover { background: #f0f8f9; }
    .cal-day.other-month { background: #fafafa; }
    .cal-day.other-month .day-num { color: #ccc; }
    .cal-day.today { background: #e8f5f5; }
    .cal-day.today .day-num {
      background: #4a7f82; color: #fff; border-radius: 50%;
      width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
      font-weight: 700;
    }
    .cal-day.selected { outline: 2px solid #4a7f82; outline-offset: -2px; }

    .day-num { font-size: 0.82rem; font-weight: 600; color: #555; margin-bottom: 4px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; }
    .day-dots { display: flex; flex-wrap: wrap; gap: 3px; margin-top: 2px; }
    .day-dot {
      width: 8px; height: 8px; border-radius: 50%;
    }
    .dot-checkin  { background: #4a7f82; }
    .dot-meal     { background: #f59e0b; }
    .dot-nope     { background: #ef4444; }
    .dot-spoon    { background: #8b5cf6; }

    /* ‚îÄ‚îÄ Detail panel ‚îÄ‚îÄ */
    #detail-panel {
      margin-top: 16px; background: #fff; border: 1px solid #e1e5e9;
      border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: none;
    }
    #detail-panel h3 { margin: 0 0 14px; color: #4a7f82; font-size: 1.05rem; }
    .detail-section { margin-bottom: 14px; }
    .detail-section-title {
      font-size: 0.78rem; font-weight: 700; text-transform: uppercase;
      color: #888; letter-spacing: 0.05em; margin-bottom: 6px;
    }
    .detail-entry {
      font-size: 0.9rem; padding: 6px 10px; background: #f8fafc;
      border-radius: 6px; margin-bottom: 4px; display: flex;
      align-items: flex-start; gap: 8px;
    }
    .detail-entry .entry-icon { font-size: 1rem; flex-shrink: 0; }
    .detail-entry .entry-text { line-height: 1.4; }
    .gcal-btn {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 5px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 600;
      background: #fff; border: 1px solid #4285f4; color: #4285f4;
      text-decoration: none; cursor: pointer; margin-top: 8px;
      transition: background 0.15s;
    }
    .gcal-btn:hover { background: #e8f0fe; }
    #detail-empty { color: #aaa; font-size: 0.9rem; text-align: center; padding: 20px 0; }

    /* Legend */
    .cal-legend {
      display: flex; gap: 16px; flex-wrap: wrap; margin-top: 12px;
      font-size: 0.78rem; color: #666;
    }
    .legend-item { display: flex; align-items: center; gap: 5px; }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; }

    #cal-loading { text-align: center; padding: 40px; color: #aaa; }

    /* ‚îÄ‚îÄ Google Calendar ‚îÄ‚îÄ */
    .gcal-connect-bar {
      display: flex; align-items: center; gap: 10px; margin-bottom: 12px;
      padding: 10px 14px; background: #fff; border: 1px solid #e1e5e9;
      border-radius: 8px; font-size: 0.88rem;
    }
    .gcal-connect-bar span { flex: 1; color: #555; }
    .btn-gcal {
      padding: 7px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600;
      cursor: pointer; border: 1px solid #4285f4; background: #fff; color: #4285f4;
      display: flex; align-items: center; gap: 6px; transition: background 0.15s;
    }
    .btn-gcal:hover { background: #e8f0fe; }
    .btn-gcal.connected { border-color: #10b981; color: #10b981; }
    .dot-gcal { background: #4285f4; }
  </style>
</head>
<body>
  <div id="site-header"></div>
  <div id="cal-loading">Loading calendar‚Ä¶</div>

  <div class="container" id="cal-container" style="display:none;">
    <div class="cal-nav">
      <button class="cal-btn" onclick="changeMonth(-1)">‚óÄ Prev</button>
      <h2 id="cal-title">Month Year</h2>
      <div class="cal-nav-btns">
        <button class="cal-btn today-btn" onclick="goToday()">Today</button>
        <button class="cal-btn" onclick="changeMonth(1)">Next ‚ñ∂</button>
      </div>
    </div>

    <div class="cal-grid" id="cal-grid">
      <div class="cal-dow">Sun</div>
      <div class="cal-dow">Mon</div>
      <div class="cal-dow">Tue</div>
      <div class="cal-dow">Wed</div>
      <div class="cal-dow">Thu</div>
      <div class="cal-dow">Fri</div>
      <div class="cal-dow">Sat</div>
    </div>

    <!-- Google Calendar connect bar ‚Äî only visible to the owner, never in mirror -->
    <div class="gcal-connect-bar" id="gcal-bar">
      <span id="gcal-status">üìÖ Connect Google Calendar to see your events here</span>
      <button class="btn-gcal" id="gcal-btn" onclick="gcalConnect()">üîó Connect</button>
    </div>

    <div class="cal-legend">
      <div class="legend-item"><div class="legend-dot dot-checkin"></div> Check-in logged</div>
      <div class="legend-item"><div class="legend-dot dot-meal"></div> Meals logged</div>
      <div class="legend-item"><div class="legend-dot dot-gcal"></div> Google Calendar event</div>
    </div>

    <div id="detail-panel">
      <h3 id="detail-date"></h3>
      <div id="detail-content"></div>
    </div>
  </div>

  <!-- Shared header -->
  <script>
    fetch('/Academic-Allies/modular/shared-header.html?v=20260301a')
      .then(function(r) { return r.text(); })
      .then(function(html) {
        var c = document.getElementById('site-header');
        c.innerHTML = html;
        c.querySelectorAll('script').forEach(function(old) {
          var s = document.createElement('script');
          Array.from(old.attributes).forEach(function(a) { s.setAttribute(a.name, a.value); });
          s.textContent = old.textContent;
          old.replaceWith(s);
        });
      });
  </script>

  <script>
  // ‚îÄ‚îÄ Google Calendar config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Client ID from console.cloud.google.com ‚Üí OAuth 2.0 credentials.
  // gcalToken, gcalEvents, gcalConnect, and loadGcalMonth are defined
  // INSIDE the IIFE below so they can access viewYear/viewMonth/refreshCalendar.
  var GCAL_CLIENT_ID = '93996985456-bf65ba18asc6vajl9ngs4kge19qet341.apps.googleusercontent.com';
  var GCAL_SCOPE     = 'https://www.googleapis.com/auth/calendar.readonly';
  // ‚îÄ‚îÄ End Google Calendar config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  (function() {
    'use strict';

    var viewYear  = new Date().getFullYear();
    var viewMonth = new Date().getMonth(); // 0-indexed
    var today     = new Date();
    var currentUid = null;
    var selectedDateKey = null;
    var gcalToken  = null;   // Google Calendar OAuth access token
    var gcalEvents = {};     // { 'YYYY-MM-DD': ['Event title', ...] }

    /* ‚îÄ‚îÄ Google Calendar: connect + multi-calendar fetch ‚îÄ‚îÄ‚îÄ‚îÄ */
    /* Fixed 2026-02-20 by Claude: moved inside IIFE so gcalConnect can access
       viewYear/viewMonth/refreshCalendar without scoping issues.
       Also upgraded to fetch ALL calendars (not just primary). */
    window.gcalConnect = function() {
      if (!GCAL_CLIENT_ID || GCAL_CLIENT_ID.startsWith('YOUR_')) {
        alert('Google Calendar is not configured yet. Ask your admin to add the Google Client ID.');
        return;
      }
      if (!window.google || !window.google.accounts) {
        alert('Google sign-in library not loaded. Check your internet connection and try again.');
        return;
      }
      var client = google.accounts.oauth2.initTokenClient({
        client_id: GCAL_CLIENT_ID,
        scope:     GCAL_SCOPE,
        callback:  function(resp) {
          if (resp.error) { console.error('[GCal]', resp); return; }
          gcalToken = resp.access_token;
          document.getElementById('gcal-btn').textContent    = '‚úÖ Connected';
          document.getElementById('gcal-btn').className      = 'btn-gcal connected';
          document.getElementById('gcal-status').textContent = 'üìÖ Google Calendar connected';
          loadGcalMonth(viewYear, viewMonth); // now correctly uses IIFE-local viewYear/viewMonth
        }
      });
      client.requestAccessToken();
    };

    function loadGcalMonth(year, month) {
      if (!gcalToken) return;
      var timeMin = new Date(year, month, 1).toISOString();
      var timeMax = new Date(year, month + 1, 0, 23, 59, 59).toISOString();
      var hdrs    = { 'Authorization': 'Bearer ' + gcalToken };

      // Step 1: list ALL calendars the user has access to
      fetch('https://www.googleapis.com/calendar/v3/users/me/calendarList?maxResults=50', { headers: hdrs })
        .then(function(r) { return r.json(); })
        .then(function(list) {
          var calIds = (list.items || []).map(function(c) { return c.id; });
          if (!calIds.length) calIds = ['primary'];

          // Step 2: fetch events from each calendar in parallel
          var fetches = calIds.map(function(id) {
            return fetch(
              'https://www.googleapis.com/calendar/v3/calendars/' +
              encodeURIComponent(id) + '/events' +
              '?timeMin=' + encodeURIComponent(timeMin) +
              '&timeMax=' + encodeURIComponent(timeMax) +
              '&singleEvents=true&orderBy=startTime&maxResults=100',
              { headers: hdrs }
            )
            .then(function(r) { return r.json(); })
            .then(function(d)  { return d.items || []; })
            .catch(function()  { return []; }); // skip calendars that error
          });
          return Promise.all(fetches);
        })
        .then(function(allItems) {
          gcalEvents = {};
          allItems.forEach(function(items) {
            items.forEach(function(ev) {
              var start = ev.start.date || (ev.start.dateTime || '').split('T')[0];
              if (start) {
                if (!gcalEvents[start]) gcalEvents[start] = [];
                gcalEvents[start].push(ev.summary || '(No title)');
              }
            });
          });
          refreshCalendar(); // re-render grid with all calendar dots ‚Äî now works!
        })
        .catch(function(err) { console.error('[GCal] load error:', err); });
    }
    /* ‚îÄ‚îÄ End Google Calendar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

    // Cache for loaded month data: { checkins: {dateKey: [entries]}, meals: {dateKey: [meals]} }
    var cache = {};

    var MONTH_NAMES = ['January','February','March','April','May','June',
                       'July','August','September','October','November','December'];
    var DOW = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

    function waitForAA(cb, tries) {
      tries = tries || 0;
      if (window.AA && window.AA.auth && window.AA.db) { cb(); return; }
      if (tries > 40) { document.getElementById('cal-loading').textContent = 'Could not connect.'; return; }
      setTimeout(function() { waitForAA(cb, tries + 1); }, 200);
    }

    function pad(n) { return String(n).padStart(2, '0'); }
    function dateKey(y, m, d) { return y + '-' + pad(m + 1) + '-' + pad(d); }
    function todayKey() { return dateKey(today.getFullYear(), today.getMonth(), today.getDate()); }

    /* ‚îÄ‚îÄ Fetch all check-ins + meal logs for the visible month ‚îÄ‚îÄ */
    function loadMonthData(uid, year, month, cb) {
      var cacheKey = uid + '_' + year + '_' + month;
      if (cache[cacheKey]) { cb(cache[cacheKey]); return; }

      var data = { checkins: {}, meals: {} };
      var daysInMonth = new Date(year, month + 1, 0).getDate();

      var checkinPromises = [];
      var mealPromises    = [];

      for (var d = 1; d <= daysInMonth; d++) {
        var dk = dateKey(year, month, d);
        (function(key) {
          checkinPromises.push(
            AA.db.collection('checkins').doc(uid).collection('days').doc(key).get()
              .then(function(doc) {
                if (doc.exists && doc.data().entries && doc.data().entries.length > 0) {
                  data.checkins[key] = doc.data().entries;
                }
              }).catch(function() {})
          );
          mealPromises.push(
            AA.db.collection('mealLogs').doc(uid).collection('days').doc(key).get()
              .then(function(doc) {
                if (doc.exists && doc.data().meals && doc.data().meals.length > 0) {
                  data.meals[key] = doc.data().meals;
                }
              }).catch(function() {})
          );
        })(dk);
      }

      Promise.all(checkinPromises.concat(mealPromises)).then(function() {
        cache[cacheKey] = data;
        cb(data);
      });
    }

    /* ‚îÄ‚îÄ Build the calendar grid ‚îÄ‚îÄ */
    function buildGrid(data) {
      var grid = document.getElementById('cal-grid');

      // Remove previous day cells (keep DOW headers = first 7 children)
      while (grid.children.length > 7) {
        grid.removeChild(grid.lastChild);
      }

      var firstDay = new Date(viewYear, viewMonth, 1).getDay(); // 0=Sun
      var daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
      var prevMonthDays = new Date(viewYear, viewMonth, 0).getDate();

      // Fill leading blanks (prev month overflow)
      for (var b = 0; b < firstDay; b++) {
        var d = prevMonthDays - firstDay + 1 + b;
        var cell = makeCell(null, d, true);
        grid.appendChild(cell);
      }

      // Current month days
      for (var day = 1; day <= daysInMonth; day++) {
        var dk = dateKey(viewYear, viewMonth, day);
        var isToday = (dk === todayKey());
        var hasCheckin = !!data.checkins[dk];
        var hasMeal    = !!data.meals[dk];
        var cell = makeCell(dk, day, false, isToday, hasCheckin, hasMeal);
        grid.appendChild(cell);
      }

      // Trailing blanks
      var total = firstDay + daysInMonth;
      var trailing = total % 7 === 0 ? 0 : 7 - (total % 7);
      for (var t = 1; t <= trailing; t++) {
        grid.appendChild(makeCell(null, t, true));
      }

      document.getElementById('cal-title').textContent = MONTH_NAMES[viewMonth] + ' ' + viewYear;

      // Re-select if same day still visible
      if (selectedDateKey) {
        var sel = grid.querySelector('[data-dk="' + selectedDateKey + '"]');
        if (sel) sel.classList.add('selected');
      }
    }

    function makeCell(dk, dayNum, otherMonth, isToday, hasCheckin, hasMeal) {
      var cell = document.createElement('div');
      cell.className = 'cal-day' +
        (otherMonth ? ' other-month' : '') +
        (isToday    ? ' today'       : '');
      if (dk) cell.dataset.dk = dk;

      var numDiv = document.createElement('div');
      numDiv.className = 'day-num';
      numDiv.textContent = dayNum;
      cell.appendChild(numDiv);

      if (!otherMonth) {
        var dots = document.createElement('div');
        dots.className = 'day-dots';
        if (hasCheckin)           { var d = document.createElement('div'); d.className = 'day-dot dot-checkin'; dots.appendChild(d); }
        if (hasMeal)              { var d = document.createElement('div'); d.className = 'day-dot dot-meal';    dots.appendChild(d); }
        if (gcalEvents && gcalEvents[dk] && gcalEvents[dk].length > 0) {
          var d = document.createElement('div'); d.className = 'day-dot dot-gcal'; dots.appendChild(d);
        }
        cell.appendChild(dots);

        cell.addEventListener('click', function() { selectDay(dk, cell); });
      }
      return cell;
    }

    /* ‚îÄ‚îÄ Day detail panel ‚îÄ‚îÄ */
    function selectDay(dk, cell) {
      document.querySelectorAll('.cal-day.selected').forEach(function(c) { c.classList.remove('selected'); });
      cell.classList.add('selected');
      selectedDateKey = dk;

      var panel   = document.getElementById('detail-panel');
      var content = document.getElementById('detail-content');
      var parts   = dk.split('-');
      var dispDate = MONTH_NAMES[parseInt(parts[1]) - 1] + ' ' + parseInt(parts[2]) + ', ' + parts[0];
      document.getElementById('detail-date').textContent = 'üìÖ ' + dispDate;

      var cacheKey = currentUid + '_' + viewYear + '_' + viewMonth;
      var data = cache[cacheKey] || { checkins: {}, meals: {} };
      var entries = data.checkins[dk] || [];
      var meals   = data.meals[dk]   || [];

      content.innerHTML = '';

      var gcalDayEvents = (gcalEvents && gcalEvents[dk]) ? gcalEvents[dk] : [];

      if (entries.length === 0 && meals.length === 0 && gcalDayEvents.length === 0) {
        content.innerHTML = '<div id="detail-empty">Nothing logged for this day.</div>';
        panel.style.display = 'block';
        return;
      }

      // Check-ins section
      if (entries.length > 0) {
        var sec = document.createElement('div');
        sec.className = 'detail-section';
        sec.innerHTML = '<div class="detail-section-title">ü©∫ Check-ins</div>';

        entries.forEach(function(e) {
          var moodEmoji = {excellent:'üòÑ', good:'üôÇ', okay:'üòê', poor:'üòû', terrible:'üòñ'}[e.mood] || '‚ùì';
          var flagEmoji = {red:'üî¥', orange:'üü†', yellow:'üü°', green:'üü¢'}[e.flag] || '';
          var summary = [
            flagEmoji,
            moodEmoji + ' ' + (e.mood || ''),
            e.pain    ? 'Pain: ' + e.pain + '/10'    : '',
            e.fatigue ? 'Fatigue: ' + e.fatigue + '/10' : '',
            e.notes   ? '"' + e.notes + '"' : ''
          ].filter(Boolean).join(' ¬∑ ');

          var entry = document.createElement('div');
          entry.className = 'detail-entry';
          entry.innerHTML =
            '<div class="entry-icon">üìã</div>' +
            '<div class="entry-text">' + esc(summary) +
            (e.timestamp ? '<br><small style="color:#aaa">' + fmtTs(e.timestamp) + '</small>' : '') +
            '</div>';
          sec.appendChild(entry);
        });

        // Google Calendar link for check-in summary
        var gcalLink = makeGcalLink(
          'AA Check-in: ' + (entries[0].mood || 'logged'),
          dk,
          entries.map(function(e) { return (e.mood || '') + (e.pain ? ' pain:' + e.pain : '') + (e.notes ? ' ‚Äì ' + e.notes : ''); }).join('; ')
        );
        var btn = document.createElement('a');
        btn.className = 'gcal-btn';
        btn.href = gcalLink;
        btn.target = '_blank';
        btn.innerHTML = 'üìÜ Add to Google Calendar';
        sec.appendChild(btn);

        content.appendChild(sec);
      }

      // Meals section
      if (meals.length > 0) {
        var sec2 = document.createElement('div');
        sec2.className = 'detail-section';
        sec2.innerHTML = '<div class="detail-section-title">ü•ó Meals Logged</div>';

        meals.forEach(function(m) {
          var entry = document.createElement('div');
          entry.className = 'detail-entry';
          var typeEmoji = {Breakfast:'üåÖ', Lunch:'‚òÄÔ∏è', Dinner:'üåô', Snack:'üçé', Snacks:'üçé'}[m.type] || 'üçΩÔ∏è';
          entry.innerHTML =
            '<div class="entry-icon">' + typeEmoji + '</div>' +
            '<div class="entry-text">' + esc(m.type + ': ' + m.name) +
            (m.time ? ' <small style="color:#aaa">@ ' + m.time + '</small>' : '') +
            '</div>';
          sec2.appendChild(entry);
        });

        var gcalLink2 = makeGcalLink(
          'AA Meals: ' + meals.length + ' logged',
          dk,
          meals.map(function(m) { return m.type + ': ' + m.name; }).join(', ')
        );
        var btn2 = document.createElement('a');
        btn2.className = 'gcal-btn';
        btn2.href = gcalLink2;
        btn2.target = '_blank';
        btn2.innerHTML = 'üìÜ Add to Google Calendar';
        sec2.appendChild(btn2);

        content.appendChild(sec2);
      }

      // Google Calendar events section
      if (gcalDayEvents.length > 0) {
        var sec3 = document.createElement('div');
        sec3.className = 'detail-section';
        sec3.innerHTML = '<div class="detail-section-title">üìÖ Google Calendar</div>';
        gcalDayEvents.forEach(function(title) {
          var entry = document.createElement('div');
          entry.className = 'detail-entry';
          entry.innerHTML = '<div class="entry-icon">üìå</div><div class="entry-text">' + esc(title) + '</div>';
          sec3.appendChild(entry);
        });
        content.appendChild(sec3);
        // Update empty check
        var emptyEl = document.getElementById('detail-empty');
        if (emptyEl) emptyEl.remove();
      }

      panel.style.display = 'block';
    }

    /* ‚îÄ‚îÄ Build a Google Calendar add-event URL (all-day event) ‚îÄ‚îÄ */
    function makeGcalLink(title, dateKey, details) {
      // All-day event: dates param = YYYYMMDD/YYYYMMDD+1
      var parts = dateKey.split('-');
      var y = parseInt(parts[0]), m = parseInt(parts[1]), d = parseInt(parts[2]);
      var startStr = parts[0] + parts[1] + pad(d);
      var endDate  = new Date(y, m - 1, d + 1);
      var endStr   = endDate.getFullYear() + pad(endDate.getMonth() + 1) + pad(endDate.getDate());
      return 'https://calendar.google.com/calendar/render?action=TEMPLATE' +
        '&text=' + encodeURIComponent(title) +
        '&dates=' + startStr + '/' + endStr +
        '&details=' + encodeURIComponent(details || '') +
        '&sf=true&output=xml';
    }

    /* ‚îÄ‚îÄ Month navigation ‚îÄ‚îÄ */
    window.changeMonth = function(dir) {
      viewMonth += dir;
      if (viewMonth > 11) { viewMonth = 0; viewYear++; }
      if (viewMonth < 0)  { viewMonth = 11; viewYear--; }
      document.getElementById('detail-panel').style.display = 'none';
      selectedDateKey = null;
      gcalEvents = {}; // clear so new month loads fresh
      if (gcalToken) loadGcalMonth(viewYear, viewMonth);
      refreshCalendar();
    };

    window.goToday = function() {
      viewYear  = today.getFullYear();
      viewMonth = today.getMonth();
      document.getElementById('detail-panel').style.display = 'none';
      selectedDateKey = null;
      gcalEvents = {};
      if (gcalToken) loadGcalMonth(viewYear, viewMonth);
      refreshCalendar();
    };

    function refreshCalendar() {
      loadMonthData(currentUid, viewYear, viewMonth, function(data) {
        buildGrid(data);
      });
    }

    /* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
    function esc(s) {
      return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function fmtTs(ts) {
      if (!ts) return '';
      var d = (ts && ts.toDate) ? ts.toDate() : new Date(ts);
      if (isNaN(d)) return '';
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    /* ‚îÄ‚îÄ Boot ‚îÄ‚îÄ */
    waitForAA(function() {
      AA.auth.onAuthStateChanged(function(user) {
        if (!user) {
          document.getElementById('cal-loading').textContent = 'Please sign in to view your calendar.';
          return;
        }
        currentUid = window.AA_MIRROR_UID || user.uid;
        document.getElementById('cal-loading').style.display = 'none';
        document.getElementById('cal-container').style.display = 'block';
        /* Hide the Google Calendar connect bar when viewing someone else's calendar */
        if (window.AA_MIRROR_UID) {
          var gcalBar = document.getElementById('gcal-bar');
          if (gcalBar) gcalBar.style.display = 'none';
        }
        refreshCalendar();
      });
    });

  })();
  </script>
</body>
</html>
<!-- Google Identity Services for OAuth (Calendar API) -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<!-- Built: 2026-02-20 Claude ‚Äî Firestore calendar + Google Calendar OAuth integration -->
