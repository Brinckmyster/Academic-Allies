<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recovery Mode ‚Äî Your Safe Space</title>
    <link rel="icon" href="../icons/mode-recovery.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        body {
            font-family: 'Atkinson Hyperlegible', 'OpenDyslexic', Arial, sans-serif;
            font-size: 18pt;
            line-height: 1.5;
            letter-spacing: 0.035em;
            background: #FAFAF9;
            color: #333333;
            min-height: 100vh;
            padding: 20px;
        }
        .recovery-container {
            max-width: 600px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 22pt;
            margin-bottom: 10px;
            color: #6CA0A3;
        }
        .header p {
            font-size: 18pt;
            opacity: 0.9;
        }
        .spoon-counter {
            background: #6CA0A3;
            color: white;
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 20pt;
            font-weight: 600;
        }
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .card h2 {
            color: #6CA0A3;
            margin-bottom: 15px;
            font-size: 20pt;
        }
        .btn {
            background: #6CA0A3;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 18pt;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            min-height: 19mm;
            min-width: 19mm;
            transition: opacity 0.2s;
            font-weight: 600;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .btn:focus {
            outline: 3px solid #6CA0A3;
            outline-offset: 2px;
        }
        .btn-emergency {
            background: #f5576c;
            font-size: 20pt;
            padding: 20px;
        }
        .flower-image {
            width: 100%;
            max-width: 400px;
            height: 300px;
            object-fit: cover;
            border-radius: 15px;
            margin: 15px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .quiz-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        .quiz-btn {
            background: #f0f4ff;
            color: #6CA0A3;
            border: 2px solid #6CA0A3;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16pt;
            min-height: 19mm;
        }
        .quiz-btn:hover {
            background: #6CA0A3;
            color: white;
        }
        .quiz-btn.correct {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }
        .quiz-btn.incorrect {
            background: #f44336;
            color: white;
            border-color: #f44336;
        }
        .hidden {
            display: none;
        }
        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 8px;
            margin: 15px 0;
            overflow: hidden;
        }
        .progress-fill {
            background: #6CA0A3;
            height: 100%;
            transition: width 0.3s ease;
        }
        .achievement {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            padding: 12px;
            border-radius: 12px;
            margin: 10px 0;
            color: #2d3436;
            text-align: center;
            font-weight: 600;
        }

        /* ‚îÄ‚îÄ Breathing Circle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .breathing-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 18px;
            padding: 10px 0 6px;
        }
        .breathing-circle {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            background: radial-gradient(circle at 38% 38%, #c5e8ea 0%, #6CA0A3 65%);
            box-shadow: 0 0 0 12px rgba(108, 160, 163, 0.18);
            animation: breathe-cycle 8s ease-in-out infinite;
            /* aria: described by breathing-label below */
        }
        @keyframes breathe-cycle {
            0%   { transform: scale(0.72); box-shadow: 0 0 0  4px rgba(108,160,163,0.25); }
            50%  { transform: scale(1.22); box-shadow: 0 0 0 28px rgba(108,160,163,0.0);  }
            100% { transform: scale(0.72); box-shadow: 0 0 0  4px rgba(108,160,163,0.25); }
        }
        .breathing-phase {
            font-size: 18pt;
            color: #6CA0A3;
            font-weight: 700;
            min-height: 34px;
            text-align: center;
            letter-spacing: 0.02em;
            transition: opacity 0.6s ease;
        }
        .breathing-timer {
            font-size: 13pt;
            color: #999;
            text-align: center;
            min-height: 24px;
        }
        /* Reduced-motion fallback: no animation, show text only */
        @media (prefers-reduced-motion: reduce) {
            .breathing-circle {
                animation: none;
                transform: scale(1);
            }
        }
        /* ‚îÄ‚îÄ Session bar & new-day banner ‚îÄ‚îÄ‚îÄ Claude 2026-02-27 ‚îÄ‚îÄ */
        .session-bar {
            background: #f0f7f8;
            border: 1px solid #d0e8ea;
            border-radius: 10px;
            padding: 8px 14px;
            margin-bottom: 14px;
            font-size: 14pt;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 6px;
        }
        .session-tz-btn {
            color: #6CA0A3;
            cursor: pointer;
            font-size: 13pt;
            background: none;
            border: none;
            font-family: inherit;
            padding: 0;
            text-decoration: underline;
        }
        .tz-picker-row {
            display: none;
            background: #f0f7f8;
            border-radius: 10px;
            padding: 10px 14px;
            margin-bottom: 12px;
            font-size: 14pt;
            color: #555;
        }
        .tz-picker-row select {
            font-size: 14pt;
            font-family: inherit;
            border-radius: 8px;
            border: 1px solid #ccc;
            padding: 4px 8px;
            margin-left: 6px;
        }
        .new-day-btn {
            background: #fff8e1;
            border: 1px solid #ffca28;
            border-radius: 8px;
            padding: 4px 10px;
            font-size: 13pt;
            font-family: inherit;
            color: #8a6800;
            cursor: pointer;
        }
        /* Claude: task completion styling ‚Äî 2026-02-27 */
        .todo-item.todo-completed { opacity: 0.6; background: #f5f5f5; border-radius: 8px; }
        .todo-item.todo-completed .todo-text { text-decoration: line-through; color: #888; }
        /* Claude: journal card ‚Äî 2026-02-27 */
        .journal-textarea {
            width: 100%; box-sizing: border-box;
            font-family: inherit; font-size: 16pt; line-height: 1.5;
            border: 1px solid #c5dfe1; border-radius: 10px;
            padding: 10px 14px; resize: vertical; min-height: 90px;
            background: #fafffe; color: #333; margin-top: 10px;
        }
        .journal-textarea:focus { outline: 2px solid #6CA0A3; border-color: transparent; }
    </style>
</head>
<body>
<div id="site-header"></div>
<script>
    fetch('/Academic-Allies/modular/shared-header.html?v=20260301a')
      .then(response => response.text())
      .then(html => {
        const container = document.getElementById('site-header');
        container.innerHTML = html;
        const scripts = container.querySelectorAll('script');
        scripts.forEach(oldScript => {
          const newScript = document.createElement('script');
          Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
          newScript.textContent = oldScript.textContent;
          oldScript.replaceWith(newScript);
        });
        const dragScript = document.createElement('script');
        dragScript.src = '/Academic-Allies/modular/js/draggable.js';
        dragScript.onload = () => { if(typeof initDrag === 'function') initDrag(); };
        document.body.appendChild(dragScript);
      });
  </script>
    <div class="recovery-container">
        <div class="header">
            <img src="../icons/mode-recovery.png"
                 alt="Recovery Mode"
                 style="max-width:240px;width:100%;margin-bottom:14px;display:block;margin-left:auto;margin-right:auto;">
            <p>You're safe here, <span id="rm-user-name">friend</span>. Take it one step at a time.</p>
        </div>
        <!-- Spoon Counter - Always Visible -->
        <div class="spoon-counter">
            ü•Ñ Spoons Remaining: <span id="spoons-remaining">10</span> / 10
        </div>
        <!-- Session timestamp ‚Äî Claude 2026-02-27 -->
        <div class="session-bar" id="session-bar">
            <span>üïê Session started: <span id="session-start-display">‚Äî</span></span>
            <button class="new-day-btn" onclick="resetSession()">üåÖ Start New Day</button>
            <button class="session-tz-btn" onclick="toggleTZPicker()">Change timezone</button>
        </div>
        <div class="tz-picker-row" id="tz-picker-row">
            <label for="tz-select">Timezone:</label>
            <select id="tz-select" onchange="saveTZ(this.value)"></select>
        </div>

        <!-- Emergency Support -->
        <div class="card">
            <!-- Claude-credit: fixed broken Aestas dev URL ‚Üí production path 2026-02-26 -->
            <button class="btn btn-emergency" onclick="window.location.href='/Academic-Allies/modular/emergency.html'">
                üÜò I Need Help Now
            </button>
        </div>
        <!-- Energy Check-In -->
        <div class="card">
            <h2>üíö How Exhausted Are You?</h2>
            <p style="margin-bottom: 15px; font-size: 16pt;">Pick the one that feels right:</p>
            <div class="energy-scale" id="energy-scale">
                <div class="energy-option" data-level="10" onclick="selectEnergy(10)">
                    <span class="energy-emoji">üòÅ</span>
                    <span class="energy-label">Fully Charged</span>
                </div>
                <div class="energy-option" data-level="9" onclick="selectEnergy(9)">
                    <span class="energy-emoji">üòä</span>
                    <span class="energy-label">Energized</span>
                </div>
                <div class="energy-option" data-level="8" onclick="selectEnergy(8)">
                    <span class="energy-emoji">üôÇ</span>
                    <span class="energy-label">Pretty Good</span>
                </div>
                <div class="energy-option" data-level="7" onclick="selectEnergy(7)">
                    <span class="energy-emoji">üôÇ</span>
                    <span class="energy-label">Doing Okay</span>
                </div>
                <div class="energy-option" data-level="6" onclick="selectEnergy(6)">
                    <span class="energy-emoji">üòê</span>
                    <span class="energy-label">Neutral</span>
                </div>
                <div class="energy-option" data-level="5" onclick="selectEnergy(5)">
                    <span class="energy-emoji">üòï</span>
                    <span class="energy-label">Starting to Tire</span>
                </div>
                <div class="energy-option" data-level="4" onclick="selectEnergy(4)">
                    <span class="energy-emoji">üòü</span>
                    <span class="energy-label">Pretty Tired</span>
                </div>
                <div class="energy-option" data-level="3" onclick="selectEnergy(3)">
                    <span class="energy-emoji">üò´</span>
                    <span class="energy-label">Very Exhausted</span>
                </div>
                <div class="energy-option" data-level="2" onclick="selectEnergy(2)">
                    <span class="energy-emoji">üò©</span>
                    <span class="energy-label">Almost Empty</span>
                </div>
                <div class="energy-option" data-level="1" onclick="selectEnergy(1)">
                    <span class="energy-emoji">‚ò†Ô∏è</span>
                    <span class="energy-label">Completely Depleted</span>
                </div>
            </div>
        </div>
        <!-- Minimalist To-Do List -->
        <div class="card">
            <h2>‚úÖ Today's Tasks</h2>
            <div id="todo-list">
                <!-- Populated by loadSpoonPlan() -->
                <div style="color:#aaa;font-size:15pt;padding:10px 0;">Loading your plan‚Ä¶</div>
            </div>
            <button class="btn" onclick="window.location.href='/Academic-Allies/modular/components/spoon-planner/spoon-planner.html'">üìã Plan My Spoons</button>
        </div>
        <!-- Gentle Breathing Exercise -->
        <div class="card">
            <h2>ü´Å Breathe With Me</h2>
            <p style="text-align: center; margin-bottom: 10px; color: #666; font-size: 16pt;">
                Follow the circle ‚Äî it grows as you breathe in, shrinks as you breathe out.
            </p>
            <div class="breathing-wrap">
                <div class="breathing-circle"
                     role="img"
                     aria-label="Breathing guide circle ‚Äî expands for 4 seconds (inhale), contracts for 4 seconds (exhale)">
                </div>
                <div class="breathing-phase" id="breathing-phase" aria-live="polite">Breathe in‚Ä¶</div>
                <div class="breathing-timer" id="breathing-timer" aria-live="off">4</div>
            </div>
            <p style="text-align: center; font-size: 14pt; color: #aaa; margin-top: 10px;">
                4 seconds in &nbsp;¬∑&nbsp; 4 seconds out
            </p>
        </div>
        <!-- Simple Meal Suggestions -->
        <div class="card">
            <h2>üçΩÔ∏è Easy Meal Ideas</h2>
            <div class="gentle-reminder">
                Remember: Solids before 5pm, liquids only after 5pm
            </div>
           
            <div id="meal-suggestions">
                <div class="meal-suggestion">
                    <strong>10:30am - Breakfast</strong>
                    Smooth yogurt (lactose-free) with a little applesauce
                </div>
                <div class="meal-suggestion">
                    <strong>1:30pm - Lunch</strong>
                    Mashed potatoes (smooth) with soft turkey slices
                </div>
                <div class="meal-suggestion">
                    <strong>4:30pm - Dinner</strong>
                    Plain white rice with soft-cooked carrots
                </div>
                <div class="meal-suggestion">
                    <strong>After 5pm - Liquids Only</strong>
                    Water, warm water with honey, or clear broth
                </div>
            </div>
           
            <button class="btn" onclick="generateNewMeals()">
                üîÑ Show Different Options
            </button>
        </div>
        <!-- Flower Identification Quiz -->
        <div class="card flower-quiz">
            <h2>üå∫ Flower Arranging Class Practice</h2>
            <p style="margin-bottom: 10px;">Keep your skills fresh while you rest üíö</p>
            <p style="font-size: 16pt; color: #666; margin-bottom: 15px;">All varieties ‚Äî every flower gets equal time! üå∏</p>
           
            <!-- PICTURE FIRST -->
            <img id="flower-image" class="flower-image" src="" alt="Flower to identify">
            <div id="flower-hint" style="text-align: center; color: #6CA0A3; font-weight: 600; margin: 15px 0; font-size: 14pt; display: none;"></div>
            
            <!-- RESULT MESSAGE - appears above buttons after answer -->
            <div id="quiz-result" style="background: #f0f4ff; padding: 15px; border-radius: 12px; margin: 15px 0; text-align: center; font-weight: 600; font-size: 18pt; border: 2px solid #6CA0A3;  min-height: 100px; max-height: 100px; display: flex; align-items: center; justify-content: center; overflow: hidden;"><span style="opacity: 0.5;">Select your answer...</span></div>
            
            <!-- BUTTONS - stay visible -->
            <div class="quiz-buttons" id="quiz-options"></div>
            <button class="btn" onclick="loadNewFlower()" id="next-flower-btn" style="margin-top:5px;">üå∏ Next Flower</button>
            <button class="btn" onclick="reportWrongCategory()" style="background:#ff9500; margin-top:5px; display:none;" id="report-btn">‚ö†Ô∏è Report Wrong Category</button>
            <button class="btn" onclick="viewReports()" style="background:#999; margin-top:10px;">üìã View Reports (<span id="report-count">0</span>)</button>
            <div class="progress-bar">
                <div class="progress-fill" id="quiz-progress" style="width: 0%"></div>
            </div>
            <p style="text-align: center; margin-top: 10px; color: #666;">
                Flowers identified today: <span id="flower-count">0</span>
            </p>
        </div>

        <!-- Genus Practice Quiz ‚Äî Added 2026-02-25 by Claude -->
        <div class="card">
            <h2>üåø Genus Practice</h2>
            <div style="background:#f0f7f8;border-left:4px solid #6CA0A3;border-radius:0 10px 10px 0;padding:10px 14px;font-size:14pt;color:#555;margin-bottom:14px;line-height:1.5;">
                All quizzes ‚Äî every flower tested. See a photo ‚Äî pick the right answer.
            </div>
            <!-- Mode toggle -->
            <div style="display:flex;gap:10px;margin-bottom:16px;">
                <button id="gqModeGenus" onclick="gqSetMode('genus')"
                    style="flex:1;padding:10px;border-radius:10px;border:2px solid #6CA0A3;background:#6CA0A3;color:#fff;font-family:inherit;font-size:14pt;cursor:pointer;min-height:19mm;">
                    üî¨ What's the genus?
                </button>
                <button id="gqModeCommon" onclick="gqSetMode('common')"
                    style="flex:1;padding:10px;border-radius:10px;border:2px solid #ddd;background:#f0f4f5;color:#555;font-family:inherit;font-size:14pt;cursor:pointer;min-height:19mm;">
                    üå∏ Common name?
                </button>
            </div>
            <div id="genusQuiz"></div>
            <div id="genusScore" style="display:none;text-align:center;font-size:18pt;color:#6CA0A3;padding:20px 0;"></div>
            <button id="genusRestart" onclick="gqStart()"
                style="display:none;width:100%;padding:14px;background:#6CA0A3;color:#fff;border:none;border-radius:14px;font-size:16pt;font-family:inherit;cursor:pointer;margin-top:8px;min-height:19mm;">
                Play Again üå±
            </button>
        </div>

        <!-- Tiny Self-Care Wins -->
        <div class="card">
            <h2>üíß Tiny Self-Care Wins</h2>
            <p style="margin-bottom: 15px; color: #666;">Pick just ONE if you can. Or none - that's okay too.</p>
           
            <button class="btn" onclick="markActivity('drink')">
                üíß Drink some water
            </button>
            <button class="btn" onclick="markActivity('stretch')">
                üßò Gentle 2-minute stretch
            </button>
            <button class="btn" onclick="markActivity('sunlight')">
                ‚òÄÔ∏è Sit by a window for 5 min
            </button>
            <button class="btn" onclick="markActivity('music')">
                üéµ Listen to one favorite song
            </button>
           
            <div id="activity-achievements" class="hidden"></div>
        </div>
        <!-- Optional Scripture Comfort -->
        <div class="card">
            <h2>üìñ A Word of Comfort</h2>
            <div id="scripture-verse" style="padding: 20px; background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); border-radius: 15px; text-align: center; font-size: 18pt; line-height: 1.8; color: #2d3436; font-style: italic;">
            </div>
            <button class="btn" onclick="showNewScripture()">
                ‚ú® Show Another Scripture
            </button>
        </div>
        <!-- Support Messages -->
        <div class="card">
            <h2>üíú You Matter</h2>
            <div id="support-message" style="padding: 12px; background: #f0f4ff; border-radius: 12px; text-align: center; font-size: 18pt; line-height: 1.6;">
            </div>
            <button class="btn" onclick="showNewMessage()">
                üíå Show Me Another
            </button>
        </div>
        <!-- Claude: Gentle journal prompts ‚Äî 2026-02-27 -->
        <div class="card">
            <h2>üìì A Gentle Moment</h2>
            <p style="font-size:14pt;color:#888;margin-bottom:14px;">No pressure. Just a thought to sit with, if you'd like.</p>
            <div id="journal-prompt" style="background:#f0f7f8;border-left:4px solid #6CA0A3;border-radius:0 10px 10px 0;padding:14px 16px;font-size:16pt;color:#444;line-height:1.6;margin-bottom:4px;"></div>
            <textarea id="journal-textarea" class="journal-textarea" rows="4" placeholder="Write here if you'd like‚Ä¶ or just sit with the thought üíö"></textarea>
            <div style="margin-top:10px;">
                <button onclick="journalNext()" style="background:#f0f7f8;color:#6CA0A3;border:1px solid #c5dfe1;border-radius:8px;padding:6px 14px;font-size:14pt;font-family:inherit;cursor:pointer;">üîÑ Different prompt</button>
            </div>
            <!-- Claude: auto-save status ‚Äî 2026-02-27 -->
            <div id="journal-saved" style="display:none;font-size:13pt;color:#aaa;text-align:right;margin-top:6px;font-style:italic;"></div>
            <p id="journal-signin-msg" style="display:none;font-size:13pt;color:#aaa;text-align:center;margin-top:8px;font-style:italic;">Sign in to save your response.</p>
        </div>
    </div>

    <!-- Firebase compat CDN ‚Äî silent background sync -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="/Academic-Allies/modular/aa-firebase.js"></script>
    <script src="/Academic-Allies/modular/js/aa-mirror.js"></script>

    <script>
        // Spoon Management
        let dailySpoons = 10;
        let remainingSpoons = 10;
        let tasks = [
            { text: 'Check in with myself', spoons: 1, completed: false }
        ];
        function updateSpoonCounter() {
            document.getElementById('spoons-remaining').textContent = remainingSpoons;
           
            if (remainingSpoons <= dailySpoons * 0.25 && remainingSpoons > 0) {
                alert('‚ö†Ô∏è Spoon Alert: You\'re running low on energy. Time to rest!');
            }
        }
        function completeTask(index, checked) {
            tasks[index].completed = checked;
            if (checked) {
                remainingSpoons -= tasks[index].spoons;
            } else {
                remainingSpoons += tasks[index].spoons;
            }
            // Claude: persist completed state so re-renders don't lose it ‚Äî 2026-02-27
            localStorage.setItem('spoonPlannerTasks', JSON.stringify(tasks));
            updateSpoonCounter();
            // Claude: toggle class directly ‚Äî avoids re-render race ‚Äî 2026-02-27
            var items = document.querySelectorAll('#todo-list .todo-item');
            if (items[index]) items[index].classList.toggle('todo-completed', checked);
        }
        function selectEnergy(level) {
            document.querySelectorAll('.energy-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`[data-level="${level}"]`).classList.add('selected');
           
            dailySpoons = level;
            remainingSpoons = level;
            updateSpoonCounter();
           
            localStorage.setItem('energyLevel', level);
            // Firebase sync (silent, non-blocking) ‚Äî skip in mirror mode (unless dorothy)
            if (window.AA && AA.auth && AA.auth.currentUser) {
                if (!window.AA_MIRROR_UID || AA.auth.currentUser.email === 'dorothy.brinck@gmail.com') {
                    AA.patchFlowerQuiz(AA.auth.currentUser.uid, { energyLevel: level });
                }
            }
        }
        function showSpoonPlanner() {
            /* Claude-credit: was a placeholder alert ‚Äî now navigates to actual page 2026-02-26 */
            window.location.href = '/Academic-Allies/modular/components/spoon-planner/spoon-planner.html';
        }
        // Flower Quiz ‚Äî shuffle-deck so every flower appears equally before repeating
        let flowers = [];
        let flowerDeck = [];   // current shuffled deck (depleted as flowers are shown)

        function shuffleDeck(arr) {
            // Fisher-Yates shuffle into a fresh deck
            var a = arr.slice();
            for (var i = a.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var tmp = a[i]; a[i] = a[j]; a[j] = tmp;
            }
            return a;
        }

        function nextFromDeck() {
            if (flowerDeck.length === 0) {
                // All flowers seen ‚Äî reshuffle entire set
                flowerDeck = shuffleDeck(flowers);
                console.log('[FlowerQuiz] Deck exhausted ‚Äî reshuffled ' + flowerDeck.length + ' flowers');
            }
            return flowerDeck.pop();
        }

        fetch("../icons/flowers/flowers.json")
          .then(r => r.json())
          .then(data => {
            flowers = data.flowers;
            flowerDeck = shuffleDeck(flowers);
            console.log("Loaded " + flowers.length + " flowers into shuffle deck");
            loadNewFlower();
          })
          .catch(err => console.error("Failed to load flowers:", err));
        let currentFlower = null;
        let flowerCount = parseInt(localStorage.getItem('flowerCount') || '0');
        document.getElementById('flower-count').textContent = flowerCount;
        // Comforting scriptures
        const comfortingScriptures = [
            { text: "Come unto me, all ye that labour and are heavy laden, and I will give you rest.", reference: "Matthew 11:28" },
            { text: "Peace I leave with you, my peace I give unto you: not as the world giveth, give I unto you. Let not your heart be troubled, neither let it be afraid.", reference: "John 14:27" },
            { text: "Cast thy burden upon the Lord, and he shall sustain thee.", reference: "Psalm 55:22" },
            { text: "The Lord is nigh unto them that are of a broken heart; and saveth such as be of a contrite spirit.", reference: "Psalm 34:18" },
            { text: "Fear thou not; for I am with thee: be not dismayed; for I am thy God: I will strengthen thee; yea, I will help thee.", reference: "Isaiah 41:10" }
        ];
        function showNewScripture() {
            const scripture = comfortingScriptures[Math.floor(Math.random() * comfortingScriptures.length)];
            document.getElementById('scripture-verse').innerHTML = `
                "${scripture.text}"
                <div style="margin-top: 15px; font-size: 16pt; font-style: normal; font-weight: 600;">
                    ‚Äî ${scripture.reference}
                </div>
            `;
        }
        // Support messages
        const supportMessages = [
            "You're doing better than you think. This moment doesn't define you.",
            "Rest is not weakness. Rest is medicine.",
            "Your body knows what it needs. Listen to it gently.",
            "One breath at a time. One moment at a time. You're here, and that's enough.",
            "You are loved exactly as you are, right now, in this moment.",
            "Small steps are still steps forward. Be proud of showing up.",
            "Heavenly Father knows your heart. He sees your efforts.",
            "You are a daughter of God. Your worth is infinite."
        ];
        // Mary's gastroparesis-safe meal options ‚Äî DO NOT CHANGE
        const maryMealOptions = {
            breakfast: [
                "Post Fruity Pebbles with Lactaid 2% milk",
                "Pop-Tarts (Frosted Cherry)",
                "Idahoan Buttery Mashed Potatoes (instant)",
                "King's Hawaiian Slider Buns (plain or with safe spread)",
                "Grandma Sycamore's White Bread (plain or toasted)"
            ],
            lunch: [
                "Jack's Cheese Personal Pizza",
                "Idahoan Buttery Mashed Potatoes",
                "Grandma Sycamore's White Bread sandwich (safe fillings)",
                "King's Hawaiian Slider Buns with cheese",
                "Snack Pack Chocolate Pudding"
            ],
            dinner: [
                "Jack's Cheese Personal Pizza",
                "Idahoan Buttery Mashed Potatoes",
                "Hostess Ding Dongs (easy comfort food)",
                "Snack Pack Chocolate Pudding",
                "Pop-Tarts (Frosted Cherry)"
            ],
            liquids: [
                "Great Value Lactose Free 2% Milk",
                "Naked Strawberry Banana Smoothie",
                "Gatorade Fruit Punch",
                "Lactaid 2% Reduced Fat Milk",
                "Great Value Distilled Water"
            ]
        };
        // Generic low-effort meal options for other students ‚Äî Added 2026-02-28 by Claude
        const genericMealOptions = {
            breakfast: [
                "Toast with peanut butter or jam",
                "Instant oatmeal (microwave, 2 min)",
                "Cereal with milk or dairy-free milk",
                "Yogurt with granola",
                "Scrambled eggs (microwave 90 sec)"
            ],
            lunch: [
                "Grilled cheese sandwich",
                "Cup noodles or instant ramen",
                "Peanut butter & honey wrap",
                "Canned soup (heat & eat)",
                "Crackers with cheese or nut butter"
            ],
            dinner: [
                "Frozen meal or microwave entr√©e",
                "Pasta with jarred sauce (10 min)",
                "Rice with butter or soy sauce",
                "Quesadilla (tortilla + cheese, microwave)",
                "Canned soup with bread"
            ],
            liquids: [
                "Water or sparkling water",
                "Gatorade or Pedialyte",
                "Herbal tea (no prep needed)",
                "Apple juice or orange juice",
                "Broth (instant or carton)"
            ]
        };
        // Default to Mary's options; swapped to generic after auth if not Mary.
        // See onAuthStateChanged below. Added 2026-02-28 by Claude.
        let mealOptions = maryMealOptions;
        let reportedFlowers = JSON.parse(localStorage.getItem('reportedFlowers') || '[]');
        function viewReports() {
            if (reportedFlowers.length === 0) {
                alert("No flowers reported yet!");
                return;
            }
            const reportList = reportedFlowers.map(name => {
                const flower = flowers.find(f => f.name === name);
                return flower ? `‚Ä¢ ${flower.name} - Quiz ${flower.quiz}` : `‚Ä¢ ${name}`;
            }).join("\n");
            const message = `Reported Flowers (${reportedFlowers.length}):\n\n${reportList}\n\nCopy this list and send to Claude for corrections!`;
            alert(message);
        }
        function reportWrongCategory() {
            if (!reportedFlowers.includes(currentFlower.name)) {
                reportedFlowers.push(currentFlower.name);
                localStorage.setItem('reportedFlowers', JSON.stringify(reportedFlowers));
                document.getElementById('report-count').textContent = reportedFlowers.length;
                // Firebase sync (silent, non-blocking) ‚Äî skip in mirror mode (unless dorothy)
                if (window.AA && AA.auth && AA.auth.currentUser) {
                    if (!window.AA_MIRROR_UID || AA.auth.currentUser.email === 'dorothy.brinck@gmail.com') {
                        AA.patchFlowerQuiz(AA.auth.currentUser.uid, { reportedFlowers: reportedFlowers });
                    }
                }
                alert(`‚úÖ Reported: ${currentFlower.name} - Quiz ${currentFlower.quiz}\n\nTotal reports: ${reportedFlowers.length}`);
            } else {
                alert(`Already reported: ${currentFlower.name}`);
            }
        }
        function loadNewFlower() {
            if (!flowers || flowers.length === 0) return;
            
            // Clear previous result and button states
            document.getElementById('quiz-result').innerHTML = "<span style=\"opacity: 0.5;\">Select your answer...</span>";
            const allButtons = document.querySelectorAll('.quiz-btn');
            allButtons.forEach(btn => {
                btn.classList.remove('correct', 'incorrect');
                btn.disabled = false;
            });
            
            currentFlower = nextFromDeck();
            const correctAnswer = currentFlower.name;
            const allNames = flowers.map(f => f.name).filter(n => n !== currentFlower.name);
            const wrongAnswers = allNames.sort(() => Math.random() - 0.5).slice(0, 3);
            const options = [correctAnswer, ...wrongAnswers].sort(() => Math.random() - 0.5);
            const randomImage = currentFlower.images[Math.floor(Math.random() * currentFlower.images.length)];
            document.getElementById('flower-image').src = randomImage;
            const hintDiv = document.getElementById('flower-hint');
            if (currentFlower.description) {
                hintDiv.textContent = currentFlower.description;
                hintDiv.style.display = 'block';
            } else {
                hintDiv.style.display = 'none';
            }
            const optionsContainer = document.getElementById('quiz-options');
            optionsContainer.innerHTML = '';
           
            options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'quiz-btn';
                btn.textContent = option;
                btn.onclick = () => checkAnswer(option, btn, correctAnswer);
                optionsContainer.appendChild(btn);
            });
           
            document.getElementById('report-btn').style.display = 'block';
        }
        function checkAnswer(selected, button, correctAnswer) {
            const allButtons = document.querySelectorAll('.quiz-btn');
            allButtons.forEach(btn => btn.disabled = true);
           
            const correctMessages = [
                `‚ú® Perfect! That's ${currentFlower.name}! Your class skills are sharp! ‚ú®`,
                `üå∏ Yes! ${currentFlower.name} ‚Äî your arranging eye is spot on today! üå∏`,
                `üéâ Nailed it! That's ${currentFlower.name}. You're getting so good at this! üéâ`,
                `üíö Spot on! ${currentFlower.name} ‚Äî your flower knowledge is blooming beautifully! üíö`,
                `üåü Wonderful! That's exactly ${currentFlower.name}. Keep shining! üåü`
            ];
            const incorrectMessages = [
                `That's okay! It's ${currentFlower.name}. You're studying and that's what matters! üíú`,
                `Close one! It's ${currentFlower.name} ‚Äî you\'re learning fast and that's wonderful! üå∑`,
                `No worries at all! That's ${currentFlower.name}. Every try helps your skills grow! üòä`,
                `You're doing beautifully anyway! It's ${currentFlower.name} ‚Äî keep going at your own pace. üíö`,
                `All good! That's ${currentFlower.name}. Your effort is what shines through every time. ‚ú®`
            ];
           
            if (selected === correctAnswer) {
                button.classList.add('correct');
                flowerCount++;
                localStorage.setItem('flowerCount', flowerCount);
                document.getElementById('flower-count').textContent = flowerCount;
                // Firebase sync ‚Äî debounced so rapid answers don't hammer the DB
                // Skip write in mirror mode (unless dorothy)
                clearTimeout(window._fcTimer);
                window._fcTimer = setTimeout(function() {
                    if (window.AA && AA.auth && AA.auth.currentUser) {
                        if (!window.AA_MIRROR_UID || AA.auth.currentUser.email === 'dorothy.brinck@gmail.com') {
                            AA.patchFlowerQuiz(AA.auth.currentUser.uid, { flowerCount: flowerCount });
                        }
                    }
                }, 3000);
                document.getElementById('quiz-progress').style.width = Math.min(flowerCount * 5, 100) + '%';
               
                const result = document.getElementById('quiz-result');
                result.textContent = correctMessages[Math.floor(Math.random() * correctMessages.length)];
                // Message stays visible
            } else {
                button.classList.add('incorrect');
                const correctBtn = Array.from(allButtons).find(btn => btn.textContent === correctAnswer);
                if (correctBtn) correctBtn.classList.add('correct');
                const result = document.getElementById('quiz-result');
                result.textContent = incorrectMessages[Math.floor(Math.random() * incorrectMessages.length)];
                // Message stays visible
            }
            
            // Don't clear the result - it stays visible until Next Flower is clicked
            // Re-enable buttons after a short delay so user can click Next Flower
            setTimeout(() => {
                allButtons.forEach(btn => {
                    btn.disabled = false;
                });
            }, 1000);
        }
        function generateNewMeals() {
            const suggestions = document.getElementById('meal-suggestions');
            const breakfast = mealOptions.breakfast[Math.floor(Math.random() * mealOptions.breakfast.length)];
            const lunch = mealOptions.lunch[Math.floor(Math.random() * mealOptions.lunch.length)];
            const dinner = mealOptions.dinner[Math.floor(Math.random() * mealOptions.dinner.length)];
            const liquid = mealOptions.liquids[Math.floor(Math.random() * mealOptions.liquids.length)];
           
            suggestions.innerHTML = `
                <div class="meal-suggestion">
                    <strong>10:30am - Breakfast</strong>
                    ${breakfast}
                </div>
                <div class="meal-suggestion">
                    <strong>1:30pm - Lunch</strong>
                    ${lunch}
                </div>
                <div class="meal-suggestion">
                    <strong>4:30pm - Dinner</strong>
                    ${dinner}
                </div>
                <div class="meal-suggestion">
                    <strong>After 5pm - Liquids Only</strong>
                    ${liquid}
                </div>
            `;
        }
        function markActivity(activity) {
            const achievements = document.getElementById('activity-achievements');
            achievements.classList.remove('hidden');
           
            const icons = {
                drink: 'üíß',
                stretch: 'üßò',
                sunlight: '‚òÄÔ∏è',
                music: 'üéµ'
            };
           
            const messages = {
                drink: "Wonderful! You're taking care of yourself!",
                stretch: "Great job! Your body thanks you!",
                sunlight: "Beautiful! Vitamin D is so important!",
                music: "Perfect! Music heals the soul!"
            };
           
            achievements.innerHTML = `
                <div class="achievement">
                    ${icons[activity]} ${messages[activity]}
                </div>
            `;
           
            remainingSpoons = Math.min(remainingSpoons + 1, dailySpoons);
            updateSpoonCounter();
           
            setTimeout(() => achievements.classList.add('hidden'), 4000);
        }
        function showNewMessage() {
            const message = supportMessages[Math.floor(Math.random() * supportMessages.length)];
            document.getElementById('support-message').textContent = message;
        }
        // ‚îÄ‚îÄ Breathing circle controller ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function startBreathing() {
            var phaseEl  = document.getElementById('breathing-phase');
            var timerEl  = document.getElementById('breathing-timer');
            if (!phaseEl || !timerEl) return;

            // Respect prefers-reduced-motion: show text only, no countdown
            var reducedMotion = window.matchMedia &&
                window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            if (reducedMotion) {
                phaseEl.textContent = 'Breathe in‚Ä¶ then out. Take your time.';
                timerEl.textContent = '';
                return;
            }

            var INHALE = 4000;   // ms
            var EXHALE = 4000;   // ms
            var CYCLE  = INHALE + EXHALE;  // 8000ms
            var startTime = Date.now();

            function tick() {
                var elapsed  = (Date.now() - startTime) % CYCLE;
                var isInhale = elapsed < INHALE;
                var remaining;

                if (isInhale) {
                    phaseEl.textContent = 'Breathe in‚Ä¶';
                    remaining = Math.ceil((INHALE - elapsed) / 1000);
                } else {
                    phaseEl.textContent = 'Breathe out‚Ä¶';
                    remaining = Math.ceil((CYCLE - elapsed) / 1000);
                }
                timerEl.textContent = remaining > 0 ? remaining : '';
            }

            tick();
            setInterval(tick, 250);
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // loadNewFlower() is called by the fetch callback once flowers.json loads
            document.getElementById('report-count').textContent = reportedFlowers.length;
            showNewMessage();
            showNewScripture();
            startBreathing();
            var savedEnergy = localStorage.getItem('energyLevel');
            if (savedEnergy) {
                var el = document.querySelector('[data-level="' + savedEnergy + '"]');
                if (el) el.classList.add('selected');
            }

            // ‚îÄ‚îÄ Spoon plan: load from localStorage first, then Firebase ‚îÄ‚îÄ
            // Claude-credit: spoon plan Firebase sync added 2026-02-26
            loadSpoonPlan();

            // ‚îÄ‚îÄ Firebase background sync (non-blocking) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // Recovery mode works fully without sign-in (localStorage).
            // When signed in, Firebase loads the latest data and keeps
            // it in sync across the student's devices.
            if (window.AA && AA.auth) {
                AA.auth.onAuthStateChanged(function(user) {
                    if (!user) {
                        // Not signed in ‚Äî load from localStorage only
                        loadSpoonPlanFromStorage();
                        return;
                    }
                    // ‚îÄ‚îÄ Personalise greeting with signed-in user's name ‚îÄ‚îÄ
                    // Added 2026-02-28 by Claude ‚Äî replace hardcoded 'Mary' with real name
                    var firstName = (user.displayName || user.email || '').split(/[\s@]/)[0];
                    if (firstName) {
                        var nameEl = document.getElementById('rm-user-name');
                        if (nameEl) nameEl.textContent = firstName;
                        document.title = 'Recovery Mode \u2014 ' + firstName + '\u2019s Safe Space';
                    }
                    // ‚îÄ‚îÄ Swap meal options for non-Mary students ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    // Mary (mbrinck90) keeps her gastroparesis-specific brands.
                    // Everyone else gets the generic low-effort options.
                    // Added 2026-02-28 by Claude.
                    if (user.email !== 'mbrinck90@gmail.com') {
                        mealOptions = genericMealOptions;
                    }
                    /* Claude: use student UID in mirror mode ‚Äî 2026-02-28 */
                    var _readUid = window.AA_MIRROR_UID || user.uid;
                    var quizUid  = (window.AA_flower_uid && !window.AA_MIRROR_UID)
                        ? window.AA_flower_uid(user.uid, user.email) : _readUid;
                    AA.getFlowerQuiz(quizUid).then(function(doc) {
                        if (!doc.exists) return; // first time ‚Äî nothing to load yet
                        var data = doc.data();

                        // Load flowerCount from Firebase if it's higher than local
                        // (takes the max so progress is never lost)
                        if (typeof data.flowerCount === 'number' && data.flowerCount > flowerCount) {
                            flowerCount = data.flowerCount;
                            localStorage.setItem('flowerCount', flowerCount);
                            var countEl = document.getElementById('flower-count');
                            if (countEl) countEl.textContent = flowerCount;
                            var progressEl = document.getElementById('quiz-progress');
                            if (progressEl) progressEl.style.width = Math.min(flowerCount * 5, 100) + '%';
                        }

                        // Merge reportedFlowers (union of local + cloud)
                        if (Array.isArray(data.reportedFlowers) && data.reportedFlowers.length > 0) {
                            data.reportedFlowers.forEach(function(name) {
                                if (!reportedFlowers.includes(name)) reportedFlowers.push(name);
                            });
                            localStorage.setItem('reportedFlowers', JSON.stringify(reportedFlowers));
                            var reportCountEl = document.getElementById('report-count');
                            if (reportCountEl) reportCountEl.textContent = reportedFlowers.length;
                        }

                        // Restore energyLevel from Firebase if not already set locally
                        if (data.energyLevel && !localStorage.getItem('energyLevel')) {
                            var energyEls = document.querySelectorAll('.energy-option');
                            energyEls.forEach(function(opt) { opt.classList.remove('selected'); });
                            var energyEl = document.querySelector('[data-level="' + data.energyLevel + '"]');
                            if (energyEl) energyEl.classList.add('selected');
                        }
                    }).catch(function(err) {
                        console.warn('[AA] FlowerQuiz load error (non-critical):', err);
                    });
                });
            }
        });
    </script>
    <script>
        // ‚îÄ‚îÄ Spoon Plan loader ‚Äî Claude 2026-02-26 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Renders the todo-list from planTasks array.
        // Also updates the global `tasks` so completeTask() deducts the right spoon cost.
        // Falls back to a default "Check in with myself" task if no plan exists.
        // Claude-credit: renamed param planTasks (was tasks) to avoid shadowing global 2026-02-26
        function renderTodoList(planTasks) {
            var list = document.getElementById('todo-list');
            if (!list) return;
            if (!planTasks || planTasks.length === 0) {
                // Reset global tasks to default so completeTask() works correctly
                tasks = [{ name: 'Check in with myself', text: 'Check in with myself', spoons: 1, completed: false }];
                list.innerHTML =
                    '<div class="todo-item">' +
                        '<input type="checkbox" class="todo-checkbox" onchange="completeTask(0, this.checked)">' +
                        '<span class="todo-text">Check in with myself</span>' +
                        '<span class="todo-spoons">1ü•Ñ</span>' +
                    '</div>';
                return;
            }
            // Update global so completeTask() uses the real spoon costs
            tasks = planTasks.slice();
            list.innerHTML = planTasks.map(function(task, i) {
                return '<div class="todo-item' + (task.completed ? ' todo-completed' : '') + '">' +
                    '<input type="checkbox" class="todo-checkbox"' +
                        (task.completed ? ' checked' : '') +
                        ' onchange="completeTask(' + i + ', this.checked)">' +
                    '<span class="todo-text">' + (task.name || task.text || '') +
                        (task.time ? ' <span style="font-size:13pt;color:#999;">(' + task.time + ')</span>' : '') +
                    '</span>' +
                    '<span class="todo-spoons">' + (task.spoons || 1) + 'ü•Ñ</span>' +
                '</div>';
            }).join('');
        }

        function loadSpoonPlanFromStorage() {
            var saved = localStorage.getItem('spoonPlannerTasks');
            renderTodoList(saved ? JSON.parse(saved) : []);
        }

        function loadSpoonPlan() {
            // Show localStorage immediately (fast)
            loadSpoonPlanFromStorage();

            if (window.AA && AA.auth) {
                AA.auth.onAuthStateChanged(function(user) {
                    if (!user) return;
                    // Claude: one-time load ‚Äî no live sync to avoid fighting reset ‚Äî 2026-02-27
                    // Claude: use student UID in mirror mode ‚Äî 2026-02-28
                    AA.getSpoonPlan(window.AA_MIRROR_UID || user.uid).then(function(data) {
                        if (data && data.tasks && data.tasks.length > 0) {
                            renderTodoList(data.tasks);
                            localStorage.setItem('spoonPlannerTasks', JSON.stringify(data.tasks));
                        }
                    }).catch(function(err) {
                        console.warn('[AA] Could not load spoon plan:', err);
                    });
                });
            }
        }
        // ‚îÄ‚îÄ End Spoon Plan loader ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    </script>
    <script>
        // ‚îÄ‚îÄ Genus Practice Quiz ‚Äî 2026-02-25 by Claude ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        var GQ_FLOWERS = [
            // Quiz 1‚Äì3
            { image: "../icons/flowers/flower1-1Carnation.png",              genus: "Dianthus",        common: "Carnation" },
            { image: "../icons/flowers/flower2-1 Daisy Pom.png",             genus: "Chrysanthemum",   common: "Daisy Pom" },
            { image: "../icons/flowers/flower3-1 Rose.png",                  genus: "Rosa",             common: "Rose" },
            { image: "../icons/flowers/flower4-1 Alstro.png",                genus: "Alstroemeria",    common: "Alstro" },
            { image: "../icons/flowers/flower5-1 Lisianthus.png",            genus: "Eustoma",         common: "Lisianthus" },
            { image: "../icons/flowers/flower6-1 Hydrangea.png",             genus: "Hydrangea",       common: "Hydrangea" },
            { image: "../icons/flowers/flower7-1 Peony.png",                 genus: "Paeonia",         common: "Peony" },
            { image: "../icons/flowers/flower8-1 Ranunculus.png",            genus: "Ranunculus",      common: "Ranunculus" },
            { image: "../icons/flowers/flower9-1 Safari Sunset.png",         genus: "Leucadendron",    common: "Safari Sunset" },
            { image: "../icons/flowers/flower10-1 China Aster.png",          genus: "Callistephus",    common: "China Aster" },
            { image: "../icons/flowers/flower11-1 Snapdragon.png",           genus: "Antirrhinum",     common: "Snapdragon" },
            { image: "../icons/flowers/flower12-1 Larkspur.png",             genus: "Consolida",       common: "Larkspur" },
            { image: "../icons/flowers/flower13-1 Delphinium.png",           genus: "Delphinium",      common: "Delphinium" },
            { image: "../icons/flowers/flower14-1 Liatris.png",              genus: "Liatris",         common: "Liatris" },
            { image: "../icons/flowers/flower15-1 Gladiola.png",             genus: "Gladiolus",       common: "Gladiola" },
            { image: "../icons/flowers/flower16-1 Stock.png",                genus: "Matthiola",       common: "Stock" },
            { image: "../icons/flowers/flower17-1 Queen Anne‚Äôs Lace.png", genus: "Daucus",        common: "Queen Anne‚Äôs Lace" },
            { image: "../icons/flowers/flower18-1 Sea Holly.png",            genus: "Eryngium",        common: "Sea Holly" },
            { image: "../icons/flowers/flower19-1 Hypericum Berries.png",    genus: "Hypericum",       common: "Hypericum Berries" },
            { image: "../icons/flowers/flower20-1 Pixie Carnation.png",      genus: "Dianthus",        common: "Pixie Carnation" },
            { image: "../icons/flowers/flower21-1 Waxflower.png",            genus: "Chamelaucium",    common: "Waxflower" },
            { image: "../icons/flowers/flower22-1 Babies Breath.png",        genus: "Gypsophila",      common: "Babies Breath" },
            { image: "../icons/flowers/flower23-1 Statice.png",              genus: "Limonium",        common: "Statice" },
            { image: "../icons/flowers/flower24-1 Misty Blue.png",           genus: "Limonium",        common: "Misty Blue" },
            { image: "../icons/flowers/flower25-1 Solidago.png",             genus: "Solidago",        common: "Solidago" },
            { image: "../icons/flowers/flower26-1 Dendrobium Orchid.png",    genus: "Dendrobium",      common: "Dendrobium Orchid" },
            { image: "../icons/flowers/flower27-1 Curly Willow.png",         genus: "Salix",           common: "Curly Willow" },
            { image: "../icons/flowers/flower28-1 Baby Blue Eucalyptus.png", genus: "Eucalyptus",      common: "Baby Blue Eucalyptus" },
            { image: "../icons/flowers/flower29-1 Bells of Ireland.png",     genus: "Moluccella",      common: "Bells of Ireland" },
            { image: "../icons/flowers/flower30-1 Dianthus.jpg",             genus: "Dianthus",        common: "Dianthus" },
            // Quiz 4‚Äì5
            { image: "../icons/flowers/flower31-1 Iris.jpg",                 genus: "Iris",            common: "Iris" },
            { image: "../icons/flowers/flower32-1 Lily.jpg",                 genus: "Lilium",          common: "Lily" },
            { image: "../icons/flowers/flower33-1 Calla Lily.jpg",           genus: "Zantedeschia",    common: "Calla Lily" },
            { image: "../icons/flowers/flower34-1 Gerber Daisy.jpg",         genus: "Gerbera",         common: "Gerber Daisy" },
            { image: "../icons/flowers/flower35-1 Anthurium.jpg",            genus: "Anthurium",       common: "Anthurium" },
            { image: "../icons/flowers/flower36-1 Billy Balls.jpg",          genus: "Craspedia",       common: "Billy Balls" },
            { image: "../icons/flowers/flower37-1 Disbud Mum.jpg",           genus: "Chrysanthemum",   common: "Disbud Mum" },
            { image: "../icons/flowers/flower38-1 Bird of Paradise.jpg",     genus: "Strelitzia",      common: "Bird of Paradise" },
            { image: "../icons/flowers/flower39-1 Tulip.jpg",                genus: "Tulipa",          common: "Tulip" },
            { image: "../icons/flowers/flower40-1 Sunflower.jpg",            genus: "Helianthus",      common: "Sunflower" },
            { image: "../icons/flowers/flower41-1 Leather leaf.jpg",         genus: "Leucadendron",    common: "Leather Leaf" },
            { image: "../icons/flowers/flower42-1 Bear Grass.jpg",           genus: "Xerophyllum",     common: "Bear Grass" },
            { image: "../icons/flowers/flower43-1 Lilly Grass.jpg",          genus: "Liriope",         common: "Lilly Grass" },
            { image: "../icons/flowers/flower44-1 Israeli Ruscus.png",       genus: "Ruscus",          common: "Israeli Ruscus" },
            { image: "../icons/flowers/flower45-1 Salal.jpg",                genus: "Gaultheria",      common: "Salal" },
            { image: "../icons/flowers/flower46-1 Grevillea.jpg",            genus: "Grevillea",       common: "Grevillea" },
            { image: "../icons/flowers/flower47-1 Pitt.jpg",                 genus: "Pittosporum",     common: "Pitt" },
            { image: "../icons/flowers/flower48-1 Myrtle.jpg",               genus: "Myrtus",          common: "Myrtle" },
            { image: "../icons/flowers/flower49-1 Italian Ruscus.jpg",       genus: "Ruscus",          common: "Italian Ruscus" },
        ]
        var gqMode = 'genus', gqPool = [], gqIndex = 0, gqScore = 0, GQ_ROUNDS = 10;

        function gqSetMode(mode) {
            gqMode = mode;
            var bg = document.getElementById('gqModeGenus');
            var bc = document.getElementById('gqModeCommon');
            bg.style.background = mode === 'genus' ? '#6CA0A3' : '#f0f4f5';
            bg.style.color      = mode === 'genus' ? '#fff'     : '#555';
            bg.style.border     = mode === 'genus' ? '2px solid #6CA0A3' : '2px solid #ddd';
            bc.style.background = mode === 'common' ? '#6CA0A3' : '#f0f4f5';
            bc.style.color      = mode === 'common' ? '#fff'     : '#555';
            bc.style.border     = mode === 'common' ? '2px solid #6CA0A3' : '2px solid #ddd';
            gqStart();
        }

        function gqShuffle(arr) {
            var a = arr.slice();
            for (var i = a.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var t = a[i]; a[i] = a[j]; a[j] = t;
            }
            return a;
        }

        function gqStart() {
            gqPool  = gqShuffle(GQ_FLOWERS).slice(0, GQ_ROUNDS);
            gqIndex = 0; gqScore = 0;
            document.getElementById('genusScore').style.display   = 'none';
            document.getElementById('genusRestart').style.display = 'none';
            gqShowQuestion();
        }

        function gqShowQuestion() {
            var container = document.getElementById('genusQuiz');
            if (gqIndex >= gqPool.length) { gqShowScore(); return; }
            var flower    = gqPool[gqIndex];
            var isGenus   = (gqMode === 'genus');
            var prompt    = isGenus ? flower.common : flower.genus;
            var correct   = isGenus ? flower.genus  : flower.common;
            var promptLbl = isGenus ? 'Common Name' : 'Genus';
            var answerLbl = isGenus ? 'Genus'       : 'Common Name';
            var others = gqShuffle(GQ_FLOWERS.filter(function(f) {
                return (isGenus ? f.genus : f.common) !== correct;
            })).slice(0, 3);
            var options = gqShuffle([correct].concat(others.map(function(f) {
                return isGenus ? f.genus : f.common;
            })));
            var correctIdx = options.indexOf(correct);
            var imgSrc = flower.image;
            var html = '<div style="text-align:center;">';
            html += '<p style="font-size:13pt;color:#888;margin:0 0 8px;">Question ' + (gqIndex + 1) + ' of ' + gqPool.length + '</p>';
            html += '<img src="' + imgSrc + '" '
                 +  'style="width:240px;height:240px;object-fit:contain;border-radius:14px;box-shadow:0 3px 12px rgba(0,0,0,0.12);margin-bottom:14px;" '
                 +  'alt="' + flower.common + '">';
            html += '<p style="font-size:16pt;margin:0 0 6px;"><strong>' + promptLbl + ':</strong> ' + prompt + '</p>';
            html += '<p style="font-size:13pt;color:#888;margin:0 0 12px;">‚Üì Pick the ' + answerLbl + '</p>';
            html += '<div class="quiz-buttons">';
            options.forEach(function(opt, i) {
                html += '<button class="quiz-btn" onclick="gqAnswer(' + i + ',' + correctIdx + ')" '
                     +  'style="font-size:14pt;padding:12px;min-height:19mm;">' + opt + '</button>';
            });
            html += '</div></div>';
            container.innerHTML = html;
        }

        function gqAnswer(selected, correct) {
            var btns = document.querySelectorAll('#genusQuiz .quiz-btn');
            btns.forEach(function(b, i) {
                b.disabled = true;
                if (i === correct) b.classList.add('correct');
                else if (i === selected) b.classList.add('incorrect');
            });
            if (selected === correct) gqScore++;
            setTimeout(function() { gqIndex++; gqShowQuestion(); }, 1400);
        }

        function gqShowScore() {
            document.getElementById('genusQuiz').innerHTML = '';
            var pct = Math.round((gqScore / gqPool.length) * 100);
            var msg = pct === 100 ? 'üèÜ Perfect! You know your genus!' :
                      pct >= 70  ? 'üå∏ Nice work ‚Äî keep practicing!' :
                                   'üå± Keep going ‚Äî you\'re learning!';
            document.getElementById('genusScore').innerHTML =
                gqScore + ' / ' + gqPool.length + ' correct &nbsp;¬∑&nbsp; ' + pct + '%<br>' +
                '<span style="font-size:16pt;">' + msg + '</span>';
            document.getElementById('genusScore').style.display   = 'block';
            document.getElementById('genusRestart').style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', function() { gqStart(); });
        if (document.readyState !== 'loading') { gqStart(); }
    </script>

    <script>
        // ‚îÄ‚îÄ Session tracking & new-day reset ‚Äî Claude 2026-02-27 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        var TZ_OPTIONS = [
            'America/New_York', 'America/Chicago', 'America/Denver',
            'America/Los_Angeles', 'America/Phoenix', 'America/Anchorage',
            'Pacific/Honolulu', 'Europe/London', 'Europe/Paris',
            'Asia/Tokyo', 'Australia/Sydney'
        ];

        function getStoredTZ() {
            return localStorage.getItem('recoveryTZ') || Intl.DateTimeFormat().resolvedOptions().timeZone;
        }

        function formatSessionStart(isoStr, tz) {
            return new Date(isoStr).toLocaleString('en-US', {
                timeZone: tz,
                weekday: 'short', month: 'short', day: 'numeric',
                hour: 'numeric', minute: '2-digit', hour12: true,
                timeZoneName: 'short'
            });
        }

        function populateTZSelect(selectedTZ) {
            var sel = document.getElementById('tz-select');
            var opts = TZ_OPTIONS.slice();
            if (!opts.includes(selectedTZ)) opts.unshift(selectedTZ);
            sel.innerHTML = opts.map(function(tz) {
                return '<option value="' + tz + '"' + (tz === selectedTZ ? ' selected' : '') + '>' +
                    tz.replace(/_/g, ' ') + '</option>';
            }).join('');
        }

        function updateSessionDisplay(isoStr, tz) {
            document.getElementById('session-start-display').textContent = formatSessionStart(isoStr, tz);
        }

        function toggleTZPicker() {
            var row = document.getElementById('tz-picker-row');
            row.style.display = row.style.display === 'block' ? 'none' : 'block';
        }

        function saveTZ(tz) {
            localStorage.setItem('recoveryTZ', tz);
            var stored = localStorage.getItem('recoverySessionStart');
            updateSessionDisplay(stored, tz);
        }

        function resetSession() {
            // Archive completed tasks to Firebase before clearing
            var saved = localStorage.getItem('spoonPlannerTasks');
            var allTasks = saved ? JSON.parse(saved) : [];
            var completed = allTasks.filter(function(t) { return t.completed; });

            function _doReset() {
                // Claude: clear plan entirely for new day ‚Äî 2026-02-27
                ['spoonPlannerTasks', 'energyLevel', 'flowerCount', 'reportedFlowers', 'recoverySessionStart'].forEach(function(k) {
                    localStorage.removeItem(k);
                });
                location.reload();
            }

            if (window.AA && AA.auth && AA.auth.currentUser) {
                // Claude: always clear Firebase tasks on new day ‚Äî 2026-02-27
                var patch = { tasks: [] };
                if (completed.length > 0) {
                    patch.yesterdayTasks = completed;
                    patch.yesterdayDate  = new Date().toISOString().split('T')[0];
                }
                AA.saveSpoonPlan(AA.auth.currentUser.uid, patch)
                    .catch(function(err) {
                        console.warn('[AA] Could not reset spoon plan:', err);
                    })
                    .then(_doReset);
            } else {
                _doReset();
            }
        }

        function initSession() {
            var tz = getStoredTZ();
            var stored = localStorage.getItem('recoverySessionStart');
            if (!stored) {
                stored = new Date().toISOString();
                localStorage.setItem('recoverySessionStart', stored);
            }
            updateSessionDisplay(stored, tz);
            populateTZSelect(tz);
        }

        document.addEventListener('DOMContentLoaded', initSession);
    </script>

    <script>
        /* Claude: Gentle journal prompts ‚Äî 2026-02-27 */
        var JOURNAL_PROMPTS = [
            "What's one small thing that felt okay today, even if tiny?",
            "What does your body need most right now?",
            "What would feel like enough for today?",
            "Is there anything you're proud of yourself for, however small?",
            "What would you tell a dear friend who was having a day like this?",
            "What's one thing that helped you get through today?",
            "What are you looking forward to, even something very small?",
            "What's something gentle you could do for yourself in the next hour?",
            "What feelings are present for you right now? No need to fix them.",
            "What does rest look like for you today?",
            "Is there something you need to let yourself off the hook for today?",
            "What's one kind thought you could offer yourself right now?"
        ];

        var _jIdx = Math.floor(Math.random() * JOURNAL_PROMPTS.length);

        function journalShowPrompt() {
            var el = document.getElementById('journal-prompt');
            if (el) el.textContent = JOURNAL_PROMPTS[_jIdx];
        }

        function journalNext() {
            _jIdx = (_jIdx + 1) % JOURNAL_PROMPTS.length;
            journalShowPrompt();
            document.getElementById('journal-saved').style.display = 'none';
        }

        /* Claude: auto-save with 2s debounce ‚Äî 2026-02-27 */
        var _journalSaveTimer = null;
        var _journalSessionId = Date.now().toString(36) + Math.random().toString(36).slice(2);

        function _journalAutoSave() {
            if (!window.AA || !AA.auth || !AA.auth.currentUser || !AA.db) return;
            var text = (document.getElementById('journal-textarea').value || '').trim();
            if (!text) return;
            var statusEl = document.getElementById('journal-saved');
            if (statusEl) { statusEl.textContent = 'Saving‚Ä¶'; statusEl.style.display = 'block'; }
            var entry = {
                uid: AA.auth.currentUser.uid,
                prompt: JOURNAL_PROMPTS[_jIdx],
                response: text,
                savedAt: new Date().toISOString()
            };
            AA.db.collection('recoveryJournal').doc(_journalSessionId).set(entry)
                .then(function() {
                    if (statusEl) {
                        statusEl.textContent = '‚úì Saved';
                        setTimeout(function() { statusEl.style.display = 'none'; }, 3000);
                    }
                })
                .catch(function(err) {
                    console.warn('[AA] journal auto-save:', err);
                    if (statusEl) statusEl.style.display = 'none';
                });
        }

        /* Claude: show sign-in message when signed out ‚Äî 2026-02-27 */
        function _journalUpdateAuth(user) {
            var msg = document.getElementById('journal-signin-msg');
            if (msg) msg.style.display = user ? 'none' : 'block';
            if (!user) {
                var statusEl = document.getElementById('journal-saved');
                if (statusEl) statusEl.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            journalShowPrompt();
            var ta = document.getElementById('journal-textarea');
            if (ta) {
                ta.addEventListener('input', function() {
                    clearTimeout(_journalSaveTimer);
                    _journalSaveTimer = setTimeout(_journalAutoSave, 2000);
                });
            }
            if (window.AA && AA.auth) {
                AA.auth.onAuthStateChanged(_journalUpdateAuth);
            } else {
                _journalUpdateAuth(null);
            }
        });
        if (document.readyState !== 'loading') { journalShowPrompt(); }
    </script>
</body>
</html>
