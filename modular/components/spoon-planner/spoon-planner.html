<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SpoonPal Mini App</title>
<style>
  body { font-family: Arial, sans-serif; margin: 16px; background: #f7f9fc; color: #222; }
  .container { max-width: 960px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 1em 2em 2em 2em; }
  h1 { text-align: center; margin-bottom: 0.5em; }
  #timestamp { font-weight: bold; font-size: 1.1em; text-align: center; margin-bottom: 1em; }
  .spoon-section, .checkin-section, .weather-section, #legend, #debtWarning { border-radius: 6px; padding: 12px 15px; margin-bottom: 20px; }
  .spoon-section { background: #e1f3ff; }
  .checkin-section { background: #f0f8ff; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
  .checkin-section label { display: flex; flex-direction: column; font-weight: 600; font-size: 0.9rem; }
  .checkin-section input, .checkin-section select { margin-top: 4px; padding: 6px 8px; font-size: 1rem; border-radius: 4px; border: 1px solid #ccc; }
  .weather-section { background: #d7efc9; font-size: 0.95rem; display: flex; align-items: center; justify-content: space-between; }
  #debtWarning { background: linear-gradient(45deg, #ff726d, #e84a20); color: white; font-weight: 700; font-size: 1.1em; border-radius: 8px; padding: 14px 20px; text-align: center; display: none; animation: pulse 2.5s infinite; }
  @keyframes pulse { 0%,100% {opacity: 1;} 50% {opacity: 0.7;} }
  table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
  th, td { border: 1px solid #ccc; padding: 8px 10px; text-align: left; }
  th { background: #eee; position: sticky; top: 0; z-index: 2; }
  td.editable:hover { background-color: #f0f8ff; cursor: pointer; }
  tr.completed { background-color: #d7f0d7; opacity: 0.8; }
  tr.overdue { background-color: #ffd6d6; }
  #legend { font-family: monospace; background: #fff4cc; padding: 12px 16px; border-radius: 6px; margin-bottom: 15px; white-space: nowrap; overflow-x: auto; font-size: 0.9rem; }
  button { cursor: pointer; padding: 8px 16px; font-size: 1rem; border: none; border-radius: 5px; background: #1a73e8; color: white; transition: background 0.2s ease-in-out; }
  button:disabled { background: #9bc0f5; cursor: not-allowed; }
  button:hover:not(:disabled) { background: #155ab6; }
  #addTaskBtn { margin-top: 10px; }
  /* Modal styles */
  .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); overflow-y: auto; }
  .modal-content { background-color: #fff; max-width: 520px; margin: 60px auto; padding: 20px 26px 26px 26px; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.3); }
  .modal-content h2 { margin-top: 0; margin-bottom: 1em; }
  .modal-content label { display: block; margin: 10px 0 4px 0; font-weight: 600; }
  .modal-content input[type="text"], .modal-content input[type="number"], .modal-content select, .modal-content textarea { width: 100%; box-sizing: border-box; padding: 7px 8px; margin-top: 4px; font-size: 1rem; border-radius: 4px; border: 1px solid #ddd; }
  .modal-content button { margin-top: 14px; width: 48%; padding: 10px 20px; }
  .modal-close { float: right; font-size: 25px; font-weight: 700; color: #777; cursor: pointer; }
  .modal-close:hover { color: #000; }
  body.modal-open { overflow: hidden; }
</style>
</head>
<body>
<div class="container" role="main" aria-label="SpoonPal Mini App for chronic pain and spoon management">
  <h1>SpoonPal Mini App</h1>
  <div id="timestamp" aria-live="polite" aria-atomic="true"></div>
  <div id="debtWarning" role="alert" aria-live="assertive"></div>
  <div id="legend" aria-label="Protocol Legend"></div>

  <section class="spoon-section" aria-label="Spoon management summary">
    <div><strong>Baseline:</strong> <span id="baselineSpoons">--</span> &nbsp;|&nbsp; <strong>Borrowed:</strong> <span id="borrowedSpoons">--</span> &nbsp;|&nbsp; <strong>Start:</strong> <span id="startSpoons">--</span></div>
    <div><strong>Planned:</strong> <span id="plannedSpoons">--</span> &nbsp;|&nbsp; <strong>Spent:</strong> <span id="spentSpoons">--</span> &nbsp;|&nbsp; <strong>Remaining:</strong> <span id="remainingSpoons">--</span></div>
    <div><strong>Depletion:</strong> <span id="depletionSpoons">--</span> &nbsp;|&nbsp; <strong>Consecutive Debt Days:</strong> <span id="consecutiveDebt">0</span></div>
  </section>

  <section class="checkin-section" aria-label="Daily check-in">
    <label for="painLevel">Pain Level (1-10)
      <input type="number" id="painLevel" min="1" max="10" value="5" />
    </label>
    <label for="fatigueLevel">Fatigue Level (1-10)
      <input type="number" id="fatigueLevel" min="1" max="10" value="5" />
    </label>
    <label for="sleepHours">Sleep Hours (0-24)
      <input type="number" id="sleepHours" min="0" max="24" step="0.25" value="8" />
    </label>
    <label for="moodLevel">Mood
      <select id="moodLevel" aria-label="Select your current mood">
        <option value="excellent">Excellent</option>
        <option value="good">Good</option>
        <option value="okay" selected>Okay</option>
        <option value="poor">Poor</option>
        <option value="terrible">Terrible</option>
      </select>
    </label>
  </section>

  <section class="weather-section" aria-label="Weather information and controls">
    <span id="weatherInfo" aria-live="polite">Loading weather...</span>
    <button id="refreshWeatherBtn" type="button" aria-label="Refresh weather data">Refresh</button>
  </section>

  <table aria-label="Task timeline" role="grid" id="timelineTable">
    <thead>
      <tr>
        <th scope="col">Time</th>
        <th scope="col">LMJ</th>
        <th scope="col">Task Description (Priority)</th>
        <th scope="col" title="Spoon Cost">ü•Ñ</th>
        <th scope="col">Status</th>
        <th scope="col">Area Notes</th>
        <th scope="col">Actions</th>
      </tr>
    </thead>
    <tbody id="timelineBody" role="rowgroup"></tbody>
  </table>

  <button id="addTaskBtn" type="button">Add New Task</button>

  <!-- Modal -->
  <div id="taskModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalDesc">
    <div class="modal-content">
      <button type="button" class="modal-close" aria-label="Close modal" id="closeModalBtn">&times;</button>
      <h2 id="modalTitle">Edit Task</h2>
      <form id="taskForm">
        <label for="modalTime">Time (e.g., 9:00 AM or 9am)</label>
        <input type="text" id="modalTime" name="modalTime" placeholder="9:00 AM" required autocomplete="off" />
        <label for="modalLmj">LMJ (auto-assigned)</label>
        <input type="text" id="modalLmj" name="modalLmj" readonly aria-readonly="true" />
        <label for="modalEmoji">Emoji (auto-assigned)</label>
        <input type="text" id="modalEmoji" name="modalEmoji" readonly aria-readonly="true" />
        <label for="modalDescription">Task Description</label>
        <input type="text" id="modalDescription" name="modalDescription" placeholder="Task description" required />
        <label for="modalPriority">Priority</label>
        <select id="modalPriority" name="modalPriority" required>
          <option value="Urgent">Urgent</option>
          <option value="High" selected>High</option>
          <option value="Medium">Medium</option>
          <option value="Low">Low</option>
        </select>
        <label for="modalSpoonCost">Spoon Cost</label>
        <input type="number" id="modalSpoonCost" name="modalSpoonCost" min="0" max="10" step="0.5" required />
        <label for="modalFixed">Fixed or Flexible</label>
        <select id="modalFixed" name="modalFixed" required>
          <option value="true">Fixed üîí</option>
          <option value="false" selected>Flexible ‚ÜïÔ∏è</option>
        </select>
        <label for="modalNotes">Area Notes</label>
        <textarea id="modalNotes" name="modalNotes" rows="3" placeholder="Additional notes"></textarea>
        <div style="margin-top:1em; display:flex; justify-content: space-between;">
          <button type="submit" id="saveTaskBtn">Save Task</button>
          <button type="button" id="deleteTaskBtn" style="background:#dc3545; color:#fff;">Delete Task</button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
(() => {
  'use strict';

  // LOCKED PROTOCOL ELEMENTS
  const LOCKED_LMJ = [
    { lmj: 'A', emoji: 'üíä', desc: 'Morning meds' },
    { lmj: 'V', emoji: 'ü¶æ', desc: 'CPAP prep, wrist brace' },
    { lmj: 'B', emoji: 'üçΩÔ∏è', desc: 'Family scriptures, breakfast (AM only)' },
    { lmj: 'G', emoji: 'üê•', desc: 'Gosling time' },
    { lmj: 'N', emoji: 'üì∞', desc: 'News with Mom' },
    { lmj: 'ME', emoji: 'üßò', desc: 'Me time' },
    { lmj: 'H', emoji: 'üß∫', desc: 'Hamper/laundry' },
    { lmj: 'CC', emoji: 'üõèÔ∏è', desc: 'In bed' },
    { lmj: 'DD', emoji: 'üí®', desc: 'Breathe, recover' },
    { lmj: 'EE', emoji: 'üò∑', desc: 'CPAP mask on' },
    { lmj: 'FF', emoji: 'ü§ö', desc: 'Wrist brace on' },
    { lmj: 'ZZ', emoji: 'üìµ', desc: 'Device off, crash' }
  ];

  const STATUS_KEYS = ['incomplete', 'partial', 'progress', 'complete', 'interrupted', 'skipped', 'rescheduled'];
  const STATUS_ICONS = ['‚¨ú', '‚è≥', 'üõ†Ô∏è', '‚úÖ', 'üöß', '‚ùå', 'üîÑ'];

  const LMJ_LETTERS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  const DOUBLE_LETTERS = [];
  for (let i = 0; i < LMJ_LETTERS.length; i++) {
    for (let j = 0; j < LMJ_LETTERS.length; j++) {
      DOUBLE_LETTERS.push(LMJ_LETTERS[i] + LMJ_LETTERS[j]);
    }
  }

  let timelineData = [];
  let checkInData = { pain: 5, fatigue: 5, sleepHours: 8, mood: 'okay' };
  let spoonHistory = [];
  let dayStartHour = 8;
  let dayEndHour = 25;
  let weatherData = { impact: 0, description: 'No weather data' };
  let consecutiveDebtDays = 0;
  let selectedTaskIndex = null;

  function pad(num) {
    return num.toString().padStart(2, '0');
  }

  function parseTime12(time12) {
    const m = time12.match(/(\d{1,2}):?(\d{2})?\s*(AM|PM)/i);
    if (!m) return null;
    let h = parseInt(m[1]), mins = parseInt(m[2] || '0');
    if (m[3].toUpperCase() === 'PM' && h !== 12) h += 12;
    if (m[3].toUpperCase() === 'AM' && h === 12) h = 0;
    return { h, mins };
  }

  function formatTime12(h, m) {
    const ampm = h >= 12 ? 'PM' : 'AM';
    h = h % 12 || 12;
    return `${h}:${pad(m)} ${ampm}`;
  }

  function timeToMinutes(time) {
    if (typeof time === 'string') {
      const o = parseTime12(time);
      if (!o) return -1;
      return o.h * 60 + o.mins;
    }
    if (typeof time === 'object' && 'h' in time && 'mins' in time) {
      return time.h * 60 + time.mins;
    }
    return -1;
  }
  function minutesToTime12(minutes) {
    let h = Math.floor(minutes / 60);
    const m = minutes % 60;
    return formatTime12(h, m);
  }
  function getCurrentTime12() {
    let now = new Date();
    return formatTime12(now.getHours(), now.getMinutes());
  }

  function uniqueLMJ() {
    const used = new Set(timelineData.map(t => t.lmj));
    for (let i = 0; i < LMJ_LETTERS.length; i++) {
      let candidate = LMJ_LETTERS[i];
      if (!used.has(candidate)) return candidate;
    }
    for (let i = 0; i < DOUBLE_LETTERS.length; i++) {
      let candidate = DOUBLE_LETTERS[i];
      if (!used.has(candidate)) return candidate;
    }
    for (let i = 0; i < LMJ_LETTERS.length; i++) {
      for (let j = 0; j < LMJ_LETTERS.length; j++) {
        for (let k = 0; k < LMJ_LETTERS.length; k++) {
          let candidate = LMJ_LETTERS[i] + LMJ_LETTERS[j] + LMJ_LETTERS[k];
          if (!used.has(candidate)) return candidate;
        }
      }
    }
    return 'XX';
  }

  function assignEmojiForLMJ(lmj) {
    let found = LOCKED_LMJ.find(e => e.lmj === lmj);
    if (found) return found.emoji;
    return 'üß©';
  }

  function calculateConsecutiveDebtDays() {
    let count = 0;
    for (let i = spoonHistory.length - 1; i >= 0; i--) {
      if (spoonHistory[i].endBalance < 0) count++;
      else break;
    }
    consecutiveDebtDays = count;
    document.getElementById('consecutiveDebt').textContent = consecutiveDebtDays;
    if (consecutiveDebtDays >= 2) {
      let warningText = '';
      if (consecutiveDebtDays >= 5) warningText = `üÜò CRITICAL DEBT PERIOD üÜò Day ${consecutiveDebtDays}`;
      else if (consecutiveDebtDays === 3) warningText = `‚ö†Ô∏è BURNOUT RISK ZONE ‚ö†Ô∏è Day 3`;
      else warningText = `üö® SPOON DEBT WARNING üö® Day ${consecutiveDebtDays}`;
      showDebtWarning(warningText);
    } else {
      hideDebtWarning();
    }
  }
  function showDebtWarning(text) {
    const el = document.getElementById('debtWarning');
    el.textContent = text;
    el.style.display = 'block';
  }
  function hideDebtWarning() {
    const el = document.getElementById('debtWarning');
    el.style.display = 'none';
  }

  function calculateSpoons() {
    let baseline = 20;
    baseline -= Math.max(0, checkInData.pain - 5);
    baseline -= Math.max(0, checkInData.fatigue - 5);
    if (checkInData.sleepHours < 7) baseline -= (7 - checkInData.sleepHours) * 2;
    else if (checkInData.sleepHours > 9) baseline += Math.min(3, checkInData.sleepHours - 9);
    const moodAdj = { 'terrible': -3, 'poor': -1, 'okay': 0, 'good': 1, 'excellent': 2 };
    baseline += moodAdj[checkInData.mood] || 0;
    baseline += weatherData.impact || 0;
    baseline = Math.max(1, baseline);

    let borrowed = 0;

    let planned = timelineData.reduce((sum, t) => sum + (t.spoonCost || 0), 0);
    let spent = timelineData.reduce((sum, t) => {
      if (t.status === 'complete') return sum + (t.spoonCost || 0);
      if (t.status === 'partial') return sum + ((t.spoonCost || 0) / 2);
      return sum;
    }, 0);
    let start = baseline - borrowed;
    let remaining = start - spent;
    let depletion = remaining - (planned - spent);

    document.getElementById('baselineSpoons').textContent = baseline;
    document.getElementById('borrowedSpoons').textContent = borrowed;
    document.getElementById('startSpoons').textContent = start;
    document.getElementById('plannedSpoons').textContent = planned.toFixed(1);
    document.getElementById('spentSpoons').textContent = spent.toFixed(1);
    document.getElementById('remainingSpoons').textContent = remaining.toFixed(1);
    document.getElementById('depletionSpoons').textContent = depletion.toFixed(1);

    let today = new Date().toDateString();
    spoonHistory = spoonHistory.filter(s => s.date !== today);
    spoonHistory.push({
      date: today,
      baseline: baseline,
      spent: spent,
      endBalance: depletion,
      timestamp: new Date().toISOString()
    });
    calculateConsecutiveDebtDays();
  }

  function renderLegend() {
    let legendText = "Fixed üîí Flexible ‚ÜïÔ∏è Urgent üî• AM ‚òÄÔ∏è PM üåô ü•Ñ Spoon LMJ üéØ Status ";
    legendText += Object.values(STATUS_ICONS).join(' ') + "\nLMJ:";
    LOCKED_LMJ.forEach(t => {
      legendText += ` ${t.lmj}${t.emoji}`;
    });
    document.getElementById('legend').textContent = legendText;
  }

  function renderTimeline() {
    const tbody = document.getElementById('timelineBody');
    tbody.innerHTML = '';
    timelineData.sort((a, b) => {
      let aMin = timeToMinutes(a.time);
      let bMin = timeToMinutes(b.time);
      if (aMin < dayStartHour * 60) aMin += 1440;
      if (bMin < dayStartHour * 60) bMin += 1440;
      return aMin - bMin;
    });
    let meIndex = timelineData.findIndex(t => t.lmj === 'ME');
    let hIndex = timelineData.findIndex(t => t.lmj === 'H');
    if (meIndex !== -1 && hIndex !== -1 && timeToMinutes(timelineData[hIndex].time) <= timeToMinutes(timelineData[meIndex].time)) {
      let meMin = timeToMinutes(timelineData[meIndex].time);
      timelineData[hIndex].time = minutesToTime12(meMin + 30);
    }
    timelineData.forEach((task, idx) => {
      const tr = document.createElement('tr');
      if (task.status === 'complete') tr.classList.add('completed');
      let nowMin = timeToMinutes(getCurrentTime12());
      let taskMin = timeToMinutes(task.time);
      if (taskMin < dayStartHour * 60) taskMin += 1440;
      if (task.status === 'incomplete' && taskMin < nowMin - 15) {
        tr.classList.add('overdue');
      }
      let timeCell = document.createElement('td');
      const minutes = timeToMinutes(task.time);
      const ampmIcon = (minutes >= 720) ? 'üåô' : '‚òÄÔ∏è';
      const fixedIcon = task.fixed ? 'üîí' : '‚ÜïÔ∏è';
      timeCell.textContent = `${task.time} ${ampmIcon} ${fixedIcon}`;
      tr.appendChild(timeCell);
      let lmjCell = document.createElement('td');
      lmjCell.textContent = `${task.lmj}${task.emoji}`;
      tr.appendChild(lmjCell);
      let descCell = document.createElement('td');
      descCell.textContent = `${task.description} (${task.priority})`;
      descCell.className = 'editable';
      descCell.onclick = () => openEditModal(idx);
      tr.appendChild(descCell);
      let spoonCell = document.createElement('td');
      spoonCell.textContent = task.spoonCost.toFixed(1);
      spoonCell.className = 'editable';
      spoonCell.onclick = () => openEditModal(idx);
      tr.appendChild(spoonCell);
      let statusCell = document.createElement('td');
      statusCell.textContent = STATUS_ICONS[STATUS_KEYS.indexOf(task.status)] || STATUS_ICONS[0];
      statusCell.title = `Click to change status (current: ${task.status})`;
      statusCell.className = 'status-cell';
      statusCell.onclick = () => {
        toggleStatus(idx);
      };
      tr.appendChild(statusCell);
      let noteCell = document.createElement('td');
      noteCell.textContent = task.notes || '';
      noteCell.className = 'editable';
      noteCell.onclick = () => openEditModal(idx);
      tr.appendChild(noteCell);
      let actionsCell = document.createElement('td');
      const editBtn = document.createElement('button');
      editBtn.textContent = 'Edit';
      editBtn.onclick = (e) => {
        e.stopPropagation();
        openEditModal(idx);
      };
      actionsCell.appendChild(editBtn);
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.style.background = '#dc3545';
      delBtn.onclick = (e) => {
        e.stopPropagation();
        deleteTask(idx);
      };
      actionsCell.appendChild(delBtn);
      tr.appendChild(actionsCell);
      tbody.appendChild(tr);
    });
  }

  function openEditModal(index) {
    selectedTaskIndex = index;
    const task = timelineData[index];
    if (!task) return;
    document.getElementById('modalTime').value = task.time;
    document.getElementById('modalLmj').value = task.lmj;
    document.getElementById('modalEmoji').value = task.emoji;
    document.getElementById('modalDescription').value = task.description;
    document.getElementById('modalPriority').value = task.priority;
    document.getElementById('modalSpoonCost').value = task.spoonCost;
    document.getElementById('modalFixed').value = task.fixed ? 'true' : 'false';
    document.getElementById('modalNotes').value = task.notes || '';
    showModal();
  }

  function saveTaskFromModal(e) {
    e.preventDefault();
    if (selectedTaskIndex === null) return;
    const timeValue = document.getElementById('modalTime').value.trim();
    const parsedTime = parseTime12(timeValue);
    if (!parsedTime) {
      alert('Invalid time format. Use formats like "9am", "9:00 PM".');
      return;
    }
    let task = timelineData[selectedTaskIndex];
    task.time = timeValue;
    task.description = document.getElementById('modalDescription').value.trim() || 'No description';
    task.priority = document.getElementById('modalPriority').value;
    task.spoonCost = parseFloat(document.getElementById('modalSpoonCost').value) || 0;
    task.fixed = document.getElementById('modalFixed').value === 'true';
    task.notes = document.getElementById('modalNotes').value.trim();
    saveAndRender();
    closeModal();
  }

  function deleteTask(index) {
    if (!confirm('Are you sure you want to delete this task?')) return;
    timelineData.splice(index, 1);
    if (selectedTaskIndex === index) closeModal();
    saveAndRender();
  }

  function toggleStatus(index) {
    if (index < 0 || index >= timelineData.length) return;
    let task = timelineData[index];
    let currentIndex = STATUS_KEYS.indexOf(task.status);
    if (currentIndex === -1) currentIndex = 0;
    let nextIndex = (currentIndex + 1) % STATUS_KEYS.length;
    timelineData[index].status = STATUS_KEYS[nextIndex];
    saveAndRender();
  }

  function addNewTask() {
    let lmj = uniqueLMJ();
    let emoji = assignEmojiForLMJ(lmj);
    let defaultTime = minutesToTime12(dayStartHour * 60);
    timelineData.push({
      time: defaultTime,
      lmj,
      emoji,
      description: '',
      priority: 'Medium',
      spoonCost: 1,
      fixed: false,
      status: 'incomplete',
      notes: '',
      createdAt: new Date().toISOString()
    });
    saveAndRender();
    openEditModal(timelineData.length - 1);
  }

  function saveAndRender() {
    calculateSpoons();
    renderTimeline();
    renderLegend();
    saveAllData();
  }

  function saveAllData() {
    let saveObj = {
      timelineData,
      checkInData,
      spoonHistory,
      dayStartHour,
      dayEndHour,
      weatherData,
      consecutiveDebtDays
    };
    localStorage.setItem('spoonPalData', JSON.stringify(saveObj));
  }

  function loadAllData() {
    let saved = localStorage.getItem('spoonPalData');
    if (saved) {
      try {
        let data = JSON.parse(saved);
        timelineData = data.timelineData || [];
        checkInData = data.checkInData || checkInData;
        spoonHistory = data.spoonHistory || [];
        dayStartHour = data.dayStartHour || 8;
        dayEndHour = data.dayEndHour || 25;
        weatherData = data.weatherData || { impact: 0, description: 'No weather data' };
        consecutiveDebtDays = data.consecutiveDebtDays || 0;
      } catch (e) {
        console.error('Failed to parse saved data', e);
      }
    }
  }

  function fetchWeather() {
    // Simulate async fetch of weather data
    let conditions = [
      { impact: 0, description: '72¬∞F Clear - Ideal conditions' },
      { impact: -2, description: '45¬∞F Cold - Reduces spoons by 2' },
      { impact: -1, description: '88¬∞F Hot - Mild spoon impact' },
      { impact: -1, description: '65¬∞F Cloudy - Mild spoon impact' }
    ];
    let selected = conditions[Math.floor(Math.random() * conditions.length)];
    weatherData = selected;
    document.getElementById('weatherInfo').textContent = `Weather: ${selected.description}`;
    saveAndRender();
  }

  // Modal controls
  function showModal() {
    document.getElementById('taskModal').style.display = 'block';
    document.body.classList.add('modal-open');
  }

  function closeModal() {
    document.getElementById('taskModal').style.display = 'none';
    document.body.classList.remove('modal-open');
    selectedTaskIndex = null;
  }

  // Event Listeners on window load
  window.onload = () => {
    document.getElementById('timestamp').textContent = (new Date()).toLocaleString();
    loadAllData();
    updateUI();
    fetchWeather();

    document.getElementById('addTaskBtn').onclick = addNewTask;
    document.getElementById('refreshWeatherBtn').onclick = fetchWeather;
    document.getElementById('closeModalBtn').onclick = closeModal;
    document.getElementById('taskForm').addEventListener('submit', saveTaskFromModal);

    ['painLevel', 'fatigueLevel', 'sleepHours', 'moodLevel'].forEach(id => {
      document.getElementById(id).addEventListener('change', () => {
        checkInData.pain = parseInt(document.getElementById('painLevel').value) || 5;
        checkInData.fatigue = parseInt(document.getElementById('fatigueLevel').value) || 5;
        checkInData.sleepHours = parseFloat(document.getElementById('sleepHours').value) || 8;
        checkInData.mood = document.getElementById('moodLevel').value;
        saveAndRender();
      });
    });
  };

})();
</script>
</body>
</html>
