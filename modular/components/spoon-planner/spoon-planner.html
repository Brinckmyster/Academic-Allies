<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SpoonPal Mini-App</title>
<style>
  /* Your styles here, optimized for accessibility and mobile */
  body { font-family: Arial, sans-serif; margin: 1rem; background:#f7faff; color:#222; }
  .container { max-width: 900px; margin:auto; background:#fff; padding:1rem 1.5rem; border-radius:8px; box-shadow:0 3px 10px rgba(0,0,0,0.1); }
  h1 { text-align:center; margin-bottom:1.5rem; }
  #timestamp { text-align:center; font-weight:bold; margin-bottom:1rem; }
  .section { margin-bottom:1.5rem; }
  .spoon-summary { background:#e9f1fa; padding:1rem; border-radius:6px; }
  .spoon-summary span { display:inline-block; margin-right:1rem; font-weight:bold; }
  .checkin-section, .weather-section { background:#f0f8ff; padding:1rem; border-radius:6px; }
  .checkin-section label, .weather-section label { display:block; margin-bottom:0.5rem; }
  .checkin-section input, .checkin-section select { width:100%; padding:0.5rem; margin-top:0.3rem; border-radius:5px; border:1px solid #ccc; font-size:1rem; }
  table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
  th, td { padding: 0.5rem 0.6rem; border: 1px solid #ccc; text-align:left; }
  th { background:#e5f2ff; position: sticky; top: 0; z-index: 1; }
  tr.completed { background:#d2f0d2; }
  tr.overdue { background:#ffdddd; }
  tr.out-of-order { border-left:5px solid #ffa500; background:#fff8e1; }
  .legend { font-family: monospace; background:#ffe; color:#333; padding:0.5rem; font-size:0.85rem; border-radius:4px; margin-bottom:0.75rem; white-space: nowrap; overflow-x:auto; }
  button { padding: 0.6rem 1.3rem; font-size: 1rem; border-radius: 6px; border:none; background:#4a90e2; color:#fff; cursor:pointer; margin-top:0.75rem; }
  button:hover { background:#357ab8; }
  button:disabled { background:#99c1e6; cursor: not-allowed; }
  #addTaskBtn { display: block; margin: 1rem auto 0; max-width: 160px; }
  .btn-danger { background:#d9534f; }
  .btn-danger:hover { background:#b53939; }
  /* Modal styles */
  #taskModal { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background-color: rgba(0,0,0,0.5); z-index:99; }
  #taskModal .modal-content { background:#fff; margin:5rem auto; max-width:450px; border-radius:8px; padding:1.5rem; position:relative; box-shadow:0 4px 20px rgba(0,0,0,0.3); }
  #taskModal label { display:block; margin: 0.8rem 0 0.3rem; font-weight:600; }
  #taskModal input[type=text], #taskModal input[type=number], #taskModal select, #taskModal textarea { width:100%; padding:0.6rem; border:1px solid #ccc; border-radius:5px; font-size:1rem; }
  #taskModal textarea { resize: vertical; }
  #taskModal .close-btn { position:absolute; top:10px; right:12px; font-size:1.5rem; font-weight:bold; cursor:pointer; border:none; background:none; }
  #taskModal .actions { display:flex; justify-content:space-between; margin-top:1.4rem; }
  #taskModal .actions button { width:48%; }

</style>
</head>
<body>
<div class="container" role="main">
  <h1>SpoonPal Mini-App</h1>
  <div id="timestamp" aria-live="polite" aria-atomic="true"></div>

  <div id="debtWarning" aria-live="assertive" role="alert" style="display:none; background:#e55; color:#fff; padding:0.75rem; border-radius:6px; font-weight:bold; margin-bottom:1rem;"></div>

  <div class="section spoon-summary" aria-label="Spoon management summary">
    <span id="baselineSpoons">Baseline: --</span>
    <span id="borrowedSpoons">Borrowed: --</span>
    <span id="startSpoons">Start: --</span> <br/>
    <span id="plannedSpoons">Planned: --</span>
    <span id="spentSpoons">Spent: --</span>
    <span id="remainingSpoons">Remaining: --</span> <br/>
    <span id="depletionSpoons">Depletion: --</span>
    <span id="consecutiveDebt">Consecutive Debt Days: 0</span>
  </div>

  <div class="section checkin-section" aria-label="Daily check-in">
    <label for="painLevel">Pain Level (1-10)
      <input type="number" id="painLevel" min="1" max="10" value="5" />
    </label>
    <label for="fatigueLevel">Fatigue Level (1-10)
      <input type="number" id="fatigueLevel" min="1" max="10" value="5" />
    </label>
    <label for="sleepHours">Sleep Hours (0-24)
      <input type="number" id="sleepHours" min="0" max="24" step="0.25" value="8" />
    </label>
    <label for="moodLevel">Mood
      <select id="moodLevel">
        <option value="excellent">Excellent</option>
        <option value="good">Good</option>
        <option value="okay" selected>Okay</option>
        <option value="poor">Poor</option>
        <option value="terrible">Terrible</option>
      </select>
    </label>
  </div>

  <div class="section weather-section" aria-label="Weather information">
    <span id="weatherInfo">Loading weather...</span>
    <button id="refreshWeatherBtn" aria-label="Refresh weather">Refresh</button>
  </div>

  <div id="legend" class="legend" aria-label="Protocol legend"></div>

  <table id="timelineTable" aria-label="Task timeline" role="grid" aria-live="polite">
    <thead>
      <tr>
        <th scope="col">Time</th>
        <th scope="col">LMJ</th>
        <th scope="col">Task (Priority)</th>
        <th scope="col" title="Spoon Cost">🥄</th>
        <th scope="col">Status</th>
        <th scope="col">Notes</th>
        <th scope="col">Actions</th>
      </tr>
    </thead>
    <tbody id="timelineBody"></tbody>
  </table>

  <button id="addTaskBtn" aria-label="Add new task">Add Task</button>

  <div id="taskModal" class="modal" role="dialog" aria-labelledby="taskModalTitle" aria-describedby="taskModalDesc">
    <div class="modal-content">
      <button class="close-btn" id="modalCloseBtn" aria-label="Close dialog">&times;</button>
      <h2 id="taskModalTitle">Edit Task</h2>
      <form id="taskForm">
        <label for="modalTime">Time (e.g. 9am, 9:00 PM)
          <input type="text" id="modalTime" required />
        </label>
        <label for="modalLmj">LMJ Code (auto-assigned)
          <input type="text" id="modalLmj" readonly aria-readonly="true" />
        </label>
        <label for="modalEmoji">Emoji (auto-assigned)
          <input type="text" id="modalEmoji" readonly aria-readonly="true" />
        </label>
        <label for="modalDescription">Description
          <input type="text" id="modalDescription" required />
        </label>
        <label for="modalPriority">Priority
          <select id="modalPriority">
            <option value="Urgent">Urgent</option>
            <option value="High" selected>High</option>
            <option value="Medium">Medium</option>
            <option value="Low">Low</option>
          </select>
        </label>
        <label for="modalSpoonCost">Spoon Cost
          <input type="number" id="modalSpoonCost" min="0" max="10" step="0.5" required />
        </label>
        <label for="modalFixed">Fixed or Flexible
          <select id="modalFixed">
            <option value="true">Fixed</option>
            <option value="false" selected>Flexible</option>
          </select>
        </label>
        <label for="modalNotes">Notes
          <textarea id="modalNotes"></textarea>
        </label>
        <div style="margin-top:1rem; display:flex; justify-content:space-between;">
          <button type="submit" aria-label="Save changes">Save</button>
          <button type="button" id="modalDeleteBtn" aria-label="Delete task" style="background:#d9534f; color:#fff;">
            Delete
          </button>
        </div>
      </form>
    </div>
  </div>

<script>
(() => {
  'use strict';

  /* --- locked protocol data --- */
  const LOCKED_LMJ_ORDER = [
    { lmj:'A', emoji:'💊', description:'Morning meds', defaultSpoonCost:2, defaultFixed:true },
    { lmj:'V', emoji:'🦾', description:'CPAP prep, wrist brace', defaultSpoonCost:1, defaultFixed:true },
    { lmj:'B', emoji:'🍽️', description:'Family scriptures, breakfast', defaultSpoonCost:2, defaultFixed:false },
    { lmj:'G', emoji:'🐥', description:'Gosling time', defaultSpoonCost:2, defaultFixed:false },
    { lmj:'N', emoji:'📰', description:'News with Mom', defaultSpoonCost:1, defaultFixed:false },
    { lmj:'ME', emoji:'🧘', description:'Me time', defaultSpoonCost:1, defaultFixed:false },
    { lmj:'H', emoji:'🧺', description:'Hamper/laundry', defaultSpoonCost:1, defaultFixed:false },
    { lmj:'CC', emoji:'🛏️', description:'In bed', defaultSpoonCost:0, defaultFixed:true },
    { lmj:'DD', emoji:'💨', description:'Breathe, recover', defaultSpoonCost:0, defaultFixed:true },
    { lmj:'EE', emoji:'😷', description:'CPAP mask', defaultSpoonCost:0, defaultFixed:true },
    { lmj:'FF', emoji:'🤚', description:'Wrist brace', defaultSpoonCost:0, defaultFixed:true },
    { lmj:'ZZ', emoji:'📵', description:'Device off, crash', defaultSpoonCost:0, defaultFixed:true }
  ];
  const STATUS_ICONS = ['⬜', '⏳', '🛠️', '✅', '🚧', '❌', '🔄'];
  const STATUS_KEYS = ['incomplete', 'partial', 'progress', 'complete', 'interrupted', 'skipped', 'rescheduled'];

  /* --- variables and state --- */
  let timeline = [];
  let checkIn = { pain:5, fatigue:5, sleepHours:8, mood:'okay' };
  let spoonHistory = [];
  let dayStartHour = 8;
  let dayEndHour = 25;
  let weather = { impact:0, description:'Loading weather...' };
  let debtDays = 0;
  let selectedTaskIdx = null;

  window.addEventListener('load', () => {
    loadData();
    updateUI();
    fetchWeather();

    document.getElementById('addTaskBtn').onclick = addTask;
    document.getElementById('refreshWeatherBtn').onclick = fetchWeather;
    document.getElementById('modalCloseBtn').onclick = closeModal;
    document.getElementById('modalDeleteBtn').onclick = deleteTask;
    document.getElementById('taskForm').onsubmit = saveTask;
    ['painLevel','fatigueLevel','sleepHours','moodLevel'].forEach(id => {
      document.getElementById(id).addEventListener('change', saveCheckIn);
    });

    updateTimestamp();
    setInterval(updateTimestamp, 60000);
  });

  function updateTimestamp(){
    const now = new Date();
    document.getElementById('timestamp').textContent = now.toLocaleString(undefined, { dateStyle:'long', timeStyle:'short' });
  }

  function loadData(){
    const stored = localStorage.getItem('spoonPalData');
    if(stored){
      try{
        const d = JSON.parse(stored);
        timeline = d.timeline || [];
        checkIn = d.checkIn || checkIn;
        spoonHistory = d.spoonHistory || [];
        dayStartHour = d.dayStartHour || 8;
        dayEndHour = d.dayEndHour || 25;
        weather = d.weather || weather;
        debtDays = d.debtDays || 0;
      }catch(e){ console.warn('Invalid saved data'); }
    }
  }
  function saveData(){
    const d = { timeline, checkIn, spoonHistory, dayStartHour, dayEndHour, weather, debtDays };
    localStorage.setItem('spoonPalData', JSON.stringify(d));
  }

  function updateUI(){
    updateCheckInUI();
    calculateSpoons();
    renderLegend();
    renderTimeline();
    updateDebtWarning();
  }

  function updateCheckInUI(){
    document.getElementById('painLevel').value = checkIn.pain;
    document.getElementById('fatigueLevel').value = checkIn.fatigue;
    document.getElementById('sleepHours').value = checkIn.sleepHours;
    document.getElementById('moodLevel').value = checkIn.mood;
  }
  function saveCheckIn(){
    checkIn.pain = parseInt(document.getElementById('painLevel').value) || 5;
    checkIn.fatigue = parseInt(document.getElementById('fatigueLevel').value) || 5;
    checkIn.sleepHours = parseFloat(document.getElementById('sleepHours').value) || 8;
    checkIn.mood = document.getElementById('moodLevel').value;
    updateUI();
    saveData();
  }

  function calculateSpoons(){
    let baseline = 20;
    baseline -= Math.max(0, checkIn.pain - 5);
    baseline -= Math.max(0, checkIn.fatigue - 5);
    if(checkIn.sleepHours < 7) baseline -= (7 - checkIn.sleepHours) * 2;
    else if(checkIn.sleepHours > 9) baseline += Math.min(3, checkIn.sleepHours - 9);
    const moodAdj = {terrible:-3, poor:-1, okay:0, good:1, excellent:2};
    baseline += moodAdj[checkIn.mood] || 0;
    baseline += weather.impact || 0;
    baseline = Math.max(1, baseline);

    let borrowed = 0; // Placeholder for borrowed spoons tracking

    let planned = timeline.reduce((sum,t) => sum + (t.spoonCost || 0), 0);
    let spent = timeline.reduce((sum,t) => {
      if(t.status === 'complete') return sum + (t.spoonCost || 0);
      if(t.status === 'partial') return sum + ((t.spoonCost || 0)/2);
      return sum;
    }, 0);

    let startSpoons = baseline - borrowed;
    let remaining = startSpoons - spent;
    let depletion = remaining - (planned - spent);

    document.getElementById('baselineSpoons').textContent = baseline;
    document.getElementById('borrowedSpoons').textContent = borrowed;
    document.getElementById('startSpoons').textContent = startSpoons;
    document.getElementById('plannedSpoons').textContent = planned.toFixed(1);
    document.getElementById('spentSpoons').textContent = spent.toFixed(1);
    document.getElementById('remainingSpoons').textContent = remaining.toFixed(1);
    document.getElementById('depletionSpoons').textContent = depletion.toFixed(1);

    // Update debt history
    const today = new Date().toDateString();
    spoonHistory = spoonHistory.filter(x => x.date !== today);
    spoonHistory.push({ date: today, baseline, spent, depletion, timestamp: new Date().toISOString() });
    debtDays = 0;
    for(let i=spoonHistory.length - 1; i >= 0; i--){
      if(spoonHistory[i].depletion < 0) debtDays++;
      else break;
    }
  }

  function updateDebtWarning(){
    const warningEl = document.getElementById('debtWarning');
    if(debtDays >= 2){
      let txt = '';
      if(debtDays >= 5) txt = `🛑 CRITICAL DEBT PERIOD (Day ${debtDays})`;
      else if(debtDays >=3) txt = `⚠️ BURNOUT RISK (Day ${debtDays})`;
      else txt = `⚠️ SPOON DEBT WARNING (Day ${debtDays})`;
      warningEl.textContent = txt;
      warningEl.style.display = 'block';
    } else {
      warningEl.style.display = 'none';
    }
  }

  function renderLegend(){
    const legend = 'Fixed 🔒 Flexible ↕️ Urgent 🔥 AM ☀️ PM 🌙 🥄 Spoon LMJ 🎯 Status ✅ ⬜ ⏳ 🛠️ 🚧 ❌ 🔄';
    document.getElementById('legend').textContent = legend;
  }

  function renderTimeline(){
    const tbody = document.getElementById('timelineBody');
    tbody.innerHTML = '';
    timeline.sort((a,b) => {
      let aM = timeToMinutes(a.time);
      let bM = timeToMinutes(b.time);
      if (aM < dayStartHour * 60) aM += 1440;
      if (bM < dayStartHour * 60) bM += 1440;
      return aM - bM;
    });

    // Enforce H after ME
    const idxME = timeline.findIndex(t => t.lmj === 'ME');
    const idxH = timeline.findIndex(t => t.lmj === 'H');
    if(idxME !== -1 && idxH !== -1){
      if(timeToMinutes(timeline[idxH].time) <= timeToMinutes(timeline[idxME].time)){
        const newTimeM = timeToMinutes(timeline[idxME].time) + 30;
        timeline[idxH].time = minutesToTime12(newTimeM);
      }
    }

    timeline.forEach((task, i) => {
      const tr = document.createElement('tr');
      if(task.status === 'complete') tr.classList.add('completed');
      const nowMins = (new Date()).getHours() * 60 + (new Date()).getMinutes();
      const taskMins = timeToMinutes(task.time) < dayStartHour * 60 ? timeToMinutes(task.time) + 1440 : timeToMinutes(task.time);
      if(task.status === 'incomplete' && taskMins < nowMins - 15) tr.classList.add('overdue');

      // Time Column - with AM/PM Sunrise/Moon icons and Fixed/Flexible icon
      const timeTd = document.createElement('td');
      const ampmIcon = timeToMinutes(task.time) >= 720 ? '🌙' : '☀️';
      const fixedIcon = task.fixed ? '🔒' : '↕️';
      timeTd.textContent = `${task.time} ${ampmIcon} ${fixedIcon}`;
      tr.appendChild(timeTd);

      // LMJ Column
      const lmjTd = document.createElement('td');
      lmjTd.textContent = `${task.lmj}${task.emoji}`;
      tr.appendChild(lmjTd);

      // Task Description Column (editable)
      const descTd = document.createElement('td');
      descTd.textContent = `${task.description} (${task.priority})`;
      descTd.classList.add('editable');
      descTd.onclick = () => openEditModal(i);
      tr.appendChild(descTd);

      // Spoon Cost Column (editable)
      const spoonTd = document.createElement('td');
      spoonTd.textContent = task.spoonCost.toFixed(1);
      spoonTd.classList.add('editable');
      spoonTd.onclick = () => openEditModal(i);
      tr.appendChild(spoonTd);

      // Status Column (icon only, clickable to cycle)
      const statusTd = document.createElement('td');
      const statusIx = STATUS_KEYS.indexOf(task.status);
      statusTd.textContent = STATUS_ICONS[statusIx] || STATUS_ICONS[0];
      statusTd.title = `Status: ${task.status}. Click to toggle.`;
      statusTd.style.cursor = 'pointer';
      statusTd.onclick = () => {
        let ix = (STATUS_KEYS.indexOf(task.status) + 1) % STATUS_KEYS.length;
        task.status = STATUS_KEYS[ix];
        saveData();
        renderTimeline();
        calculateSpoons();
      };
      tr.appendChild(statusTd);

      // Notes Column (editable)
      const notesTd = document.createElement('td');
      notesTd.textContent = task.notes || '';
      notesTd.classList.add('editable');
      notesTd.onclick = () => openEditModal(i);
      tr.appendChild(notesTd);

      // Actions Column (edit/delete buttons)
      const actionTd = document.createElement('td');
      const editBtn = document.createElement('button');
      editBtn.textContent = 'Edit';
      editBtn.onclick = (e) => { e.stopPropagation(); openEditModal(i); };
      actionTd.appendChild(editBtn);
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.style.backgroundColor = '#d9534f';
      delBtn.onclick = (e) => { e.stopPropagation(); deleteTask(i);}
      actionTd.appendChild(delBtn);
      tr.appendChild(actionTd);

      tbody.appendChild(tr);
    });
  }

  function openEditModal(i){
    selectedTaskIdx = i;
    const task = timeline[i];
    document.getElementById('modalTime').value = task.time;
    document.getElementById('modalLmj').value = task.lmj;
    document.getElementById('modalEmoji').value = task.emoji;
    document.getElementById('modalDescription').value = task.description;
    document.getElementById('modalPriority').value = task.priority;
    document.getElementById('modalSpoonCost').value = task.spoonCost;
    document.getElementById('modalFixed').value = task.fixed ? 'true' : 'false';
    document.getElementById('modalNotes').value = task.notes || '';
    document.getElementById('taskModal').style.display = 'block';
    document.body.classList.add('modal-open');
  }
  function closeModal(){
    document.getElementById('taskModal').style.display = 'none';
    document.body.classList.remove('modal-open');
    selectedTaskIdx = null;
  }
  document.getElementById('modalCloseBtn').onclick = closeModal;

  function saveTask(e){
    e.preventDefault();
    if(selectedTaskIdx === null) return;
    const timeVal = document.getElementById('modalTime').value.trim();
    if(!/^(\d{1,2})(?::(\d{2}))?\s*(AM|PM)$/i.test(timeVal)){
      alert('Invalid time format. Use formats like "9am" or "9:00 PM".');
      return;
    }
    const task = timeline[selectedTaskIdx];
    task.time = timeVal;
    // LMJ and emoji cannot be changed
    task.description = document.getElementById('modalDescription').value.trim() || 'No description';
    task.priority = document.getElementById('modalPriority').value;
    task.spoonCost = parseFloat(document.getElementById('modalSpoonCost').value) || 0;
    task.fixed = document.getElementById('modalFixed').value === 'true';
    task.notes = document.getElementById('modalNotes').value.trim();
    saveData();
    updateUI();
    closeModal();
  }

  function deleteTask(){
    if(selectedTaskIdx === null) return;
    if(confirm('Delete the task?')){
      timeline.splice(selectedTaskIdx,1);
      saveData();
      updateUI();
      closeModal();
    }
  }

  function addTask(){
    const nextLMJ = getNextAvailableLMJ();
    const emoji = getEmojiForLMJ(nextLMJ);
    const newTaskTime = minutesToTime12(dayStartHour * 60);
    timeline.push({
      time: newTaskTime,
      lmj: nextLMJ,
      emoji: emoji,
      description: '',
      priority: 'Medium',
      spoonCost: 1,
      fixed: false,
      status: 'incomplete',
      notes: '',
      created: new Date().toISOString()
    });
    saveData();
    updateUI();
    openEditModal(timeline.length - 1);
  }

  function getNextAvailableLMJ(){
    const used = new Set(timeline.map(t => t.lmj));
    for(let lmj of LOCKED_LMJ_ORDER.map(t => t.lmj)){
      if(!used.has(lmj)) return lmj;
    }
    // Then add single letters A-Z except used
    for(let i=0; i<26; i++){
      let c = String.fromCharCode(65 + i);
      if(!used.has(c)) return c;
    }
    // Then double letter combinations
    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    for(let i=0; i<letters.length; i++){
      for(let j=0; j<letters.length; j++){
        let c = letters[i]+letters[j];
        if(!used.has(c)) return c;
      }
    }
    // Else fallback
    return 'XX';
  }

  function getEmojiForLMJ(lmj){
    const locked = LOCKED_LMJ_ORDER.find(t => t.lmj === lmj);
    if(locked) return locked.emoji;
    // generic fallback emoji for user-added tasks
    return '🧩';
  }

})();
</script>
</body>
</html>
