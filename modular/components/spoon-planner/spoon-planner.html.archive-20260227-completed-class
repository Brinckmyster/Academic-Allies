<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spoon Planner - Mary's Safe Space</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        body {
            font-family: 'Atkinson Hyperlegible', 'OpenDyslexic', Arial, sans-serif;
            font-size: 18pt;
            line-height: 1.5;
            letter-spacing: 0.035em;
            background: #FAFAF9;
            color: #333333;
            min-height: 100vh;
            padding: 20px;
        }

        .planner-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 22pt;
            margin-bottom: 10px;
            color: #6CA0A3;
        }

        /* Top Action Bar */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .btn-cancel {
            background: #999;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16pt;
            cursor: pointer;
            min-height: 19mm;
            transition: opacity 0.2s;
            font-weight: 600;
        }

        .btn-cancel:hover {
            opacity: 0.8;
        }

        .btn-cancel:active {
            animation: blink 0.3s;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Spoon Counter */
        .spoon-summary {
            background: #6CA0A3;
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
        }

        .spoon-display {
            font-size: 24pt;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .spoon-details {
            display: flex;
            justify-content: space-around;
            font-size: 14pt;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #6CA0A3;
            margin-bottom: 15px;
            font-size: 20pt;
        }

        /* Task List */
        .task-list {
            list-style: none;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            margin-bottom: 10px;
            min-height: 19mm;
            background: white;
            cursor: grab;
        }

        .task-item:active {
            cursor: grabbing;
        }

        .task-item.dragging {
            opacity: 0.5;
            border-color: #6CA0A3;
        }

        .task-item.task-completed {
            opacity: 0.6;
            background: #f5f5f5;
        }

        .task-item.task-completed .task-name {
            text-decoration: line-through;
            color: #888;
        }

        .task-check {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .drag-handle {
            font-size: 20pt;
            margin-right: 12px;
            cursor: grab;
            color: #999;
            min-width: 19mm;
            text-align: center;
        }

        .task-content {
            flex: 1;
        }

        .task-name {
            font-size: 16pt;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .task-meta {
            font-size: 14pt;
            color: #666;
        }

        .task-spoons {
            font-size: 18pt;
            font-weight: 700;
            color: #6CA0A3;
            margin: 0 15px;
        }

        .task-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            background: none;
            border: none;
            font-size: 20pt;
            cursor: pointer;
            padding: 8px;
            min-width: 19mm;
            min-height: 19mm;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .btn-icon:hover {
            background: #f0f0f0;
        }

        .btn-icon:focus {
            outline: 3px solid #6CA0A3;
        }

        /* Add Task Form */
        .add-task-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .form-label {
            font-weight: 600;
            min-width: 100px;
            font-size: 16pt;
        }

        .form-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16pt;
            min-height: 19mm;
        }

        .form-input:focus {
            outline: none;
            border-color: #6CA0A3;
        }

        .form-input-small {
            width: 80px;
        }

        /* Buttons */
        .btn {
            background: #6CA0A3;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 18pt;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            min-height: 19mm;
            transition: opacity 0.2s;
            font-weight: 600;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:focus {
            outline: 3px solid #6CA0A3;
            outline-offset: 2px;
        }

        .btn-confirm {
            background: #6CA0A3;
            font-size: 20pt;
            padding: 20px;
        }

        .btn-add {
            background: #4caf50;
        }

        .btn-bulk {
            background: #999;
            font-size: 16pt;
            padding: 12px 20px;
        }

        /* Bulk Actions */
        .bulk-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .bulk-actions .btn {
            flex: 1;
        }

        /* Modal for Edit Task */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 {
            color: #6CA0A3;
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        @media (max-width: 600px) {
            .form-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .form-label {
                min-width: auto;
            }

            .bulk-actions {
                flex-direction: column;
            }

            .action-bar {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
<div id="site-header"></div>
<script>
    fetch('/Academic-Allies/modular/shared-header.html?v=20260220d')
      .then(response => response.text())
      .then(html => {
        const container = document.getElementById('site-header');
        container.innerHTML = html;
        const scripts = container.querySelectorAll('script');
        scripts.forEach(oldScript => {
          const newScript = document.createElement('script');
          Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
          newScript.textContent = oldScript.textContent;
          oldScript.replaceWith(newScript);
        });
        const dragScript = document.createElement('script');
        dragScript.src = '/Academic-Allies/modular/js/draggable.js';
        dragScript.onload = () => { if(typeof initDrag === 'function') initDrag(); };
        document.body.appendChild(dragScript);
      });
  </script>
    <div class="planner-container">
        <div class="header">
            <h1>üìã Spoon Planner</h1>
            <p>Plan your day with care</p>
        </div>

        <!-- Action Bar with Cancel -->
        <div class="action-bar">
            <button class="btn-cancel" onclick="cancelPlanner()">‚Üê Cancel</button>
            <div style="flex: 1; text-align: center; font-size: 16pt; color: #666;">
                Editing your daily plan
            </div>
        </div>

        <!-- Spoon Summary -->
        <div class="spoon-summary">
            <div class="spoon-display">
                ü•Ñ <span id="remaining-spoons">10</span> / <span id="total-spoons">10</span> Spoons
            </div>
            <div class="spoon-details">
                <div>Planned: <span id="planned-spoons">0</span></div>
                <div>Remaining: <span id="leftover-spoons">10</span></div>
            </div>
        </div>

        <!-- Add New Task -->
        <div class="card">
            <h2>‚ûï Add New Task</h2>
            <div class="add-task-form">
                <div class="form-row">
                    <label class="form-label">Task Name:</label>
                    <input type="text" id="new-task-name" class="form-input" placeholder="What do you need to do?">
                </div>
                <div class="form-row">
                    <label class="form-label">Spoon Cost:</label>
                    <input type="number" id="new-task-spoons" class="form-input form-input-small" min="0" max="20" value="1" step="0.5">
                </div>
                <div class="form-row">
                    <label class="form-label">Time:</label>
                    <input type="time" id="new-task-time" class="form-input">
                </div>
                <div class="form-row">
                    <label class="form-label">Priority:</label>
                    <select id="new-task-priority" class="form-input">
                        <option value="High">High</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
                <button class="btn btn-add" onclick="addTask()">Add Task</button>
            </div>
        </div>

        <!-- Task List -->
        <div class="card">
            <h2>üìù Your Tasks</h2>
            <p style="margin-bottom: 15px; color: #666; font-size: 14pt;">Drag to reorder. Tap to edit.</p>
            
            <ul class="task-list" id="task-list">
                <!-- Tasks will be added here -->
            </ul>

            <div id="empty-state" style="text-align: center; padding: 40px; color: #999;">
                <p style="font-size: 48pt;">üìã</p>
                <p style="font-size: 16pt;">No tasks yet. Add one above!</p>
            </div>
        </div>

        <!-- Bulk Actions -->
        <div class="bulk-actions">
            <button class="btn btn-bulk" onclick="clearAllTasks()">üóëÔ∏è Clear All</button>
            <button class="btn btn-bulk" onclick="duplicateDay()">üìã Duplicate Yesterday</button>
        </div>

        <!-- Confirm Button - Bottom -->
        <button class="btn btn-confirm" onclick="confirmPlan()">
            ‚úÖ Confirm Plan
        </button>

        <!-- Back to Recovery Mode -->
        <button class="btn" onclick="backToRecovery()">
            ‚Üê Back to Recovery Mode
        </button>
    </div>

    <!-- Edit Task Modal -->
    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <h2>‚úèÔ∏è Edit Task</h2>
            <div class="add-task-form">
                <div class="form-row">
                    <label class="form-label">Task Name:</label>
                    <input type="text" id="edit-task-name" class="form-input">
                </div>
                <div class="form-row">
                    <label class="form-label">Spoon Cost:</label>
                    <input type="number" id="edit-task-spoons" class="form-input form-input-small" min="0" max="20" step="0.5">
                </div>
                <div class="form-row">
                    <label class="form-label">Time:</label>
                    <input type="time" id="edit-task-time" class="form-input">
                </div>
                <div class="form-row">
                    <label class="form-label">Priority:</label>
                    <select id="edit-task-priority" class="form-input">
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button class="btn" onclick="saveEdit()">Save</button>
                    <button class="btn btn-cancel" onclick="closeEditModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* Claude-credit: Firebase sync added 2026-02-26 by Claude */
        // State Management
        let tasks = [];
        let totalSpoons = 10;
        let editingTaskIndex = -1;
        let originalTasks = []; // For cancel functionality

        // Load saved data ‚Äî localStorage first (fast), then Firebase if signed in
        function loadSavedData() {
            const saved = localStorage.getItem('spoonPlannerTasks');
            if (saved) {
                originalTasks = JSON.parse(saved);
                tasks = JSON.parse(JSON.stringify(originalTasks));
            }
            const savedSpoons = localStorage.getItem('dailySpoons');
            if (savedSpoons) totalSpoons = parseInt(savedSpoons);
            renderTasks();

            // Then try Firebase ‚Äî overrides localStorage if data is fresher
            if (window.AA && AA.auth) {
                AA.auth.onAuthStateChanged(function(user) {
                    if (!user) return;
                    AA.getSpoonPlan(user.uid).then(function(data) {
                        if (!data) return;
                        if (data.tasks)       { tasks = data.tasks; originalTasks = JSON.parse(JSON.stringify(tasks)); }
                        if (data.dailySpoons) { totalSpoons = data.dailySpoons; }
                        renderTasks();
                    }).catch(function(err) {
                        console.warn('[AA] Could not load spoon plan from Firebase:', err.message);
                    });
                });
            }
        }

        // Save data ‚Äî always localStorage, also Firebase if signed in
        function saveTasks() {
            localStorage.setItem('spoonPlannerTasks', JSON.stringify(tasks));
            if (window.AA && AA.auth && AA.auth.currentUser) {
                AA.saveSpoonPlan(AA.auth.currentUser.uid, {
                    tasks: tasks,
                    dailySpoons: totalSpoons
                }).catch(function(err) {
                    console.warn('[AA] Could not save spoon plan to Firebase:', err.message);
                });
            }
        }

        // Update spoon counter
        function updateSpoonCounter() {
            const planned = tasks.reduce((sum, task) => sum + task.spoons, 0);
            const completed = tasks.filter(t => t.completed).reduce((sum, t) => sum + t.spoons, 0);
            const remaining = totalSpoons - completed;
            const leftover = totalSpoons - planned;

            document.getElementById('total-spoons').textContent = totalSpoons;
            document.getElementById('planned-spoons').textContent = planned.toFixed(1);
            document.getElementById('remaining-spoons').textContent = remaining.toFixed(1);
            document.getElementById('leftover-spoons').textContent = leftover.toFixed(1);
        }

        // Render task list
        function renderTasks() {
            const taskList = document.getElementById('task-list');
            const emptyState = document.getElementById('empty-state');

            if (tasks.length === 0) {
                taskList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            taskList.innerHTML = '';

            tasks.forEach((task, index) => {
                const li = document.createElement('li');
                li.className = 'task-item';
                li.draggable = true;
                li.dataset.index = index;

                if (task.completed) li.classList.add('task-completed');

                li.innerHTML = `
                    <span class="drag-handle">‚ò∞</span>
                    <input type="checkbox" class="task-check" ${task.completed ? 'checked' : ''} onchange="toggleComplete(${index})" aria-label="Mark complete">
                    <div class="task-content">
                        <div class="task-name">${task.name}</div>
                        <div class="task-meta">${task.time ? task.time + ' ‚Ä¢ ' : ''}${task.priority} Priority</div>
                    </div>
                    <span class="task-spoons">${task.spoons}ü•Ñ</span>
                    <div class="task-actions">
                        <button class="btn-icon" onclick="editTask(${index})" aria-label="Edit task">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="deleteTask(${index})" aria-label="Delete task">üóëÔ∏è</button>
                    </div>
                `;

                // Drag and drop handlers
                li.addEventListener('dragstart', handleDragStart);
                li.addEventListener('dragover', handleDragOver);
                li.addEventListener('drop', handleDrop);
                li.addEventListener('dragend', handleDragEnd);

                taskList.appendChild(li);
            });

            updateSpoonCounter();
        }

        // Toggle task completion
        function toggleComplete(index) {
            tasks[index].completed = !tasks[index].completed;
            saveTasks();
            renderTasks();
        }

        // Add new task
        function addTask() {
            const name = document.getElementById('new-task-name').value.trim();
            const spoons = parseFloat(document.getElementById('new-task-spoons').value) || 1;
            const time = document.getElementById('new-task-time').value;
            const priority = document.getElementById('new-task-priority').value;

            if (!name) {
                alert('Please enter a task name');
                return;
            }

            tasks.push({
                name,
                spoons,
                time,
                priority,
                completed: false
            });

            // Clear form
            document.getElementById('new-task-name').value = '';
            document.getElementById('new-task-spoons').value = '1';
            document.getElementById('new-task-time').value = '';
            document.getElementById('new-task-priority').value = 'Medium';

            renderTasks();
        }

        // Edit task
        function editTask(index) {
            editingTaskIndex = index;
            const task = tasks[index];

            document.getElementById('edit-task-name').value = task.name;
            document.getElementById('edit-task-spoons').value = task.spoons;
            document.getElementById('edit-task-time').value = task.time || '';
            document.getElementById('edit-task-priority').value = task.priority;

            document.getElementById('edit-modal').classList.add('show');
        }

        function saveEdit() {
            if (editingTaskIndex === -1) return;

            tasks[editingTaskIndex] = {
                name: document.getElementById('edit-task-name').value.trim(),
                spoons: parseFloat(document.getElementById('edit-task-spoons').value) || 1,
                time: document.getElementById('edit-task-time').value,
                priority: document.getElementById('edit-task-priority').value,
                completed: tasks[editingTaskIndex].completed
            };

            closeEditModal();
            renderTasks();
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('show');
            editingTaskIndex = -1;
        }

        // Delete task
        function deleteTask(index) {
            if (confirm('Delete this task?')) {
                tasks.splice(index, 1);
                renderTasks();
            }
        }

        // Bulk actions
        function clearAllTasks() {
            if (confirm('Clear all tasks? This cannot be undone.')) {
                tasks = [];
                renderTasks();
            }
        }

        function duplicateDay() {
            const yesterday = localStorage.getItem('yesterdayTasks');
            if (yesterday) {
                tasks = JSON.parse(yesterday);
                renderTasks();
            } else if (window.AA && AA.auth && AA.auth.currentUser) {
                AA.getSpoonPlan(AA.auth.currentUser.uid).then(function(data) {
                    if (data && data.yesterdayTasks && data.yesterdayTasks.length > 0) {
                        tasks = data.yesterdayTasks;
                        renderTasks();
                    } else {
                        alert('No tasks from yesterday to duplicate.');
                    }
                });
            } else {
                alert('No tasks from yesterday to duplicate.');
            }
        }

        // Drag and drop
        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedElement !== this) {
                const fromIndex = parseInt(draggedElement.dataset.index);
                const toIndex = parseInt(this.dataset.index);

                const [movedTask] = tasks.splice(fromIndex, 1);
                tasks.splice(toIndex, 0, movedTask);

                renderTasks();
            }

            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
        }

        // Confirm plan
        function confirmPlan() {
            // Save to localStorage
            saveTasks();
            localStorage.setItem('yesterdayTasks', JSON.stringify(tasks));
            originalTasks = JSON.parse(JSON.stringify(tasks));

            // Also save yesterdayTasks to Firebase
            if (window.AA && AA.auth && AA.auth.currentUser) {
                AA.saveSpoonPlan(AA.auth.currentUser.uid, {
                    tasks: tasks,
                    dailySpoons: totalSpoons,
                    yesterdayTasks: tasks
                }).catch(function(err) {
                    console.warn('[AA] Firebase confirm save failed:', err.message);
                });
            }

            alert('‚úÖ Plan confirmed! Your tasks are ready in Recovery Mode.');
            window.location.href = '/Academic-Allies/modular/components/recovery-mode.html';
        }

        // Cancel plan
        function cancelPlanner() {
            // Revert to original tasks (no save)
            tasks = JSON.parse(JSON.stringify(originalTasks));
            
            // Visual feedback - button blink is in CSS
            const cancelBtn = event.target;
            cancelBtn.style.animation = 'blink 0.3s';
            
            setTimeout(() => {
                window.location.href = '/Academic-Allies/modular/components/recovery-mode.html';
            }, 300);
        }

        // Back to Recovery Mode (same as cancel)
        function backToRecovery() {
            if (confirm('Go back without saving? Any unsaved changes will be lost.')) {
                cancelPlanner();
            }
        }

        // Initialize
        loadSavedData();
        renderTasks();

        // ARIA announcements
        document.addEventListener('DOMContentLoaded', function() {
            // Make sure all interactive elements are keyboard accessible
            document.querySelectorAll('.task-item').forEach(item => {
                item.setAttribute('role', 'listitem');
            });
        });
    </script>
    <!-- Firebase compat CDN ‚Äî for cross-device spoon plan sync -->
    <!-- Claude-credit: moved inside </body> 2026-02-26 (was incorrectly placed after </html>) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="/Academic-Allies/modular/aa-firebase.js?v=20260226e"></script>
<!-- Cache bust #3: 2026-02-18 Bruise - Grok assisted - fixed history expansion -->
<!-- Cache bust #4: 2026-02-18 Bruise - Grok assisted - cleaned DOCTYPE & remnant -->
<!-- Cache bust #5: 2026-02-26 Claude - Firebase sync added -->
</body>
</html>
