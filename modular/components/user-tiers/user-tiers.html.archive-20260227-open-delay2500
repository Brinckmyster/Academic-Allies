<!-- Updated 2026-02-26 by Claude â€” renamed 'admin' tier â†’ 'network-lead', platform role 'admin' â†’ 'backstage-manager' -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Support Network â€” Academic Allies</title>
  <link rel="icon" href="/Academic-Allies/favicon.ico">
  <style>
    body { font-family: 'Atkinson Hyperlegible', Arial, sans-serif; background: #FAFAF9; color: #333; margin: 0; padding: 20px; }
    .page-wrap { max-width: 760px; margin: 0 auto; padding-top: 16px; }
    h1 { color: #4a7f82; font-size: 1.6rem; margin: 0 0 4px; }
    .sub { color: #888; font-size: 0.95rem; margin-bottom: 28px; }

    /* Admin picker (Bruise only) */
    #student-picker-wrap { background: #e8f2f3; border: 1px solid #b2d4d7; border-radius: 10px; padding: 14px 18px; margin-bottom: 24px; display: none; }
    #student-picker-wrap label { font-weight: 600; font-size: 0.9rem; color: #4a7f82; display: block; margin-bottom: 8px; }
    #student-picker { padding: 8px 12px; border: 1px solid #b2d4d7; border-radius: 6px; font-size: 14px; background: #fff; width: 100%; max-width: 340px; }

    /* Network cards */
    #network-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 24px; }
    .network-card {
      background: #fff; border: 1px solid #e1e5e9; border-radius: 10px;
      padding: 14px 18px; display: flex; align-items: center; gap: 14px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .network-card.owner-card { border-color: #4a7f82; background: #f0f8f8; }
    .tier-badge {
      display: inline-block; padding: 3px 10px; border-radius: 20px;
      font-size: 0.78rem; font-weight: 700; color: #fff; white-space: nowrap;
    }
    .badge-owner        { background: #4a7f82; }
    .badge-network-lead { background: #6366f1; }
    .badge-family     { background: #f59e0b; }
    .badge-support    { background: #10b981; }
    .badge-nearby-help { background: #f97316; }

    .card-info { flex: 1; min-width: 0; }
    .card-name { font-weight: 600; font-size: 1rem; color: #222; }
    .card-email { font-size: 0.82rem; color: #888; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .card-desc  { font-size: 0.8rem; color: #aaa; margin-top: 3px; }

    .card-actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
    .tier-select-sm { padding: 5px 8px; border: 1px solid #ccc; border-radius: 6px; font-size: 13px; background: #fff; }
    .btn-save   { padding: 5px 12px; background: #4a7f82; color: #fff; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; }
    .btn-save:hover { background: #3d6e71; }
    .btn-remove { padding: 5px 10px; background: #fff; color: #c0392b; border: 1px solid #e0b4b4; border-radius: 6px; font-size: 13px; cursor: pointer; }
    .btn-remove:hover { background: #fdf2f2; }

    /* Add person panel */
    .add-panel { background: #fff; border: 1px solid #e1e5e9; border-radius: 10px; padding: 18px 20px; }
    .add-panel h3 { margin: 0 0 14px; font-size: 1rem; color: #4a7f82; }
    .add-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .add-row input  { flex: 1; min-width: 180px; padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
    .add-row select { padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; background: #fff; }
    .add-row button { padding: 8px 18px; background: #4a7f82; color: #fff; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; font-weight: 600; }
    .add-row button:hover { background: #3d6e71; }
    #add-status { margin-top: 10px; font-size: 0.88rem; min-height: 18px; }
    #add-status.ok  { color: #10b981; }
    #add-status.err { color: #c0392b; }

    /* Student live-status panel (mirror mode) â€” Added 2026-02-26 by Claude */
    #student-status-panel {
      background: #fff;
      border: 1px solid #e1e5e9;
      border-radius: 10px;
      padding: 14px 18px;
      margin-bottom: 20px;
      display: none;
    }
    #student-status-panel h3 { margin: 0 0 10px; font-size: 0.95rem; color: #4a7f82; }
    .live-status-row {
      display: flex; align-items: center; gap: 12px;
      font-size: 0.9rem; color: #444; margin-bottom: 6px;
    }
    .live-dot {
      width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0;
    }
    .live-dot.nope   { background: #dc3545; animation: pulse-dot 1.4s ease-in-out infinite; }
    .live-dot.red    { background: #dc3545; }
    .live-dot.orange { background: #fd7e14; }
    .live-dot.yellow { background: #ffc107; }
    .live-dot.green  { background: #28a745; }
    .live-dot.unknown { background: #ccc; }
    @keyframes pulse-dot {
      0%, 100% { box-shadow: 0 0 0 3px rgba(220,53,69,0.2); }
      50%       { box-shadow: 0 0 0 6px rgba(220,53,69,0.08); }
    }

    /* Mirror mode banner */
    #mirror-banner {
      display: none;
      background: linear-gradient(135deg, #e8eeff 0%, #f0f4ff 100%);
      border: 2px solid #a5b4fc;
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 24px;
    }
    #mirror-banner .mirror-icon { font-size: 2rem; float: left; margin-right: 14px; line-height: 1; }
    #mirror-banner h2 { margin: 0 0 4px; font-size: 1.1rem; color: #4338ca; }
    #mirror-banner p  { margin: 0; font-size: 0.88rem; color: #6366f1; }
    .mirror-mode h1   { color: #6366f1; }
    .mirror-mode .sub { color: #818cf8; }

    /* State messages */
    #loading-msg, #signin-msg { text-align: center; padding: 40px; color: #aaa; font-size: 1rem; }

    /* â”€â”€ Invite generator (student-only) â”€â”€ Added 2026-02-26 by Claude â”€â”€ */
    #invite-section { margin-top: 16px; }
    .invite-panel { background: #fff; border: 1px solid #e1e5e9; border-radius: 10px; padding: 18px 20px; }
    .invite-panel h3 { margin: 0 0 14px; font-size: 1rem; color: #4a7f82; }
    .invite-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .invite-row select { padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; background: #fff; }
    .invite-row button { padding: 8px 18px; background: #6366f1; color: #fff; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; font-weight: 600; }
    .invite-row button:hover { background: #4f46e5; }
    #invite-result { margin-top: 14px; display: none; }
    .code-display {
      font-family: 'Courier New', monospace; font-size: 2rem; font-weight: 700;
      letter-spacing: 0.18em; color: #4a7f82;
      background: #f0f8f8; border: 2px dashed #b2d4d7; border-radius: 8px;
      padding: 12px 20px; display: inline-block; margin-bottom: 10px;
    }
    .code-meta { font-size: 0.85rem; color: #888; margin-bottom: 10px; }
    .btn-copy { padding: 7px 16px; background: #10b981; color: #fff; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; font-weight: 600; margin-right: 8px; }
    .btn-copy:hover { background: #059669; }

    /* Redeem invite code (existing users) â€” Added 2026-02-26 by Claude */
    #redeem-section { margin-top: 16px; }
    .redeem-panel { background: #fff; border: 1px solid #e1e5e9; border-radius: 10px; padding: 18px 20px; }
    .redeem-panel h3 { margin: 0 0 8px; font-size: 1rem; color: #4a7f82; }
    .redeem-panel p  { margin: 0 0 12px; font-size: 0.88rem; color: #888; }
    .redeem-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .redeem-row input  { flex: 1; min-width: 140px; padding: 8px 12px; border: 2px solid #b2d4d7;
      border-radius: 6px; font-size: 1.2rem; font-family: 'Courier New', monospace; font-weight: 700;
      text-align: center; letter-spacing: 0.12em; color: #4a7f82; text-transform: uppercase; }
    .redeem-row button { padding: 8px 18px; background: #6366f1; color: #fff; border: none;
      border-radius: 6px; font-size: 14px; cursor: pointer; font-weight: 600; }
    .redeem-row button:hover { background: #4f46e5; }
    #redeem-status { margin-top: 10px; font-size: 0.88rem; min-height: 18px; }
    #redeem-status.ok  { color: #10b981; }
    #redeem-status.err { color: #c0392b; }

    /* â”€â”€ Student Profile Panel â”€â”€ Added 2026-02-26 by Claude â”€â”€ */
    #profile-section { margin-top: 20px; }
    .profile-panel { background: #fff; border: 1px solid #e1e5e9; border-radius: 10px; padding: 18px 20px; }
    .profile-panel h3 { margin: 0 0 16px; font-size: 1rem; color: #4a7f82; }
    .profile-block { margin-bottom: 18px; padding-bottom: 18px; border-bottom: 1px solid #f0f0f0; }
    .profile-block:last-of-type { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .profile-label { display: block; font-weight: 600; font-size: 0.85rem; color: #666; margin-bottom: 8px; }
    .profile-empty { color: #aaa; font-size: 0.88rem; font-style: italic; }
    /* Condition tags */
    .p-tag { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px;
      background: #e8f2f3; color: #4a7f82; border-radius: 20px; font-size: 0.82rem; font-weight: 600; margin: 3px; }
    .p-tag .p-tag-x { cursor: pointer; margin-left: 2px; }
    .p-tag.sugg { background: #f8f9fa; color: #888; cursor: pointer; border: 1px dashed #ccc; }
    .p-tag.sugg:hover { background: #e8f2f3; color: #4a7f82; border-color: #4a7f82; }
    /* Module toggles */
    .mod-grid { display: flex; flex-wrap: wrap; gap: 8px; }
    .mod-chip { display: inline-flex; align-items: center; gap: 6px; padding: 7px 13px;
      border: 1px solid #e1e5e9; border-radius: 8px; font-size: 0.85rem; cursor: pointer;
      user-select: none; transition: all 0.15s; }
    .mod-chip.on  { background: #e8f2f3; border-color: #4a7f82; color: #4a7f82; font-weight: 600; }
    .mod-chip.off { background: #f8f9fa; color: #aaa; }
    .mod-badge    { padding: 3px 10px; border-radius: 6px; font-size: 0.82rem; font-weight: 600; margin: 2px; }
    .mod-badge.on { background: #e8f2f3; color: #4a7f82; }
    .mod-badge.off{ background: #f0f0f0; color: #aaa; text-decoration: line-through; }
    /* Prompt list */
    .prompt-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .prompt-row input { flex: 1; padding: 7px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 13px; }
    .prompt-row .btn-px { padding: 5px 10px; background: #fff; color: #c0392b; border: 1px solid #e0b4b4; border-radius: 6px; font-size: 12px; cursor: pointer; }
    /* Notes textarea */
    #profile-notes-edit { width: 100%; box-sizing: border-box; padding: 8px 12px; border: 1px solid #ccc;
      border-radius: 6px; font-size: 14px; min-height: 80px; font-family: inherit; resize: vertical; }

    /* Pending invites list */
    #pending-section { margin-top: 16px; display: none; }
    #pending-section h3 { margin: 0 0 10px; font-size: 0.95rem; color: #888; }
    .pending-card {
      background: #fff; border: 1px solid #e1e5e9; border-radius: 8px;
      padding: 12px 16px; display: flex; align-items: center; gap: 12px; margin-bottom: 8px;
    }
    .pending-code { font-family: 'Courier New', monospace; font-size: 1.2rem; font-weight: 700; letter-spacing: 0.12em; color: #6366f1; flex-shrink: 0; }
    .pending-info { flex: 1; font-size: 0.85rem; color: #888; }
    .pending-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; color: #fff; margin-right: 6px; }
    .btn-revoke { padding: 5px 12px; background: #fff; color: #c0392b; border: 1px solid #e0b4b4; border-radius: 6px; font-size: 12px; cursor: pointer; flex-shrink: 0; }
    .btn-revoke:hover { background: #fdf2f2; }
  </style>
</head>
<body>
  <div id="site-header"></div>

  <div class="page-wrap">
    <h1 id="page-title">ğŸ‘¥ My Support Network</h1>
    <p class="sub" id="page-sub">You're the boss â€” assign who can see your info and how much they can help.</p>

    <!-- Student live-status panel (shown in mirror mode) â€” Added 2026-02-26 by Claude -->
    <div id="student-status-panel">
      <h3>ğŸ“Š <span id="ssp-student-name">Student</span>'s Live Status</h3>
      <div class="live-status-row">
        <span class="live-dot unknown" id="ssp-dot"></span>
        <span id="ssp-status">Loadingâ€¦</span>
      </div>
      <div style="font-size:0.8rem;color:#aaa;" id="ssp-detail"></div>
    </div>

    <!-- Mirror mode banner (non-student roles) -->
    <div id="mirror-banner">
      <span class="mirror-icon">ğŸª</span>
      <h2 id="mirror-title">You're in Mirror View</h2>
      <p id="mirror-desc">You have read-only access to the networks you're part of. The student controls their own network.</p>
      <div style="clear:both;"></div>
    </div>

    <!-- Platform admin: pick which student's network to manage -->
    <div id="student-picker-wrap">
      <label for="student-picker">âš™ï¸ Editing network on behalf of:</label>
      <select id="student-picker" onchange="switchStudent(this.value)">
        <option value="">â€” select a student â€”</option>
      </select>
    </div>

    <div id="loading-msg">Loading your networkâ€¦</div>
    <div id="signin-msg" style="display:none;">Please sign in to manage your support network.</div>

    <!-- Network member cards -->
    <div id="network-list" style="display:none;"></div>

    <!-- Add someone (email lookup â€” kept for admin or when invitee already has account) -->
    <div class="add-panel" id="add-panel" style="display:none;">
      <h3>â• Add someone (already has an account)</h3>
      <div class="add-row">
        <input type="email" id="add-email" placeholder="their-email@example.com">
        <select id="add-tier">
          <option value="nearby-help">Nearby Help</option>
          <option value="family">Family</option>
          <option value="support">Support</option>
          <option value="network-lead">Network Lead</option>
        </select>
        <button onclick="addMember()">Add</button>
      </div>
      <div id="add-status"></div>
    </div>

    <!-- Redeem an invite code (any signed-in user, always accessible) -->
    <!-- Added 2026-02-26 by Claude -->
    <div id="redeem-section" style="display:none;">
      <div class="redeem-panel">
        <h3>ğŸ« Have an invite code?</h3>
        <p>A student shared a code with you â€” enter it here to join their support network.</p>
        <div class="redeem-row">
          <input type="text" id="redeem-code-input" maxlength="8" autocomplete="off"
            placeholder="e.g. XK9P2M"
            oninput="this.value=this.value.toUpperCase().replace(/[^A-Z2-9]/g,'')"
            onkeydown="if(event.key==='Enter')redeemCode()">
          <button onclick="redeemCode()">Redeem</button>
        </div>
        <div id="redeem-status"></div>
      </div>
    </div>

    <!-- Invite someone new (generates a code â€” student-only, hidden in mirror mode) -->
    <!-- Added 2026-02-26 by Claude -->
    <div id="invite-section" style="display:none;">
      <div class="invite-panel">
        <h3>ğŸ« Invite Someone New</h3>
        <p style="margin:0 0 12px;font-size:0.88rem;color:#888;">Generate a 7-day invite code. They download the app, sign in, and enter the code â€” no admin needed.</p>
        <div class="invite-row">
          <select id="invite-role">
            <option value="nearby-help">Nearby Help</option>
            <option value="family">Family</option>
            <option value="support">Support</option>
            <option value="network-lead">Network Lead (my network manager)</option>
          </select>
          <button onclick="generateInvite()">Generate Code</button>
        </div>
        <div id="invite-result">
          <div style="margin-top:14px;">
            <div class="code-display" id="invite-code-display"></div>
          </div>
          <div class="code-meta" id="invite-code-meta"></div>
          <button class="btn-copy" onclick="copyCode()">ğŸ“‹ Copy Code</button>
          <span id="copy-confirm" style="font-size:0.85rem;color:#10b981;display:none;">âœ“ Copied!</span>
        </div>
      </div>

      <!-- Pending invites list -->
      <div id="pending-section">
        <h3>â³ Pending Invites</h3>
        <div id="pending-list"></div>
      </div>
    </div>

    <!-- Student Profile Panel â€” Added 2026-02-26 by Claude
         Shown after network cards for student, network-lead, and backstage-manager.
         Network Lead can edit via narrow Firestore rule. Others read-only. -->
    <div id="profile-section" style="display:none;">
      <div class="profile-panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h3 style="margin:0;">ğŸ“‹ Student Profile</h3>
          <div id="profile-header-btns" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <button id="profile-edit-btn" onclick="enableProfileEdit()"
              style="display:none;padding:5px 14px;background:#fff;color:#4a7f82;border:1px solid #b2d4d7;border-radius:6px;font-size:13px;cursor:pointer;">âœï¸ Edit Profile</button>
            <!-- Claude: AI dropdown â€” 2026-02-27 -->
            <span id="profile-ai-btn" style="display:none;gap:4px;align-items:center;">
              <select id="profile-ai-select" style="font-size:13px;border:1px solid #c9b8e8;border-radius:6px;padding:4px 6px;font-family:inherit;">
                <option value="https://claude.ai/new">Claude</option>
                <option value="https://chatgpt.com">ChatGPT</option>
                <option value="https://gemini.google.com">Gemini</option>
                <option value="https://grok.com">Grok</option>
                <option value="https://copilot.microsoft.com">Copilot</option>
                <option value="https://perplexity.ai">Perplexity</option>
                <option value="https://meta.ai">Meta AI</option>
              </select>
              <button onclick="getAISuggestions()" style="padding:5px 14px;background:#fff;color:#7c5cbf;border:1px solid #c9b8e8;border-radius:6px;font-size:13px;cursor:pointer;">ğŸ¤– Get AI Suggestions</button>
            </span>
            <!-- Claude: paste hint â€” 2026-02-27 -->
            <span id="profile-ai-copied" style="display:none;font-size:13px;color:#7c5cbf;font-weight:600;">âœ… Prompt copied! Just paste it (Ctrl+V) when the AI tab opens.</span>
            <span id="profile-save-btns" style="display:none;gap:8px;">
              <button onclick="saveProfile()" class="btn-save">Save</button>
              <button onclick="cancelProfileEdit()"
                style="padding:5px 12px;background:#fff;color:#888;border:1px solid #ddd;border-radius:6px;font-size:13px;cursor:pointer;">Cancel</button>
            </span>
          </div>
        </div>

        <!-- Conditions -->
        <div class="profile-block">
          <label class="profile-label">ğŸ·ï¸ Conditions / Context</label>
          <div id="profile-cond-view"></div>
          <div id="profile-cond-edit" style="display:none;">
            <div id="profile-tag-list"></div>
            <div style="display:flex;gap:8px;margin-top:8px;">
              <input id="profile-tag-input" type="text" placeholder="Type a condition and press Add"
                style="flex:1;padding:6px 10px;border:1px solid #ccc;border-radius:6px;font-size:13px;"
                onkeydown="if(event.key==='Enter')addConditionTag()">
              <button onclick="addConditionTag()"
                style="padding:6px 14px;background:#4a7f82;color:#fff;border:none;border-radius:6px;font-size:13px;cursor:pointer;">+ Add</button>
            </div>
            <div id="profile-tag-suggestions" style="margin-top:10px;"></div>
          </div>
        </div>

        <!-- Notes -->
        <div class="profile-block">
          <label class="profile-label">ğŸ“ Notes for Support Network</label>
          <div id="profile-notes-view"></div>
          <textarea id="profile-notes-edit" style="display:none;"
            placeholder="Context about this student's needs, current situation, what the support network should knowâ€¦"></textarea>
        </div>

        <!-- Active Modules -->
        <div class="profile-block">
          <label class="profile-label">ğŸ§© Active App Modules</label>
          <div id="profile-mods-view" class="mod-grid"></div>
          <div id="profile-mods-edit" class="mod-grid" style="display:none;"></div>
        </div>

        <!-- Custom Check-in Prompts -->
        <div class="profile-block">
          <label class="profile-label">âœï¸ Custom Check-in Prompts</label>
          <div id="profile-prompts-view"></div>
          <div id="profile-prompts-edit" style="display:none;">
            <div id="profile-prompt-list"></div>
            <button onclick="addPrompt()"
              style="margin-top:8px;padding:6px 14px;background:#fff;color:#4a7f82;border:1px solid #b2d4d7;border-radius:6px;font-size:13px;cursor:pointer;">+ Add Prompt</button>
          </div>
        </div>

        <div id="profile-status" style="font-size:0.85rem;min-height:18px;margin-top:4px;"></div>
        <div id="profile-updated-by" style="font-size:0.75rem;color:#aaa;margin-top:4px;"></div>
      </div>
    </div>

  </div>

  <!-- Load shared header -->
  <script>
    fetch('/Academic-Allies/modular/shared-header.html?v=20260226b')
      .then(function(r) { return r.text(); })
      .then(function(html) {
        var c = document.getElementById('site-header');
        c.innerHTML = html;
        c.querySelectorAll('script').forEach(function(old) {
          var s = document.createElement('script');
          Array.from(old.attributes).forEach(function(a) { s.setAttribute(a.name, a.value); });
          s.textContent = old.textContent;
          old.replaceWith(s);
        });
      });
  </script>

  <script>
    /* â”€â”€ Tier display metadata â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var TIERS = {
      'network-lead': { label: 'Network Lead', badge: 'badge-network-lead', desc: 'Trusted support â€” can help manage your data' },
      'family':      { label: 'Family',        badge: 'badge-family',      desc: 'View logs and send messages' },
      'support':     { label: 'Support',       badge: 'badge-support',     desc: 'School staff / counselor â€” read-only' },
      'nearby-help': { label: 'Nearby Help',   badge: 'badge-nearby-help', desc: 'Local friend for emergency alerts' }
    };

    /* Which student's network we're currently viewing/editing */
    var currentStudentUid  = null;
    var currentStudentName = null;
    var isPlatformAdmin       = false;
    var isMirrorMode          = false;   // true when viewing someone else's network read-only
    var isNetworkLeadMode     = false;   // true when network-lead is viewing their student
    var isViewingOtherStudent = false;   // true when a student is mirroring another student

    /* Non-student, non-admin roles get mirror (read-only) view.
       network-lead is handled separately (can edit studentProfile).
       Student = sudo (owns their network).
       Admin = can edit on behalf of a student, but student can always override. */
    var MIRROR_ROLES = ['support', 'family', 'nearby-help'];

    /* â”€â”€ Wait for AA to be ready, then boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function waitForAA(cb, tries) {
      tries = tries || 0;
      if (window.AA && window.AA.auth) { cb(); return; }
      if (tries > 40) { showError('Could not connect to Firebase.'); return; }
      setTimeout(function() { waitForAA(cb, tries + 1); }, 200);
    }

    function boot() {
      AA.auth.onAuthStateChanged(function(user) {
        if (!user) {
          document.getElementById('loading-msg').style.display = 'none';
          document.getElementById('signin-msg').style.display  = 'block';
          return;
        }

        /* User IS signed in â€” immediately hide "Please sign in" message.
           Firebase fires onAuthStateChanged with null first while restoring
           auth from cache, then fires again with the user. Without this line
           the signin-msg would stay visible even after the user is resolved.
           Fixed 2026-02-20 by Claude */
        document.getElementById('signin-msg').style.display  = 'none';
        document.getElementById('loading-msg').style.display = 'block';
        document.getElementById('loading-msg').textContent   = 'Loading your networkâ€¦';

        /* Check platform role */
        AA.getUserDoc(user.uid).then(function(doc) {
          if (!doc.exists) { showError('Your profile isn\'t set up yet â€” try signing out and back in.'); return; }
          var data = doc.data();
          isPlatformAdmin = (data.role === 'backstage-manager');

          /* Show redeem-code panel for everyone except platform admin
             (admin has no need to join a network via invite code).
             Added 2026-02-26 by Claude */
          if (!isPlatformAdmin) {
            document.getElementById('redeem-section').style.display = 'block';
          }

          if (data.role === 'student') {
            /* Student = sudo over their OWN network.
               But if a ?student=uid param points to someone else, check whether
               the signed-in student is in that person's supportNetwork.
               If yes â†’ mirror mode for that student's network.
               Updated 2026-02-19 by Claude */
            var params    = new URLSearchParams(window.location.search);
            var targetUid = params.get('student');

            if (targetUid && targetUid !== user.uid) {
              /* Visiting another student's network via link */
              AA.getUserDoc(targetUid).then(function(targetDoc) {
                if (!targetDoc.exists) {
                  showError('That student profile wasn\'t found.');
                  return;
                }
                var targetData = targetDoc.data();
                var network    = targetData.supportNetwork || {};

                if (network[user.uid]) {
                  /* They ARE in this student's network â†’ mirror/read-only */
                  isMirrorMode          = true;
                  isViewingOtherStudent = true;
                  activateMirrorBanner('nearby-help', data.displayName || user.displayName || 'You');
                  document.getElementById('loading-msg').style.display = 'none';
                  loadNetwork(targetUid, targetData.displayName || targetData.email);
                } else {
                  showError('You\'re not in ' + esc(targetData.displayName || 'that student') + '\'s support network yet â€” ask them to add you.');
                }
              }).catch(function(err) {
                showError('Could not load that network: ' + err.message);
              });
            } else {
              /* Normal: student views their own network */
              loadNetwork(user.uid, data.displayName || user.displayName || 'You');
            }

          } else if (isPlatformAdmin) {
            /* Platform admin = can edit any student's network on their behalf.
               Student always has override power â€” they can change it back. */
            isMirrorMode = false;
            document.getElementById('student-picker-wrap').style.display = 'block';
            loadStudentPicker().then(applyUrlParam);
            activateAdminEditBanner(data.displayName || user.displayName || 'You');
            document.getElementById('loading-msg').style.display = 'none';

          } else if (data.role === 'network-lead') {
            /* Network Lead â†’ mirror for network cards, but CAN edit student profile.
               Added 2026-02-26 by Claude */
            isMirrorMode      = true;
            isNetworkLeadMode = true;
            activateNetworkLeadMode(data.displayName || user.displayName || 'You');

          } else if (MIRROR_ROLES.indexOf(data.role) !== -1) {
            /* Support / Family / Nearby Help â†’ pure read-only mirror */
            isMirrorMode = true;
            activateMirrorMode(data.role, data.displayName || user.displayName || 'You');
          }
        });
      });
    }

    /* â”€â”€ Mirror mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var MIRROR_LABELS = {
      'backstage-manager': 'Backstage Manager',
      'network-lead': 'Network Lead',
      'support':      'Support Member',
      'family':       'Family Member',
      'nearby-help':  'Nearby Help'
    };

    /* Admin edit mode banner â€” admin can edit on behalf of student */
    function activateAdminEditBanner(name) {
      var banner = document.getElementById('mirror-banner');
      banner.style.background = 'linear-gradient(135deg, #fff7e6 0%, #fffbf0 100%)';
      banner.style.borderColor = '#fbbf24';
      banner.style.display = 'block';
      document.getElementById('mirror-title').style.color = '#b45309';
      document.getElementById('mirror-desc').style.color  = '#92400e';
      document.getElementById('mirror-title').textContent =
        'âš™ï¸ Admin Edit Mode â€” ' + esc(name);
      document.getElementById('mirror-desc').textContent =
        'You can add, remove, or change roles on behalf of a student. ' +
        'The student always has override power and can change their network back.';
    }

    /* Just show the mirror banner (read-only, for support/family/nearby-help) */
    function activateMirrorBanner(role, name) {
      var label = MIRROR_LABELS[role] || role;
      document.querySelector('.page-wrap').classList.add('mirror-mode');
      document.getElementById('page-title').textContent = 'ğŸª Network Mirror';
      document.getElementById('page-sub').textContent   = 'Read-only view â€” the student is sudo and controls their own network.';
      var banner = document.getElementById('mirror-banner');
      banner.style.display = 'block';
      document.getElementById('mirror-title').textContent =
        'You\'re signed in as ' + esc(name) + ' (' + label + ')';
      document.getElementById('mirror-desc').textContent =
        'Students own their support networks. You can view any network but cannot add, remove, or change roles.';
    }

    /* Network Lead mode: mirror for network cards, profile edit enabled.
       Added 2026-02-26 by Claude */
    function activateNetworkLeadMode(name) {
      /* Distinct green banner â€” different from purple mirror */
      document.querySelector('.page-wrap').classList.add('mirror-mode');
      document.getElementById('page-title').textContent = 'ğŸŒŸ Network Lead View';
      document.getElementById('page-sub').textContent   =
        'You can view the support network and edit the student profile. The student controls who is in the network.';
      var banner = document.getElementById('mirror-banner');
      banner.style.background   = 'linear-gradient(135deg,#e6f4ea 0%,#f0faf2 100%)';
      banner.style.borderColor  = '#6abf7b';
      banner.style.display      = 'block';
      document.getElementById('mirror-title').style.color = '#2d6a4f';
      document.getElementById('mirror-desc').style.color  = '#40916c';
      document.getElementById('mirror-title').textContent = 'ğŸŒŸ Network Lead â€” ' + esc(name);
      document.getElementById('mirror-desc').textContent  =
        'You can read the support network and edit this student\'s profile ' +
        '(conditions, active modules, check-in prompts). ' +
        'The student owns the network â€” they control who is in it.';

      document.getElementById('loading-msg').textContent = 'Finding your studentâ€¦';

      AA.db.collection('users').get().then(function (snap) {
        var uid   = AA.auth.currentUser.uid;
        var found = [];
        snap.forEach(function (doc) {
          var d = doc.data();
          if (d.supportNetwork && d.supportNetwork[uid] === 'network-lead') {
            found.push({ uid: doc.id, data: d });
          }
        });

        if (found.length === 0) {
          document.getElementById('loading-msg').textContent =
            'You\'re not yet the Network Lead for any student. Ask the student to invite you via the invite code system.';
          return;
        }

        document.getElementById('loading-msg').style.display = 'none';
        found.forEach(function (s) {
          loadNetwork(s.uid, s.data.displayName || s.data.email);
        });
      }).catch(function (err) {
        showError('Could not load your student\'s network: ' + err.message);
      });
    }

    /* Full mirror mode: show banner + auto-find which student(s) this person belongs to */
    function activateMirrorMode(role, name) {
      activateMirrorBanner(role, name);

      /* Try to find which student(s) this person is in the network of */
      document.getElementById('loading-msg').textContent = 'Finding your network connectionsâ€¦';

      AA.db.collection('users').get().then(function(snap) {
        var uid    = AA.auth.currentUser.uid;
        var found  = [];
        snap.forEach(function(doc) {
          var d = doc.data();
          if (d.supportNetwork && d.supportNetwork[uid]) {
            found.push({ uid: doc.id, data: d, tier: d.supportNetwork[uid] });
          }
        });

        if (found.length === 0) {
          document.getElementById('loading-msg').textContent =
            'You\'re not currently part of any student\'s support network. ' +
            'Ask your student to add you at this page.';
          return;
        }

        /* Show each student's network in read-only mode */
        document.getElementById('loading-msg').style.display = 'none';
        found.forEach(function(s) {
          loadNetwork(s.uid, s.data.displayName || s.data.email);
        });
      }).catch(function(err) {
        showError('Could not load network connections: ' + err.message);
      });
    }

    /* â”€â”€ Admin: load student picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function loadStudentPicker() {
      return AA.getAllStudents().then(function(students) {
        var sel = document.getElementById('student-picker');
        students.forEach(function(s) {
          var opt = document.createElement('option');
          opt.value       = s.uid;
          opt.textContent = (s.data.displayName || s.data.email) + ' â€” ' + s.data.email;
          sel.appendChild(opt);
        });
      });
    }

    function switchStudent(uid) {
      if (!uid) {
        document.getElementById('network-list').style.display = 'none';
        document.getElementById('add-panel').style.display    = 'none';
        return;
      }
      AA.getUserDoc(uid).then(function(doc) {
        if (!doc.exists) return;
        var d = doc.data();
        loadNetwork(uid, d.displayName || d.email);
      });
    }

    /* â”€â”€ Load and render a student's network â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function loadNetwork(studentUid, studentName) {
      currentStudentUid  = studentUid;
      currentStudentName = studentName;
      document.getElementById('loading-msg').style.display = 'block';
      document.getElementById('network-list').style.display = 'none';
      document.getElementById('add-panel').style.display    = 'none';
      /* Show live status panel in mirror mode â€” Added 2026-02-26 by Claude */
      if (isMirrorMode) { loadStudentStatus(studentUid, studentName); }

      AA.getUserDoc(studentUid).then(function(doc) {
        if (!doc.exists) { showError('No profile found.'); return; }
        var data    = doc.data();
        var network = data.supportNetwork || {};

        /* Collect member uids to look up */
        var memberUids = Object.keys(network);

        /* Fetch display names for all members */
        var fetches = memberUids.map(function(uid) {
          return AA.getUserDoc(uid).then(function(d) {
            return { uid: uid, tier: network[uid], data: d.exists ? d.data() : null };
          });
        });

        Promise.all(fetches).then(function(members) {
          renderNetwork(studentUid, studentName, members);
        });
      }).catch(function(err) {
        showError('Error loading network: ' + err.message);
      });
    }

    /* â”€â”€ Render the network list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* Updated 2026-02-19 by Claude â€” owner card "(You)" only when it IS you;
       boss mode adds "ğŸ‘ View Dashboard" link to each member card. */
    function renderNetwork(studentUid, studentName, members) {
      var list = document.getElementById('network-list');
      list.innerHTML = '';

      var isOwnNetwork = (studentUid === AA.auth.currentUser.uid);

      /* Owner card â€” always first */
      var ownerCard = document.createElement('div');
      ownerCard.className = 'network-card owner-card';
      ownerCard.innerHTML =
        '<span class="tier-badge badge-owner">Owner</span>' +
        '<div class="card-info">' +
          '<div class="card-name">' + esc(studentName) + (isOwnNetwork ? ' (You)' : '') + '</div>' +
          '<div class="card-desc">' + (isOwnNetwork ? 'Full control â€” this is your network' : 'Student â€” controls their own network') + '</div>' +
        '</div>';
      list.appendChild(ownerCard);

      /* Member cards */
      members.forEach(function(m) {
        var tierInfo = TIERS[m.tier] || { label: m.tier, badge: 'badge-support', desc: '' };
        var name  = m.data ? (m.data.displayName || m.data.email) : '(unknown user)';
        var email = m.data ? m.data.email : m.uid;

        var card = document.createElement('div');
        card.className = 'network-card';
        card.id = 'card-' + m.uid;

        /* Build tier selector */
        var tierOpts = Object.keys(TIERS).map(function(t) {
          return '<option value="' + t + '"' + (t === m.tier ? ' selected' : '') + '>' + TIERS[t].label + '</option>';
        }).join('');

        /* Mirror mode: read-only label + "ğŸ‘ View Dashboard" link
           Boss mode:   full edit controls + "ğŸ‘ View Dashboard" link */
        var viewBtn = '<a href="user-tiers.html?student=' + m.uid + '" ' +
          'style="font-size:12px;color:#4a7f82;text-decoration:none;border:1px solid #b2d4d7;' +
          'border-radius:5px;padding:4px 9px;white-space:nowrap;" title="View their dashboard">ğŸ‘ View</a>';

        var actionsHtml = isMirrorMode
          ? '<div class="card-actions"><span style="font-size:12px;color:#818cf8;">read-only</span></div>'
          : '<div class="card-actions">' +
              viewBtn +
              '<select class="tier-select-sm" id="tier-' + m.uid + '" onchange="updateBadge(\'' + m.uid + '\', this.value)">' +
                tierOpts +
              '</select>' +
              '<button class="btn-save" onclick="saveTier(\'' + m.uid + '\')">Save</button>' +
              '<button class="btn-remove" onclick="removeMember(\'' + m.uid + '\', \'' + esc(name) + '\')">Remove</button>' +
            '</div>';

        card.innerHTML =
          '<span class="tier-badge ' + tierInfo.badge + '">' + tierInfo.label + '</span>' +
          '<div class="card-info">' +
            '<div class="card-name">' + esc(name) + '</div>' +
            '<div class="card-email">' + esc(email) + '</div>' +
            '<div class="card-desc">' + tierInfo.desc + '</div>' +
          '</div>' +
          actionsHtml;

        list.appendChild(card);
      });

      document.getElementById('loading-msg').style.display  = 'none';
      list.style.display                                      = 'flex';
      /* Only show Add / Invite panels if the viewer is the student (boss controls) */
      if (!isMirrorMode) {
        document.getElementById('add-panel').style.display = 'block';
      }
      /* Invite section: only for the student viewing their OWN network */
      var inviteSection = document.getElementById('invite-section');
      var isOwnNetworkEdit = !isMirrorMode && studentUid === AA.auth.currentUser.uid;
      inviteSection.style.display = isOwnNetworkEdit ? 'block' : 'none';
      if (isOwnNetworkEdit) { loadPendingInvites(); }

      /* Profile panel: visible to student, network-lead, and backstage-manager.
         Editable by student + network-lead + backstage-manager; read-only for others.
         Added 2026-02-26 by Claude */
      var canEditProfile = !isMirrorMode || isNetworkLeadMode || isPlatformAdmin;
      loadProfilePanel(studentUid, canEditProfile);
    }

    /* Update the badge color live when tier dropdown changes */
    function updateBadge(memberUid, newTier) {
      var card = document.getElementById('card-' + memberUid);
      if (!card) return;
      var badge    = card.querySelector('.tier-badge');
      var descEl   = card.querySelector('.card-desc');
      var tierInfo = TIERS[newTier] || { label: newTier, badge: 'badge-support', desc: '' };
      badge.className   = 'tier-badge ' + tierInfo.badge;
      badge.textContent = tierInfo.label;
      if (descEl) descEl.textContent = tierInfo.desc;
    }

    /* Save a tier change */
    function saveTier(memberUid) {
      var sel  = document.getElementById('tier-' + memberUid);
      var tier = sel ? sel.value : null;
      if (!tier || !currentStudentUid) return;
      AA.setNetworkMember(currentStudentUid, memberUid, tier)
        .then(function() { flashSaved(memberUid); })
        .catch(function(err) { alert('Save failed: ' + err.message); });
    }

    function flashSaved(memberUid) {
      var btn = document.querySelector('#card-' + memberUid + ' .btn-save');
      if (!btn) return;
      var orig = btn.textContent;
      btn.textContent = 'âœ“ Saved';
      btn.style.background = '#10b981';
      setTimeout(function() { btn.textContent = orig; btn.style.background = ''; }, 1800);
    }

    /* Remove a member */
    function removeMember(memberUid, name) {
      if (!confirm('Remove ' + name + ' from your support network?')) return;
      AA.removeNetworkMember(currentStudentUid, memberUid)
        .then(function() { loadNetwork(currentStudentUid, currentStudentName); })
        .catch(function(err) { alert('Remove failed: ' + err.message); });
    }

    /* â”€â”€ Add a new member â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function addMember() {
      var emailInput = document.getElementById('add-email');
      var tierSelect = document.getElementById('add-tier');
      var status     = document.getElementById('add-status');
      var email      = emailInput.value.trim().toLowerCase();
      var tier       = tierSelect.value;

      status.className = '';
      status.textContent = '';

      if (!email) { setStatus('err', 'Please enter an email address.'); return; }
      if (!currentStudentUid) { setStatus('err', 'No student selected.'); return; }

      setStatus('', 'Looking up ' + email + 'â€¦');

      AA.lookupUserByEmail(email).then(function(result) {
        if (!result) {
          setStatus('err', 'âŒ No Academic Allies account found for ' + email + '. They need to sign in at least once first.');
          return;
        }
        if (result.uid === currentStudentUid) {
          setStatus('err', 'âŒ You can\'t add yourself â€” you\'re already the owner!');
          return;
        }
        return AA.setNetworkMember(currentStudentUid, result.uid, tier)
          .then(function() {
            setStatus('ok', 'âœ… ' + (result.data.displayName || email) + ' added as ' + TIERS[tier].label + '!');
            emailInput.value = '';
            loadNetwork(currentStudentUid, currentStudentName);
          });
      }).catch(function(err) {
        setStatus('err', 'âŒ Error: ' + err.message);
      });
    }

    function setStatus(cls, msg) {
      var s = document.getElementById('add-status');
      s.className   = cls;
      s.textContent = msg;
    }

    function showError(msg) {
      document.getElementById('loading-msg').textContent = msg;
    }

    /* HTML escape helper */
    function esc(str) {
      return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    /* If platform admin arrived via ?student=uid link, auto-select that student.
       (Students handle the same URL param in their own boot branch above.)
       Updated 2026-02-19 by Claude */
    function applyUrlParam() {
      var params = new URLSearchParams(window.location.search);
      var uid    = params.get('student');
      if (!uid || !isPlatformAdmin) return;
      var sel = document.getElementById('student-picker');
      if (sel) { sel.value = uid; switchStudent(uid); }
    }

    /* â”€â”€ Student live-status panel (mirror mode) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Reads the student's NOPE status and today's check-in from Firestore
       and populates the #student-status-panel shown in mirror mode.
       Added 2026-02-26 by Claude
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function loadStudentStatus(studentUid, studentName) {
      var panel = document.getElementById('student-status-panel');
      if (!panel) return;
      document.getElementById('ssp-student-name').textContent = studentName || 'Student';
      panel.style.display = 'block';

      var today = new Date().toISOString().split('T')[0];

      var nopeP    = AA.db.collection('nope').doc(studentUid).get();
      var checkinP = AA.db.collection('checkins').doc(studentUid)
        .collection('days').doc(today).get();

      Promise.all([nopeP, checkinP]).then(function (results) {
        var nopeDoc    = results[0];
        var checkinDoc = results[1];
        var dot    = document.getElementById('ssp-dot');
        var status = document.getElementById('ssp-status');
        var detail = document.getElementById('ssp-detail');

        /* NOPE mode overrides everything */
        var nope = nopeDoc.exists ? nopeDoc.data() : null;
        if (nope && nope.mode === 'nope') {
          dot.className    = 'live-dot nope';
          status.textContent = 'â›” NOPE mode is active â€” Mary has opted out for now';
          detail.textContent = nope.updatedAt && nope.updatedAt.toDate
            ? 'Since ' + nope.updatedAt.toDate().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' })
            : '';
          return;
        }
        if (nope && nope.mode === 'semi-nope') {
          dot.className    = 'live-dot yellow';
          status.textContent = 'ğŸŸ¡ Semi-Nope mode â€” limited availability';
          detail.textContent = nope.updatedAt && nope.updatedAt.toDate
            ? 'Since ' + nope.updatedAt.toDate().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' })
            : '';
          return;
        }

        /* Check-in data for today */
        var entries = checkinDoc.exists ? (checkinDoc.data().entries || []) : [];
        if (entries.length === 0) {
          dot.className    = 'live-dot unknown';
          status.textContent = 'ğŸ“‹ No check-in yet today';
          detail.textContent = 'Page refreshes automatically when a check-in is submitted.';
          return;
        }

        var worst = 'green';
        entries.forEach(function (e) {
          if (e.flag === 'red') worst = 'red';
          else if (e.flag === 'orange' && worst !== 'red') worst = 'orange';
          else if (e.flag === 'yellow' && worst === 'green') worst = 'yellow';
        });

        var lastEntry = entries[entries.length - 1];
        var lastTime  = lastEntry && lastEntry.savedAt
          ? new Date(lastEntry.savedAt).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' })
          : '';

        var statusLabels = {
          red:    'ğŸ”´ Red flag â€” immediate attention may be needed',
          orange: 'ğŸŸ  Orange flag â€” worth checking in',
          yellow: 'ğŸŸ¡ Yellow flag â€” slight concern',
          green:  'ğŸŸ¢ All clear â€” last check-in looks good'
        };
        dot.className      = 'live-dot ' + worst;
        status.textContent = statusLabels[worst] || 'ğŸŸ¢ Checked in';
        detail.textContent = entries.length + ' check-in' + (entries.length === 1 ? '' : 's') +
                             ' today' + (lastTime ? ' Â· last at ' + lastTime : '');
      }).catch(function () {
        document.getElementById('ssp-status').textContent = 'Status unavailable';
      });
    }

    /* â”€â”€ Invite code generator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Added 2026-02-26 by Claude
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var _lastGeneratedCode = null;

    function generateInvite() {
      if (!currentStudentUid) { alert('No student selected.'); return; }
      var role = document.getElementById('invite-role').value;
      AA.createInvite(currentStudentUid, role).then(function(invite) {
        _lastGeneratedCode = invite.code;
        document.getElementById('invite-code-display').textContent = invite.code;
        var exp      = invite.expiresAt && invite.expiresAt.toDate
          ? invite.expiresAt.toDate() : new Date(invite.expiresAt);
        var daysLeft = Math.ceil((exp - Date.now()) / 86400000);
        var roleLabel = TIERS[role] ? TIERS[role].label : role;
        document.getElementById('invite-code-meta').textContent =
          'For: ' + roleLabel + ' Â· Expires in ' + daysLeft + ' days Â· Single use';
        document.getElementById('invite-result').style.display = 'block';
        document.getElementById('copy-confirm').style.display  = 'none';
        loadPendingInvites();
      }).catch(function(err) {
        alert('Could not generate invite: ' + err.message);
      });
    }

    function copyCode() {
      if (!_lastGeneratedCode) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(_lastGeneratedCode).then(function() {
          flashCopied();
        }).catch(fallbackCopy);
      } else {
        fallbackCopy();
      }
    }

    function fallbackCopy() {
      var ta = document.createElement('textarea');
      ta.value = _lastGeneratedCode;
      ta.style.position = 'fixed';
      ta.style.opacity  = '0';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      flashCopied();
    }

    function flashCopied() {
      var c = document.getElementById('copy-confirm');
      c.style.display = 'inline';
      setTimeout(function() { c.style.display = 'none'; }, 2000);
    }

    function loadPendingInvites() {
      if (!currentStudentUid) return;
      AA.getMyInvites(currentStudentUid).then(function(invites) {
        var section = document.getElementById('pending-section');
        var list    = document.getElementById('pending-list');
        if (!invites || invites.length === 0) {
          section.style.display = 'none';
          return;
        }
        list.innerHTML = '';
        invites.forEach(function(inv) {
          var exp      = inv.expiresAt && inv.expiresAt.toDate
            ? inv.expiresAt.toDate() : new Date(inv.expiresAt);
          var daysLeft  = Math.ceil((exp - Date.now()) / 86400000);
          var roleLabel = TIERS[inv.role] ? TIERS[inv.role].label : inv.role;
          var badgeCls  = TIERS[inv.role] ? TIERS[inv.role].badge : 'badge-support';
          var card = document.createElement('div');
          card.className = 'pending-card';
          card.innerHTML =
            '<span class="pending-code">' + esc(inv.code) + '</span>' +
            '<div class="pending-info">' +
              '<span class="pending-badge ' + badgeCls + '">' + esc(roleLabel) + '</span>' +
              'Expires in ' + daysLeft + ' day' + (daysLeft === 1 ? '' : 's') +
            '</div>' +
            '<button class="btn-revoke" onclick="revokeInviteCode(\'' + esc(inv.code) + '\')">Revoke</button>';
          list.appendChild(card);
        });
        section.style.display = 'block';
      }).catch(function(err) {
        console.warn('Could not load pending invites:', err.message);
      });
    }

    /* â”€â”€ Redeem an invite code (existing users) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Any signed-in user can use this to join a student's network after
       they're already in the system â€” e.g. Amanda (already a student)
       getting a nearby-help code from Mary.
       Added 2026-02-26 by Claude
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function redeemCode() {
      var input  = document.getElementById('redeem-code-input');
      var status = document.getElementById('redeem-status');
      var code   = (input.value || '').trim().toUpperCase();
      if (!code || code.length < 6) {
        status.className   = 'err';
        status.textContent = 'Please enter a 6-character code.';
        return;
      }
      status.className   = '';
      status.textContent = 'Checking codeâ€¦';
      input.disabled     = true;

      AA.redeemInvite(code).then(function (result) {
        input.disabled     = false;
        input.value        = '';
        status.className   = 'ok';
        status.textContent = 'âœ… You\'ve been added to ' +
          (result.studentName || 'the student') + '\'s network as ' +
          (result.role || 'a member') + '!';
        /* Reload the page so the newly-joined network appears in mirror view */
        setTimeout(function () { window.location.reload(); }, 1400);
      }).catch(function (err) {
        input.disabled = false;
        status.className   = 'err';
        var msg = err.message || '';
        if (msg.indexOf('not found') !== -1 || msg.indexOf('No invite') !== -1) {
          status.textContent = 'âŒ Code not found â€” double-check it and try again.';
        } else if (msg.indexOf('expired') !== -1) {
          status.textContent = 'âŒ That code has expired. Ask the student to generate a new one.';
        } else if (msg.indexOf('already been used') !== -1) {
          status.textContent = 'âŒ That code has already been used.';
        } else if (msg.indexOf('own invite') !== -1) {
          status.textContent = 'âŒ You can\'t redeem your own invite code.';
        } else {
          status.textContent = 'âŒ ' + msg;
        }
      });
    }

    function revokeInviteCode(code) {
      if (!confirm('Revoke invite code ' + code + '? It will no longer work.')) return;
      AA.revokeInvite(code).then(function() {
        if (_lastGeneratedCode === code) {
          _lastGeneratedCode = null;
          document.getElementById('invite-result').style.display = 'none';
        }
        loadPendingInvites();
      }).catch(function(err) {
        alert('Could not revoke invite: ' + err.message);
      });
    }

    /* â”€â”€ Student Profile Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Added 2026-02-26 by Claude
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var _profileData      = {};
    var _profileCanEdit   = false;
    var _currentConditions = [];
    var _currentPrompts    = [];

    /* Claude-credit: DEFAULT_MODULES expanded + spoonPal restricted to backstage-manager 2026-02-26 */
    var DEFAULT_MODULES = {
      checkin:       { label: 'Check-ins',     icon: 'ğŸ“‹' },
      spoonPlanner:  { label: 'Spoon Planner', icon: 'ğŸ¥„' },
      mealPlan:      { label: 'Meal Plan',     icon: 'ğŸ½ï¸' },
      nope:          { label: 'NOPE Mode',     icon: 'ğŸ›‘' },
      recoveryMode:  { label: 'Recovery Mode', icon: 'ğŸ›Œ' },
      badBrainDay:   { label: 'Bad Brain Day', icon: 'ğŸ§ ' },
      statusCircle:  { label: 'Status Circle', icon: 'ğŸ”µ' },
      messages:      { label: 'Messages',      icon: 'ğŸ’¬' },
      calendar:      { label: 'Calendar',      icon: 'ğŸ“…' }
    };
    /* SpoonPal is Backstage Manager only â€” personal tool, not for general use */
    var BACKSTAGE_ONLY_MODULES = {
      spoonPal: { label: 'SpoonPal (personal)', icon: 'ğŸ¥„' }
    };

    var CONDITION_SUGGESTIONS = [
      'ADHD', 'anxiety', 'autism', 'chronic fatigue', 'chronic pain',
      'concussion', 'depression', 'dysautonomia', 'EDS', 'fibromyalgia',
      'gastroparesis', 'IBS', 'migraines', 'POTS', 'PTSD'
    ];

    function loadProfilePanel(studentUid, canEdit) {
      _profileCanEdit = canEdit;
      var section = document.getElementById('profile-section');
      if (!section) return;
      section.style.display = 'block';

      AA.getStudentProfile(studentUid).then(function (profile) {
        _profileData = profile || {};
        renderProfileView();
        var editBtn = document.getElementById('profile-edit-btn');
        if (editBtn) editBtn.style.display = canEdit ? 'inline-block' : 'none';
        var aiBtn = document.getElementById('profile-ai-btn');
        if (aiBtn) aiBtn.style.display = canEdit ? 'inline-block' : 'none';
      }).catch(function (err) {
        console.warn('[AA] Could not load student profile:', err.message);
      });
    }

    function renderProfileView() {
      var p = _profileData || {};

      /* Conditions */
      var cv = document.getElementById('profile-cond-view');
      if (cv) {
        var conds = p.conditions || [];
        cv.innerHTML = conds.length === 0
          ? '<span class="profile-empty">No conditions listed yet.</span>'
          : conds.map(function (c) {
              return '<span class="p-tag">' + esc(c) + '</span>';
            }).join('');
      }

      /* Notes */
      var nv = document.getElementById('profile-notes-view');
      if (nv) {
        var notes = p.notes || '';
        nv.style.cssText = 'font-size:0.9rem;color:' + (notes ? '#555' : '#aaa') + ';line-height:1.5;white-space:pre-wrap;';
        nv.textContent = notes || 'No notes yet.';
      }

      /* Modules */
      var mv = document.getElementById('profile-mods-view');
      if (mv) {
        var mods = p.activeModules || {};
        var visibleMods = Object.assign({}, DEFAULT_MODULES,
          isPlatformAdmin ? BACKSTAGE_ONLY_MODULES : {});
        mv.innerHTML = Object.keys(visibleMods).map(function (k) {
          var on = mods[k] !== false; /* default ON */
          return '<span class="mod-badge ' + (on ? 'on' : 'off') + '">' +
            visibleMods[k].icon + ' ' + visibleMods[k].label + '</span>';
        }).join('');
      }

      /* Prompts */
      var pv = document.getElementById('profile-prompts-view');
      if (pv) {
        var prompts = p.checkinPrompts || [];
        pv.innerHTML = prompts.length === 0
          ? '<span class="profile-empty">Using default check-in prompts.</span>'
          : '<ol style="margin:0;padding-left:20px;font-size:0.9rem;color:#555;">' +
              prompts.map(function (pr) { return '<li style="margin-bottom:4px;">' + esc(pr) + '</li>'; }).join('') +
            '</ol>';
      }

      /* Updated-by stamp */
      var ub = document.getElementById('profile-updated-by');
      if (ub && p.updatedByName) {
        var when = p.updatedAt && p.updatedAt.toDate
          ? p.updatedAt.toDate().toLocaleDateString() : '';
        ub.textContent = 'Last updated by ' + p.updatedByName + (when ? ' Â· ' + when : '');
      }
    }

    function enableProfileEdit() {
      if (!_profileCanEdit) return;
      var p = _profileData || {};

      /* Switch view â†’ edit */
      document.getElementById('profile-cond-view').style.display   = 'none';
      document.getElementById('profile-cond-edit').style.display   = 'block';
      document.getElementById('profile-notes-view').style.display  = 'none';
      document.getElementById('profile-notes-edit').style.display  = 'block';
      document.getElementById('profile-mods-view').style.display   = 'none';
      document.getElementById('profile-mods-edit').style.display   = 'flex';
      document.getElementById('profile-prompts-view').style.display = 'none';
      document.getElementById('profile-prompts-edit').style.display = 'block';
      document.getElementById('profile-edit-btn').style.display    = 'none';
      document.getElementById('profile-ai-btn').style.display      = 'none';
      document.getElementById('profile-ai-copied').style.display   = 'none';
      document.getElementById('profile-save-btns').style.display   = 'inline-flex';

      /* Populate conditions */
      _currentConditions = (p.conditions || []).slice();
      renderConditionTags();
      renderConditionSuggestions();

      /* Populate notes */
      var ne = document.getElementById('profile-notes-edit');
      if (ne) ne.value = p.notes || '';

      /* Populate modules */
      var me = document.getElementById('profile-mods-edit');
      var mods = p.activeModules || {};
      if (me) {
        var editableMods = Object.assign({}, DEFAULT_MODULES,
          isPlatformAdmin ? BACKSTAGE_ONLY_MODULES : {});
        me.innerHTML = Object.keys(editableMods).map(function (k) {
          var on = mods[k] !== false;
          return '<div class="mod-chip ' + (on ? 'on' : 'off') + '" id="mod-' + k + '" ' +
            'onclick="toggleModule(\'' + k + '\')">' +
            editableMods[k].icon + ' ' + editableMods[k].label + '</div>';
        }).join('');
      }

      /* Populate prompts */
      _currentPrompts = (p.checkinPrompts || []).slice();
      renderPromptList();
    }

    function cancelProfileEdit() {
      document.getElementById('profile-cond-view').style.display   = 'block';
      document.getElementById('profile-cond-edit').style.display   = 'none';
      document.getElementById('profile-notes-view').style.display  = 'block';
      document.getElementById('profile-notes-edit').style.display  = 'none';
      document.getElementById('profile-mods-view').style.display   = 'flex';
      document.getElementById('profile-mods-edit').style.display   = 'none';
      document.getElementById('profile-prompts-view').style.display = 'block';
      document.getElementById('profile-prompts-edit').style.display = 'none';
      document.getElementById('profile-edit-btn').style.display    = 'inline-block';
      document.getElementById('profile-ai-btn').style.display      = 'inline-block';
      document.getElementById('profile-save-btns').style.display   = 'none';
    }

    function saveProfile() {
      if (!currentStudentUid) { alert('No student selected.'); return; }
      /* Gather modules state */
      var activeModules = {};
      Object.keys(DEFAULT_MODULES).forEach(function (k) {
        var el = document.getElementById('mod-' + k);
        activeModules[k] = el ? el.classList.contains('on') : true;
      });
      /* Filter blank prompts */
      var prompts = _currentPrompts.filter(function (pr) { return pr.trim(); });
      var notes   = (document.getElementById('profile-notes-edit').value || '').trim();

      var profile = {
        conditions:     _currentConditions,
        notes:          notes,
        activeModules:  activeModules,
        checkinPrompts: prompts
      };

      var statusEl = document.getElementById('profile-status');
      if (statusEl) { statusEl.style.color = '#888'; statusEl.textContent = 'Savingâ€¦'; }

      AA.saveStudentProfile(currentStudentUid, profile).then(function () {
        _profileData = profile;
        cancelProfileEdit();
        renderProfileView();
        if (statusEl) { statusEl.style.color = '#10b981'; statusEl.textContent = 'âœ… Profile saved!'; }
        setTimeout(function () { if (statusEl) statusEl.textContent = ''; }, 3000);
      }).catch(function (err) {
        if (statusEl) { statusEl.style.color = '#c0392b'; statusEl.textContent = 'âŒ ' + err.message; }
      });
    }

    /* â”€â”€ AI Suggestions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* Claude-credit: getAISuggestions + buildAIPrompt added by Claude (Anthropic) 2026-02-26 */
    function buildAIPrompt() {
      var p    = _profileData || {};
      var name = currentStudentName || 'the student';

      var parts = [];
      parts.push('I\'m a supporter for a student using the Academic Allies app. I need your help suggesting updates to their profile.');
      parts.push('');
      parts.push('Student first name: ' + name);

      var conds = (p.conditions || []);
      if (conds.length > 0) {
        parts.push('Current conditions/context: ' + conds.join(', '));
      } else {
        parts.push('Current conditions/context: (none listed yet)');
      }

      var notes = (p.notes || '').trim();
      if (notes) {
        parts.push('Current notes: ' + notes);
      } else {
        parts.push('Current notes: (none)');
      }

      var mods = p.activeModules || {};
      var allMods = Object.assign({}, DEFAULT_MODULES, isPlatformAdmin ? BACKSTAGE_ONLY_MODULES : {});
      var activeMods   = Object.keys(allMods).filter(function (k) { return mods[k]; });
      var inactiveMods = Object.keys(allMods).filter(function (k) { return !mods[k]; });
      if (activeMods.length > 0) {
        parts.push('Active app modules: ' + activeMods.map(function(k){ return allMods[k].label; }).join(', '));
      }
      if (inactiveMods.length > 0) {
        parts.push('Inactive modules (could be enabled): ' + inactiveMods.map(function(k){ return allMods[k].label; }).join(', '));
      }

      var prompts = (p.checkinPrompts || []);
      if (prompts.length > 0) {
        parts.push('Current custom check-in prompts:');
        prompts.forEach(function (pr, i) { parts.push('  ' + (i + 1) + '. ' + pr); });
      } else {
        parts.push('Current custom check-in prompts: (none)');
      }

      parts.push('');
      parts.push('Based on this profile, please suggest:');
      parts.push('1. Any conditions or context I should add, remove, or update');
      parts.push('2. Which app modules would be most helpful to enable or disable');
      parts.push('3. Better or additional check-in prompts tailored to this student\'s situation');
      parts.push('4. Any notes that would help the support network understand this student\'s current needs');
      parts.push('');
      parts.push('Keep suggestions practical and compassionate. The student has a chronic illness or disability.');

      return parts.join('\n');
    }

    function getAISuggestions() {
      var prompt   = buildAIPrompt();
      var copiedEl = document.getElementById('profile-ai-copied');

      /* Claude: show paste hint immediately, before tab opens â€” 2026-02-27 */
      if (copiedEl) {
        copiedEl.style.display = 'inline';
        setTimeout(function () { copiedEl.style.display = 'none'; }, 8000);
      }

      /* Copy to clipboard */
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(prompt).catch(function () {
          /* Fallback for clipboard failure */
          _aiPromptFallback(prompt);
        });
      } else {
        _aiPromptFallback(prompt);
      }

      /* Claude: 500ms delay so user sees paste hint before tab opens â€” 2026-02-27 */
      var sel = document.getElementById('profile-ai-select');
      var url = sel ? sel.value : 'https://claude.ai/new';
      setTimeout(function () { window.open(url, '_blank'); }, 500);
    }

    function _aiPromptFallback(prompt) {
      /* If clipboard API unavailable, show prompt in a textarea for manual copy */
      var statusEl = document.getElementById('profile-status');
      if (statusEl) {
        statusEl.innerHTML = '<textarea style="width:100%;height:100px;font-size:11px;border:1px solid #c9b8e8;border-radius:6px;padding:6px;" readonly onclick="this.select()">' +
          prompt.replace(/</g,'&lt;').replace(/>/g,'&gt;') +
          '</textarea><span style="color:#7c5cbf;font-size:12px;">Select all and copy, then paste into your AI.</span>';
      }
    }

    /* Condition tag helpers */
    function renderConditionTags() {
      var list = document.getElementById('profile-tag-list');
      if (!list) return;
      list.innerHTML = _currentConditions.map(function (c, i) {
        return '<span class="p-tag">' + esc(c) +
          ' <span class="p-tag-x" onclick="removeConditionTag(' + i + ')">Ã—</span></span>';
      }).join('');
    }

    function renderConditionSuggestions() {
      var sugg = document.getElementById('profile-tag-suggestions');
      if (!sugg) return;
      sugg.innerHTML = CONDITION_SUGGESTIONS
        .filter(function (s) { return _currentConditions.indexOf(s) === -1; })
        .map(function (s) {
          return '<span class="p-tag sugg" onclick="addConditionTagVal(\'' + esc(s) + '\')">' + esc(s) + '</span>';
        }).join('');
    }

    function addConditionTag() {
      var inp = document.getElementById('profile-tag-input');
      if (!inp || !inp.value.trim()) return;
      addConditionTagVal(inp.value.trim());
      inp.value = '';
    }

    function addConditionTagVal(val) {
      if (!val || _currentConditions.indexOf(val) !== -1) return;
      _currentConditions.push(val);
      renderConditionTags();
      renderConditionSuggestions();
    }

    function removeConditionTag(i) {
      _currentConditions.splice(i, 1);
      renderConditionTags();
      renderConditionSuggestions();
    }

    /* Module toggle */
    function toggleModule(key) {
      var el = document.getElementById('mod-' + key);
      if (!el) return;
      el.classList.toggle('on');
      el.classList.toggle('off');
    }

    /* Prompt list helpers */
    function addPrompt() {
      _currentPrompts.push('');
      renderPromptList();
      setTimeout(function () {
        var inputs = document.querySelectorAll('.prompt-row input');
        if (inputs.length) inputs[inputs.length - 1].focus();
      }, 50);
    }

    function removePrompt(i) {
      _currentPrompts.splice(i, 1);
      renderPromptList();
    }

    function renderPromptList() {
      var list = document.getElementById('profile-prompt-list');
      if (!list) return;
      list.innerHTML = _currentPrompts.map(function (pr, i) {
        return '<div class="prompt-row">' +
          '<input type="text" value="' + esc(pr) + '" ' +
            'placeholder="e.g. How is your head pain today? (1-10)" ' +
            'oninput="_currentPrompts[' + i + ']=this.value">' +
          '<button class="btn-px" onclick="removePrompt(' + i + ')">Ã—</button>' +
        '</div>';
      }).join('');
    }

    /* Boot when AA is ready */
    waitForAA(boot);
  </script>
</body>
</html>
