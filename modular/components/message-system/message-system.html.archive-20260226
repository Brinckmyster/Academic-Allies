<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messages â€” Academic Allies</title>
  <link rel="icon" href="/Academic-Allies/favicon.ico">
  <style>
    body { font-family: 'Atkinson Hyperlegible', Arial, sans-serif; background: #FAFAF9; color: #333; margin: 0; padding: 0; }

    .msg-layout {
      display: flex; height: calc(100vh - 80px); max-width: 960px; margin: 0 auto;
      border: 1px solid #e1e5e9; border-radius: 12px; overflow: hidden;
      background: #fff; box-shadow: 0 2px 12px rgba(0,0,0,0.07);
    }

    /* â”€â”€ Contacts sidebar â”€â”€ */
    .contacts-panel {
      width: 260px; min-width: 200px; border-right: 1px solid #e1e5e9;
      display: flex; flex-direction: column; background: #f8fafc;
    }
    .contacts-header {
      padding: 16px 14px 10px; font-weight: 700; font-size: 0.9rem;
      color: #4a7f82; border-bottom: 1px solid #e1e5e9; letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .contact-list { flex: 1; overflow-y: auto; }
    .contact-item {
      display: flex; align-items: center; gap: 10px; padding: 11px 14px;
      cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.15s;
    }
    .contact-item:hover { background: #e8f2f3; }
    .contact-item.active { background: #d4edef; border-left: 3px solid #4a7f82; }
    .contact-avatar {
      width: 36px; height: 36px; border-radius: 50%; object-fit: cover;
      flex-shrink: 0; border: 2px solid #e1e5e9;
    }
    .contact-info { min-width: 0; }
    .contact-name { font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .contact-tier    { font-size: 0.72rem; color: #888; }
    .contact-preview { font-size: 0.72rem; color: #aaa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .contact-unread {
      margin-left: auto; background: #4a7f82; color: #fff;
      border-radius: 10px; padding: 1px 7px; font-size: 0.72rem; font-weight: 700;
      flex-shrink: 0;
    }
    #contacts-empty { padding: 20px 14px; font-size: 0.85rem; color: #aaa; }

    /* â”€â”€ Thread panel â”€â”€ */
    .thread-panel { flex: 1; display: flex; flex-direction: column; min-width: 0; }
    .thread-header {
      padding: 14px 18px; border-bottom: 1px solid #e1e5e9;
      display: flex; align-items: center; gap: 10px; background: #fff;
    }
    .thread-header img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
    .thread-header-name { font-weight: 700; font-size: 1rem; }
    .thread-header-tier { font-size: 0.78rem; color: #888; }
    #thread-placeholder {
      flex: 1; display: flex; align-items: center; justify-content: center;
      color: #bbb; font-size: 0.95rem; text-align: center; padding: 30px;
    }

    /* Messages */
    .messages-area { flex: 1; overflow-y: auto; padding: 16px 18px; display: flex; flex-direction: column; gap: 10px; }
    .msg-bubble {
      max-width: 75%; padding: 9px 14px; border-radius: 14px; font-size: 0.92rem; line-height: 1.4;
      word-break: break-word;
    }
    .msg-bubble.mine   { align-self: flex-end; background: #4a7f82; color: #fff; border-bottom-right-radius: 4px; }
    .msg-bubble.theirs { align-self: flex-start; background: #f0f0f0; color: #333; border-bottom-left-radius: 4px; }
    .msg-meta { font-size: 0.7rem; margin-top: 3px; opacity: 0.65; }
    .msg-bubble.mine   .msg-meta { text-align: right; }
    .msg-bubble.theirs .msg-meta { text-align: left; }

    /* Compose */
    .compose-area {
      padding: 12px 16px; border-top: 1px solid #e1e5e9; display: none;
      gap: 8px; align-items: flex-end; background: #fff;
    }
    .compose-area textarea {
      flex: 1; padding: 9px 12px; border: 1px solid #ccc; border-radius: 8px;
      font-size: 14px; resize: none; font-family: inherit; min-height: 38px; max-height: 120px;
    }
    .compose-area textarea:focus { outline: none; border-color: #4a7f82; }
    .btn-send {
      padding: 9px 18px; background: #4a7f82; color: #fff; border: none;
      border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;
      flex-shrink: 0;
    }
    .btn-send:hover { background: #3d6e71; }
    .btn-send:disabled { background: #aaa; cursor: default; }

    /* Loading / signin */
    #msg-loading { padding: 40px; text-align: center; color: #aaa; }

    /* Tier badge colours for contact tier label */
    .tier-admin       { color: #6366f1; }
    .tier-student     { color: #4a7f82; }
    .tier-support     { color: #10b981; }
    .tier-family      { color: #f59e0b; }
    .tier-nearby-help { color: #f97316; }

    @media (max-width: 600px) {
      .contacts-panel { width: 64px; }
      .contact-name, .contact-tier, #contacts-empty { display: none; }
      .contact-avatar { width: 40px; height: 40px; }
    }
  </style>
</head>
<body>
  <div id="site-header"></div>
  <div id="msg-loading">Loading messagesâ€¦</div>

  <div class="msg-layout" id="msg-layout" style="display:none; margin-top:8px;">
    <!-- Contacts -->
    <div class="contacts-panel">
      <div class="contacts-header">ğŸ’¬ Conversations</div>
      <div class="contact-list" id="contact-list">
        <div id="contacts-empty">No contacts yet.</div>
      </div>
    </div>

    <!-- Thread -->
    <div class="thread-panel" id="thread-panel">
      <div id="thread-placeholder">â† Select a contact to start messaging</div>
      <div class="thread-header" id="thread-header" style="display:none;">
        <img id="thread-avatar" src="" alt="">
        <div>
          <div class="thread-header-name" id="thread-name"></div>
          <div class="thread-header-tier" id="thread-tier"></div>
        </div>
      </div>
      <div class="messages-area" id="messages-area" style="display:none;"></div>
      <div class="compose-area" id="compose-area">
        <textarea id="compose-text" placeholder="Type a messageâ€¦" rows="1"
          onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage();}"></textarea>
        <button class="btn-send" id="btn-send" onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <!-- Load shared header -->
  <script>
    fetch('/Academic-Allies/modular/shared-header.html?v=20260220d')
      .then(function(r) { return r.text(); })
      .then(function(html) {
        var c = document.getElementById('site-header');
        c.innerHTML = html;
        c.querySelectorAll('script').forEach(function(old) {
          var s = document.createElement('script');
          Array.from(old.attributes).forEach(function(a) { s.setAttribute(a.name, a.value); });
          s.textContent = old.textContent;
          old.replaceWith(s);
        });
      });
  </script>

  <script>
    /* â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var TIER_ICONS = {
      'admin':       '/Academic-Allies/modular/icons/icon-user-admin.png',
      'student':     '/Academic-Allies/modular/icons/icon-user-student.png',
      'support':     '/Academic-Allies/modular/icons/icon-user-support.png',
      'nearby-help': '/Academic-Allies/modular/icons/icon-user-nearby-help.png',
      'family':      '/Academic-Allies/modular/icons/icon-user-family.png'
    };
    var TIER_LABELS = {
      'admin': 'Admin', 'student': 'Student', 'support': 'Support',
      'nearby-help': 'Nearby Help', 'family': 'Family'
    };

    /* â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var currentUser     = null;
    var activeContact   = null;   // { uid, name, tier }
    var activeThreadId  = null;
    var unsubMessages   = null;   // Firestore listener unsub fn for active thread
    var unsubThreads    = null;   // Firestore listener for sidebar real-time updates

    /* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function threadId(uid1, uid2) {
      return [uid1, uid2].sort().join('_');
    }

    function tierIcon(tier) {
      return TIER_ICONS[tier] || TIER_ICONS['student'];
    }

    function fmtTime(ts) {
      if (!ts) return '';
      var d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString([], { dateStyle: 'short', timeStyle: 'short' });
    }

    function waitForAA(cb, tries) {
      tries = tries || 0;
      if (window.AA && window.AA.auth && window.AA.db) { cb(); return; }
      if (tries > 40) { document.getElementById('msg-loading').textContent = 'Could not connect to Firebase.'; return; }
      setTimeout(function() { waitForAA(cb, tries + 1); }, 200);
    }

    /* â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function boot() {
      AA.auth.onAuthStateChanged(function(user) {
        if (!user) {
          document.getElementById('msg-loading').textContent = 'Please sign in to use messages.';
          return;
        }
        currentUser = user;
        loadContacts();
      });
    }

    /* â”€â”€ Build contact list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function loadContacts() {
      AA.getUserDoc(currentUser.uid).then(function(doc) {
        if (!doc.exists) { document.getElementById('msg-loading').textContent = 'Profile not found.'; return; }
        var data   = doc.data();
        var myRole = data.role || 'student';

        if (myRole === 'admin') {
          /* Admins see every registered user */
          AA.db.collection('users').get().then(function(snap) {
            var contacts = [];
            snap.forEach(function(d) {
              if (d.id !== currentUser.uid) {
                contacts.push({ uid: d.id, tier: d.data().role || 'student', data: d.data() });
              }
            });
            renderContacts(contacts);
            watchThreads();
            document.getElementById('msg-loading').style.display = 'none';
            document.getElementById('msg-layout').style.display  = 'flex';
          }).catch(function(err) {
            document.getElementById('msg-loading').textContent = 'Error loading users: ' + err.message;
          });

        } else {
          /* Non-admins: own support network + platform admins + students who have
             this user in THEIR support network (reverse lookup so Karen can see Mary) */
          var network = data.supportNetwork || {};

          /* Step 1: reverse lookup â€” find students who list this user in their network */
          AA.db.collection('users').get().then(function(snap) {
            snap.forEach(function(doc) {
              var d = doc.data();
              if (doc.id !== currentUser.uid &&
                  d.role === 'student' &&
                  d.supportNetwork && d.supportNetwork[currentUser.uid] &&
                  !network[doc.id]) {
                network[doc.id] = d.supportNetwork[currentUser.uid];
              }
            });

            var uids = Object.keys(network);

            /* Step 2: add platform admins */
            AA.getAllAdmins().then(function(admins) {
              admins.forEach(function(a) {
                if (a.uid !== currentUser.uid && !network[a.uid]) {
                  uids.push(a.uid);
                  network[a.uid] = 'admin';
                }
              });

              if (uids.length === 0) {
                document.getElementById('msg-loading').style.display = 'none';
                document.getElementById('msg-layout').style.display  = 'flex';
                return;
              }

              /* Step 3: fetch display names */
              var fetches = uids.map(function(uid) {
                return AA.getUserDoc(uid).then(function(d) {
                  return { uid: uid, tier: network[uid], data: d.exists ? d.data() : null };
                });
              });

              Promise.all(fetches).then(function(contacts) {
                renderContacts(contacts.filter(function(c) { return c.data; }));
                watchThreads();
                document.getElementById('msg-loading').style.display = 'none';
                document.getElementById('msg-layout').style.display  = 'flex';
              });
            });
          }).catch(function(err) {
            document.getElementById('msg-loading').textContent = 'Error loading contacts: ' + err.message;
          });
        }
      }).catch(function(err) {
        document.getElementById('msg-loading').textContent = 'Error: ' + err.message;
      });
    }

    /* â”€â”€ Render contact list with tier icons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderContacts(contacts) {
      var list = document.getElementById('contact-list');
      list.innerHTML = '';

      if (contacts.length === 0) {
        list.innerHTML = '<div id="contacts-empty">No contacts in your network yet.</div>';
        return;
      }

      contacts.forEach(function(c) {
        var name  = c.data.displayName || c.data.email || 'Unknown';
        var tier  = c.tier || 'student';
        var icon  = tierIcon(tier);
        var label = TIER_LABELS[tier] || tier;

        var item = document.createElement('div');
        item.className = 'contact-item';
        item.dataset.uid  = c.uid;
        item.dataset.name = name;
        item.dataset.tier = tier;
        item.innerHTML =
          '<img class="contact-avatar" src="' + icon + '" alt="' + label + '" ' +
               'onerror="this.src=\'/Academic-Allies/modular/icons/icon-user-student.png\'">' +
          '<div class="contact-info">' +
            '<div class="contact-name">' + esc(name) + '</div>' +
            '<div class="contact-tier tier-' + tier + '">' + label + '</div>' +
          '</div>';

        item.addEventListener('click', function() {
          openThread(c.uid, name, tier, icon, item);
        });
        list.appendChild(item);
      });
    }

    /* â”€â”€ Open a message thread â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function openThread(uid, name, tier, icon, el) {
      /* Clear previous listener */
      if (unsubMessages) { unsubMessages(); unsubMessages = null; }

      activeContact  = { uid: uid, name: name, tier: tier };
      activeThreadId = threadId(currentUser.uid, uid);
      markRead(activeThreadId);
      /* Clear badge from the contact item immediately */
      var badge = el && el.querySelector('.contact-unread');
      if (badge) badge.remove();

      /* Highlight selected contact */
      document.querySelectorAll('.contact-item').forEach(function(i) { i.classList.remove('active'); });
      if (el) el.classList.add('active');

      /* Show thread header */
      document.getElementById('thread-placeholder').style.display = 'none';
      document.getElementById('thread-header').style.display      = 'flex';
      document.getElementById('messages-area').style.display      = 'flex';
      document.getElementById('compose-area').style.display       = 'flex';
      document.getElementById('thread-avatar').src  = icon;
      document.getElementById('thread-name').textContent = name;
      document.getElementById('thread-tier').textContent = TIER_LABELS[tier] || tier;

      /* Real-time listener */
      unsubMessages = AA.db
        .collection('messages').doc(activeThreadId)
        .collection('msgs')
        .orderBy('timestamp', 'asc')
        .onSnapshot(function(snap) {
          renderMessages(snap.docs);
        }, function(err) {
          console.error('[AA messages]', err);
        });
    }

    /* â”€â”€ Render messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderMessages(docs) {
      var area = document.getElementById('messages-area');
      area.innerHTML = '';

      if (docs.length === 0) {
        area.innerHTML = '<div style="text-align:center;color:#bbb;padding:30px;font-size:0.9rem;">No messages yet â€” say hello!</div>';
        return;
      }

      docs.forEach(function(doc) {
        var d    = doc.data();
        var mine = (d.senderUid === currentUser.uid);
        var bubble = document.createElement('div');
        bubble.className = 'msg-bubble ' + (mine ? 'mine' : 'theirs');
        bubble.innerHTML =
          '<div>' + esc(d.text || '') + '</div>' +
          '<div class="msg-meta">' +
            (mine ? '' : esc(d.senderName || '') + ' Â· ') +
            fmtTime(d.timestamp) +
          '</div>';
        area.appendChild(bubble);
      });

      /* Scroll to bottom */
      area.scrollTop = area.scrollHeight;

      /* Mark active thread as read */
      if (activeThreadId) {
        markRead(activeThreadId);
        var activeBadge = document.querySelector('.contact-item.active .contact-unread');
        if (activeBadge) activeBadge.remove();
      }
    }

    /* â”€â”€ Send a message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function sendMessage() {
      var textarea = document.getElementById('compose-text');
      var text     = textarea.value.trim();
      if (!text || !activeThreadId) return;

      var btn = document.getElementById('btn-send');
      btn.disabled = true;

      /* Ensure the thread doc exists (for future querying) */
      var threadRef = AA.db.collection('messages').doc(activeThreadId);
      threadRef.set({
        participants: [currentUser.uid, activeContact.uid],
        lastMessage:  text,
        lastAt:       AA.FieldValue.serverTimestamp()
      }, { merge: true });

      /* Add the message */
      threadRef.collection('msgs').add({
        text:        text,
        senderUid:   currentUser.uid,
        senderName:  currentUser.displayName || currentUser.email,
        timestamp:   AA.FieldValue.serverTimestamp()
      }).then(function() {
        textarea.value = '';
        btn.disabled = false;
        textarea.focus();
      }).catch(function(err) {
        alert('Send failed: ' + err.message);
        btn.disabled = false;
      });
    }

    /* â”€â”€ HTML escape â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function esc(s) {
      return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    /* â”€â”€ Last-read tracking (localStorage) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function getLastRead(tid) {
      try { return parseInt(localStorage.getItem('aa-msg-read-' + tid) || '0'); } catch(e) { return 0; }
    }
    function markRead(tid) {
      try { localStorage.setItem('aa-msg-read-' + tid, Date.now().toString()); } catch(e) {}
    }

    /* â”€â”€ Real-time sidebar: last message preview + unread â”€â”€ */
    /* Listens to all threads this user participates in.
       Updates each contact item's preview text and unread badge. */
    function watchThreads() {
      if (unsubThreads) { unsubThreads(); unsubThreads = null; }
      unsubThreads = AA.db.collection('messages')
        .where('participants', 'array-contains', currentUser.uid)
        .onSnapshot(function(snap) {
          snap.docs.forEach(function(doc) {
            var d   = doc.data();
            var tid = doc.id;
            var otherUid = (d.participants || []).filter(function(uid) { return uid !== currentUser.uid; })[0];
            if (!otherUid) return;
            var item = document.querySelector('.contact-item[data-uid="' + otherUid + '"]');
            if (!item) return;
            updateSidebarItem(item, d, tid);
          });
        }, function(err) {
          console.warn('[AA messages] thread watcher:', err);
        });
    }

    function updateSidebarItem(item, threadData, tid) {
      /* Last message preview */
      var preview = item.querySelector('.contact-preview');
      if (!preview) {
        preview = document.createElement('div');
        preview.className = 'contact-preview';
        var info = item.querySelector('.contact-info');
        if (info) info.appendChild(preview);
      }
      var lastMsg = threadData.lastMessage || '';
      preview.textContent = lastMsg.length > 36 ? lastMsg.slice(0, 36) + '\u2026' : lastMsg;

      /* Unread badge: show if thread updated after last-read and not the active thread */
      var lastAtMs   = threadData.lastAt ? threadData.lastAt.toMillis() : 0;
      var lastReadMs = getLastRead(tid);
      var isActive   = (tid === activeThreadId);
      var hasUnread  = lastAtMs > lastReadMs && !isActive;

      var badge = item.querySelector('.contact-unread');
      if (hasUnread) {
        if (!badge) {
          badge = document.createElement('span');
          badge.className = 'contact-unread';
          item.appendChild(badge);
        }
        badge.textContent = '\u2022'; /* bullet â€” keeps badge small */
      } else if (badge) {
        badge.remove();
      }
    }

    waitForAA(boot);
  </script>
</body>
</html>
