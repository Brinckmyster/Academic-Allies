<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mary's Meal Planner - Academic Allies</title>
  <link rel="icon" href="/Academic-Allies/favicon.ico">
  <style>
    body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
    .meal-controls { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
    .meal-controls button { padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 6px; border: none; }
    .meal-controls button.primary { background: #4CAF50; color: white; }
    .meal-controls button.secondary { background: #2196F3; color: white; }
    .meal-controls button.danger { background: #f44336; color: white; }
    .meal-entry { background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0; }
    .meal-entry input, .meal-entry textarea { width: 100%; padding: 10px; margin: 5px 0; border-radius: 4px; border: 1px solid #ccc; }
    .meal-list { margin-top: 20px; }
    .meal-item { background: white; padding: 15px; margin: 10px 0; border-radius: 6px; border-left: 4px solid #4CAF50; }
  </style>
</head>
<body>
  <div id="site-header"></div>
  <script src="time-utils.js"></script>
  <script src="suggestions.js"></script>
  <script src="edit-modal.js"></script>
  <script>
    fetch('/Academic-Allies/modular/shared-header.html?v=20260221')
      .then(response => response.text())
      .then(html => {
        const container = document.getElementById('site-header');
        container.innerHTML = html;
        const scripts = container.querySelectorAll('script');
        scripts.forEach(oldScript => {
          const newScript = document.createElement('script');
          Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
          newScript.textContent = oldScript.textContent;
          oldScript.replaceWith(newScript);
        });
        const dragScript = document.createElement('script');
        dragScript.src = '/Academic-Allies/modular/js/draggable.js';
        dragScript.onload = () => { if(typeof initDrag === 'function') initDrag(); };
        document.body.appendChild(dragScript);
      });
  </script>

  <h1>Mary's Meal Planner</h1>
  <p>Gastroparesis-safe meals. Refined wheat OK. Solids at 10:30am/1:30pm/4:30pm, liquids only after 5pm.</p>

  <!-- Upload Base Plan -->
  <div class="meal-controls">
    <input type="file" id="fileUpload" accept=".json,.csv,.pdf">
    <button class="secondary" onclick="loadBasePlan()">Load Base Plan</button>
    <button class="secondary" onclick="suggestMeal()">Suggest Meals</button>
    <button class="danger" onclick="resetPlan()">Reset</button>
    <button class="secondary" onclick="showBasePlan()">Show/Edit Base Plan Template</button>
  </div>

  <!-- Manual Entry -->
  <div class="meal-entry">
    <h3>Add Meal</h3>
    <input type="text" id="mealName" placeholder="Meal name">
    <input type="time" id="mealTime">
    <textarea id="mealNotes" placeholder="Notes (optional)" rows="3"></textarea>
    <input type="file" id="mealPhoto" accept="image/*" capture="camera" style="margin: 5px 0;">
    <button class="primary" onclick="addMeal()">Add Meal</button>
  </div>

  <!-- Today's Plan -->
  <div>
    <h3>Meals Planned Today: <span id="mealCount">0</span></h3>
    <div id="mealList" class="meal-list"></div>
  </div>

  <script>
    // Updated 2026-02-18 by Claude — fixed missing braces throughout,
    // removed undefined photoFile ref, removed duplicate script tags,
    // added removeMeal() per-item button.

    // ── Data init ─────────────────────────────────────────────
    let todaysMeals = [];
    try {
      const stored = localStorage.getItem('maryMealPlan');
      if (stored) {
        const parsed = JSON.parse(stored);
        todaysMeals = Array.isArray(parsed) ? parsed : [];
      }
    } catch(e) {
      console.error('Error loading meals:', e);
      localStorage.removeItem('maryMealPlan');
    }

    // ── Display ───────────────────────────────────────────────
    function displayMeals() {
      const list  = document.getElementById('mealList');
      const count = document.getElementById('mealCount');
      count.textContent = todaysMeals.length;
      list.innerHTML = todaysMeals.map((meal, i) => `
        <div class="meal-item">
          <strong>${meal.name || '(unnamed)'}</strong>
          ${meal.time ? '<br>Time: ' + to12Hour(meal.time) : ''}
          ${meal.notes ? '<br>Notes: ' + meal.notes : ''}
          <button onclick="removeMeal(${i})"
                  style="float:right;background:#f44336;color:#fff;border:none;
                         border-radius:4px;padding:4px 12px;cursor:pointer;font-size:13px;">
            Remove
          </button>
        </div>
      `).join('');
    }

    // ── Add meal ──────────────────────────────────────────────
    function addMeal() {
      const name  = document.getElementById('mealName').value.trim();
      const time  = document.getElementById('mealTime').value;
      const notes = document.getElementById('mealNotes').value.trim();

      if (!name && !time) {
        alert('Please enter at least a meal name or time.');
        return;
      }

      todaysMeals.push({ name: name || '(unnamed)', time, notes });
      localStorage.setItem('maryMealPlan', JSON.stringify(todaysMeals));

      document.getElementById('mealName').value  = '';
      document.getElementById('mealTime').value  = '';
      document.getElementById('mealNotes').value = '';
      displayMeals();
    }

    // ── Remove individual meal ────────────────────────────────
    function removeMeal(index) {
      todaysMeals.splice(index, 1);
      localStorage.setItem('maryMealPlan', JSON.stringify(todaysMeals));
      displayMeals();
    }

    // ── Reset all ─────────────────────────────────────────────
    function resetPlan() {
      if (confirm('Clear all meals for today?')) {
        todaysMeals = [];
        localStorage.setItem('maryMealPlan', JSON.stringify(todaysMeals));
        displayMeals();
      }
    }

    // ── Load base plan from uploaded file ─────────────────────
    function loadBasePlan() {
      const file = document.getElementById('fileUpload').files[0];
      if (!file) {
        alert('Please select a JSON file first.');
        return;
      }
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const plan = JSON.parse(e.target.result);
          localStorage.setItem('maryBasePlan', JSON.stringify(plan));
          alert('Base plan loaded!');
        } catch(err) {
          alert('Error loading file — make sure it is valid JSON.');
        }
      };
      reader.readAsText(file);
    }

    // ── Init ──────────────────────────────────────────────────
    displayMeals();

    // Cache the bundled base plan JSON if not already stored
    fetch('base-meal-plan-mary.json')
      .then(r => r.json())
      .then(plan => {
        if (!localStorage.getItem('maryBasePlan')) {
          localStorage.setItem('maryBasePlan', JSON.stringify(plan));
        }
      })
      .catch(() => {}); // silent — base plan is optional
  </script>
</body>
</html>
