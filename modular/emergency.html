<!DOCTYPE html>
<!-- ============================================================
     emergency.html â€” Academic Allies Emergency Contacts
     Created: (original page)
     Rebuilt: 2026-02-28 by Claude
     Emergency contacts are now stored privately in Firestore
     at emergencyContacts/{uid}. Only the student, their
     network leads, and the backstage-manager can read them.
     Network leads can add/edit contacts for their students.
     No contact data is ever hardcoded in this file.
     ============================================================ -->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Emergency Contacts â€” Academic Allies</title>
  <link rel="icon" href="/Academic-Allies/favicon.ico" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --red:     #dc3545;
      --red-lt:  #fde8ea;
      --orange:  #fd7e14;
      --teal:    #6CA0A3;
      --teal-dk: #4d787b;
      --bg:      #FAFAF9;
      --card:    #FFFFFF;
      --border:  #D9E4E5;
      --text:    #1a1a1a;
      --muted:   #5a6a6b;
      --radius:  12px;
      --shadow:  0 2px 8px rgba(0,0,0,.07);
    }
    body {
      font-family: 'Atkinson Hyperlegible', Arial, sans-serif;
      background: var(--bg); color: var(--text);
      padding-bottom: 3rem;
    }
    #site-header { min-height: 56px; }
    .page-wrap { max-width: 680px; margin: 0 auto; padding: 1rem 1rem 2rem; }

    h1 { font-size: 1.5rem; color: var(--red); margin: 1rem 0 .25rem; }
    .subtitle { color: var(--muted); font-size: .9rem; margin-bottom: 1.5rem; }

    /* â”€â”€ Auth gate â”€â”€ */
    #auth-gate {
      display: none; text-align: center; padding: 3rem 1rem; color: var(--muted);
    }
    #auth-gate button {
      margin-top: 1rem; padding: .6rem 1.4rem;
      background: var(--teal); color: #fff; border: none;
      border-radius: 8px; font-size: 1rem; cursor: pointer;
    }

    /* â”€â”€ Mirror notice â”€â”€ */
    #mirror-notice {
      display: none; background: #e8f2f3; border: 1px solid var(--teal);
      border-radius: 8px; padding: .6rem 1rem; margin-bottom: 1rem;
      font-size: .88rem; color: var(--teal-dk);
    }

    /* â”€â”€ Section headers â”€â”€ */
    .section-title {
      display: flex; align-items: center; gap: .5rem;
      font-size: 1.1rem; font-weight: 700; color: var(--red);
      margin: 1.5rem 0 .75rem;
    }

    /* â”€â”€ Contact cards â”€â”€ */
    .contact-card {
      background: var(--card); border: 1.5px solid var(--border);
      border-radius: var(--radius); box-shadow: var(--shadow);
      padding: 1rem 1.1rem; margin-bottom: .75rem;
      display: flex; gap: 1rem; align-items: flex-start;
    }
    .contact-photo {
      width: 64px; height: 64px; border-radius: 50%;
      object-fit: cover; flex-shrink: 0; background: #eee;
    }
    .contact-info { flex: 1; }
    .contact-name { font-weight: 700; font-size: 1rem; }
    .contact-rel  { font-size: .82rem; color: var(--muted); margin-bottom: .4rem; }
    .contact-actions { display: flex; gap: .5rem; flex-wrap: wrap; margin-top: .5rem; }
    .contact-actions a, .contact-actions button {
      display: inline-flex; align-items: center; gap: .3rem;
      padding: .35rem .8rem; border-radius: 6px; font-size: .85rem;
      text-decoration: none; border: none; cursor: pointer; font-family: inherit;
    }
    .btn-call  { background: #e8f5ee; color: #2e6b4f; }
    .btn-email { background: #e8f2ff; color: #1a4fa0; }
    .contact-msg {
      font-size: .85rem; color: #555; font-style: italic;
      border-left: 3px solid var(--border); padding: .3rem .6rem;
      margin-top: .5rem;
    }

    /* â”€â”€ Empty / loading states â”€â”€ */
    #ec-loading { text-align: center; padding: 2rem; color: var(--muted); }
    #ec-empty   { display: none; }
    .empty-box  {
      background: var(--card); border: 1.5px dashed var(--border);
      border-radius: var(--radius); padding: 2rem; text-align: center;
      color: var(--muted); font-size: .9rem;
    }

    /* â”€â”€ Edit mode (network lead / admin) â”€â”€ */
    #edit-section { display: none; margin-top: 2rem; }
    #edit-section h2 {
      font-size: 1rem; color: var(--teal-dk);
      margin-bottom: .75rem;
    }
    .edit-card {
      background: var(--card); border: 1.5px solid var(--border);
      border-radius: var(--radius); padding: 1rem 1.1rem;
      margin-bottom: .75rem;
    }
    .edit-card label {
      display: block; font-size: .82rem; color: var(--muted);
      margin: .6rem 0 .2rem;
    }
    .edit-card label:first-child { margin-top: 0; }
    .edit-card input, .edit-card select, .edit-card textarea {
      width: 100%; padding: .45rem .7rem; border-radius: 6px;
      border: 1px solid var(--border); font-size: .9rem;
      font-family: inherit; background: #fff;
    }
    .edit-card textarea { resize: vertical; min-height: 60px; }
    .edit-card-actions {
      display: flex; gap: .5rem; margin-top: .75rem; flex-wrap: wrap;
    }
    .btn-save   { background: var(--teal); color: #fff; border: none; border-radius: 6px; padding: .4rem .9rem; cursor: pointer; font-size: .85rem; }
    .btn-delete { background: var(--red-lt); color: var(--red); border: 1px solid #f5c6cb; border-radius: 6px; padding: .4rem .9rem; cursor: pointer; font-size: .85rem; }
    .btn-byui   { background: #1a2a4a; color: #a8c4e0; border: 1px solid #2a4a7a; border-radius: 6px; padding: .3rem .7rem; cursor: pointer; font-size: .8rem; }
    #add-contact-btn {
      display: none; background: var(--teal); color: #fff;
      border: none; border-radius: 8px; padding: .5rem 1.1rem;
      cursor: pointer; font-size: .9rem; margin-bottom: 1rem;
    }
    #save-status { font-size: .85rem; color: var(--teal-dk); margin-top: .4rem; min-height: 1.2em; }

    /* â”€â”€ Seed defaults button (backstage-manager only) â”€â”€ */
    #seed-defaults-btn {
      display: none; background: #fff3cd; color: #856404;
      border: 1px solid #ffc107; border-radius: 8px;
      padding: .45rem 1rem; cursor: pointer; font-size: .85rem;
      margin-bottom: .75rem;
    }
    #seed-defaults-btn:hover { background: #ffe083; }

    /* â”€â”€ Network picker â”€â”€ */
    #network-picker-body { margin-top: .6rem; }
  </style>
</head>
<body>

<div id="site-header"></div>

<div class="page-wrap">
  <h1>
    <img src="/Academic-Allies/modular/icons/icon-user-emergency-contact.png"
         height="32" width="32" alt="" style="vertical-align:middle;margin-right:.4rem">
    Emergency Contacts
  </h1>
  <p class="subtitle" id="ec-subtitle">Your private emergency contacts â€” only you and your network leads can see these.</p>

  <div id="auth-gate">
    <p>Sign in to see emergency contacts.</p>
    <button onclick="AA.signInWithGoogle()">Sign in with Google</button>
  </div>

  <div id="mirror-notice">ğŸ‘ Viewing <strong id="mirror-name">student</strong>'s emergency contacts in read-only mode.</div>

  <div id="ec-loading">Loading contactsâ€¦</div>

  <div id="ec-view" style="display:none">
    <div id="ec-empty">
      <div class="empty-box">
        No emergency contacts have been added yet.<br>
        <span id="empty-hint" style="display:none">A network lead can add contacts using the section below.</span>
      </div>
    </div>
    <div id="ec-emergency-section" style="display:none">
      <div class="section-title">
        ğŸ†˜ Emergency Contacts
      </div>
      <div id="ec-emergency-list"></div>
    </div>
    <div id="ec-nearby-section" style="display:none">
      <div class="section-title">
        ğŸ  Nearby Help
      </div>
      <div id="ec-nearby-list"></div>
    </div>
  </div>

  <!-- Edit section â€” visible to network leads and backstage-manager -->
  <div id="edit-section">
    <h2>âœï¸ Edit Contacts</h2>
    <!-- Seed defaults button: backstage-manager only. Added 2026-03-01 by Claude -->
    <button id="seed-defaults-btn" onclick="seedDefaultContacts()">ğŸŒ± Seed Default Contacts (Mom + Dad)</button>
    <button id="add-contact-btn" onclick="addContactForm()">+ Add Contact</button>
    <!-- Pick from support network. Added 2026-03-01 by Claude -->
    <details style="margin:.75rem 0;font-size:.85rem;" id="network-picker-details" ontoggle="if(this.open) loadSupportNetwork();">
      <summary style="cursor:pointer;color:var(--teal-dk);font-weight:600;">ğŸ‘¥ Pick from Support Network</summary>
      <div id="network-picker-body" style="margin-top:.6rem;">
        <em style="color:var(--muted);font-size:.85rem">Open to load network membersâ€¦</em>
      </div>
    </details>
    <details style="margin:.75rem 0;font-size:.85rem;">
      <summary style="cursor:pointer;color:var(--teal-dk);font-weight:600;">ğŸ« Quick-add BYU-Idaho Resources</summary>
      <div style="display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.6rem;">
        <button class="btn-byui" onclick="addByuiContact('Accessibility & Disability Services','campus','(208) 496-9210','accessibility@byui.edu')">â™¿ Accessibility</button>
        <button class="btn-byui" onclick="addByuiContact('Campus Counseling Center','campus','(208) 496-9370','counseling@byui.edu')">ğŸ§  Counseling</button>
        <button class="btn-byui" onclick="addByuiContact('Student Health Center','campus','(208) 496-9330','')">ğŸ¥ Health Center</button>
        <button class="btn-byui" onclick="addByuiContact('Campus Safety','campus','(208) 496-9500','')">ğŸš¨ Campus Safety</button>
        <button class="btn-byui" onclick="addByuiContact('Testing Center','campus','(208) 496-9325','')">ğŸ“ Testing Center</button>
        <button class="btn-byui" onclick="addByuiContact('Academic Advising','campus','(208) 496-1411','')">ğŸ“ Advising</button>
        <button class="btn-byui" onclick="addByuiContact('Crisis Line (988)','emergency','988','')">ğŸ†˜ 988 Crisis</button>
        <button class="btn-byui" onclick="addByuiContact('Crisis Text Line','emergency','741741','')">ğŸ’¬ Text 741741</button>
      </div>
    </details>
    <div id="edit-forms"></div>
    <div id="save-status"></div>
  </div>
</div>

<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
<script src="/Academic-Allies/modular/aa-firebase.js"></script>
<script src="/Academic-Allies/modular/js/aa-mirror.js"></script>

<script>
/* â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _studentUid  = null;
var _contacts    = [];   /* current contacts array */
var _canEdit     = false;
var _unsubContacts = null;
var _initialLoadDone = false; /* prevent onSnapshot from wiping unsaved edit forms */

/* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function esc(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function show(id) { var el=document.getElementById(id); if(el) el.style.display='block'; }
function hide(id) { var el=document.getElementById(id); if(el) el.style.display='none'; }

/* â”€â”€ Render contacts (view mode) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderContactCard(c) {
  var photoHtml = c.photo
    ? '<img class="contact-photo" src="' + esc(c.photo) + '" alt="' + esc(c.name) + '">'
    : '<div class="contact-photo" style="display:flex;align-items:center;justify-content:center;font-size:1.8rem;">ğŸ‘¤</div>';

  var actions = '';
  if (c.phone) {
    actions += '<a class="btn-call" href="tel:' + esc(c.phone) + '">ğŸ“ ' + esc(c.phone) + '</a>';
  }
  if (c.email) {
    actions += '<a class="btn-email" href="mailto:' + esc(c.email) + '">âœ‰ï¸ ' + esc(c.email) + '</a>';
  }

  var msgHtml = c.message
    ? '<div class="contact-msg">"' + esc(c.message) + '"</div>'
    : '';

  return '<div class="contact-card">' +
    photoHtml +
    '<div class="contact-info">' +
      '<div class="contact-name">' + esc(c.name || 'Unnamed') + '</div>' +
      '<div class="contact-rel">'  + esc(c.relationship || '') + '</div>' +
      '<div class="contact-actions">' + actions + '</div>' +
      msgHtml +
    '</div>' +
  '</div>';
}

function renderContacts(contacts) {
  hide('ec-loading');
  show('ec-view');

  var nearby    = contacts.filter(function(c){ return c.type === 'nearby' || c.type === 'campus'; });
  var emergency = contacts.filter(function(c){ return c.type !== 'nearby' && c.type !== 'campus'; });

  if (contacts.length === 0) {
    show('ec-empty');
    if (_canEdit) show('empty-hint');
    hide('ec-emergency-section');
    hide('ec-nearby-section');
    return;
  }

  hide('ec-empty');

  if (emergency.length > 0) {
    show('ec-emergency-section');
    document.getElementById('ec-emergency-list').innerHTML =
      emergency.map(renderContactCard).join('');
  } else hide('ec-emergency-section');

  if (nearby.length > 0) {
    show('ec-nearby-section');
    document.getElementById('ec-nearby-list').innerHTML =
      nearby.map(renderContactCard).join('');
  } else hide('ec-nearby-section');
}

/* â”€â”€ Edit mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showEditSection() {
  show('edit-section');
  document.getElementById('add-contact-btn').style.display = 'inline-block';
  /* Seed defaults button: only for backstage-manager. Added 2026-03-01 by Claude */
  if (typeof window.AA_ROLE !== 'undefined' && window.AA_ROLE === 'backstage-manager') {
    document.getElementById('seed-defaults-btn').style.display = 'inline-block';
  }
  /* Network picker is useful for any editor â€” always shown when edit section opens.
     Added 2026-03-01 by Claude */
  var picker = document.getElementById('network-picker-details');
  if (picker) picker.style.display = '';
  renderEditForms();
}

function renderEditForms() {
  var container = document.getElementById('edit-forms');
  if (_contacts.length === 0) {
    container.innerHTML = '<p style="font-size:.85rem;color:var(--muted);margin-bottom:.75rem">No contacts yet â€” add one below.</p>';
    return;
  }
  container.innerHTML = _contacts.map(function(c, i) {
    var photoPreview = c.photo
      ? '<img src="' + esc(c.photo) + '" style="width:56px;height:56px;border-radius:50%;object-fit:cover;margin-bottom:.4rem;display:block">'
      : '';
    return '<div class="edit-card" data-idx="' + i + '">' +
      '<label>Name</label>' +
      '<input type="text" name="name" value="' + esc(c.name || '') + '">' +
      '<label>Relationship</label>' +
      '<input type="text" name="relationship" value="' + esc(c.relationship || '') + '" placeholder="e.g. Mom, Dad, Bishop, RAâ€¦">' +
      '<label>Type</label>' +
      '<select name="type">' +
        '<option value="emergency"' + (c.type === 'emergency' ? ' selected' : '') + '>ğŸ†˜ Emergency Contact</option>' +
        '<option value="family"'    + (c.type === 'family'    ? ' selected' : '') + '>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Family Member</option>' +
        '<option value="support"'   + (c.type === 'support'   ? ' selected' : '') + '>ğŸ’™ Support Professional</option>' +
        '<option value="nearby"'    + (c.type === 'nearby'    ? ' selected' : '') + '>ğŸ  Nearby Help</option>' +
        '<option value="campus"'    + (c.type === 'campus'    ? ' selected' : '') + '>ğŸ« Campus Resource</option>' +
        '<option value="spiritual"' + (c.type === 'spiritual' ? ' selected' : '') + '>â›ª Spiritual / Bishop</option>' +
      '</select>' +
      '<label>Phone</label>' +
      '<input type="tel" name="phone" value="' + esc(c.phone || '') + '">' +
      '<label>Email</label>' +
      '<input type="email" name="email" value="' + esc(c.email || '') + '">' +
      '<label>Pre-written message (optional)</label>' +
      '<textarea name="message">' + esc(c.message || '') + '</textarea>' +
      '<label>Photo (stored privately in Firebase â€” not in the public repo)</label>' +
      photoPreview +
      '<input type="file" name="photo-file" accept="image/*" style="font-size:.82rem" onchange="uploadContactPhoto(this,' + i + ')">' +
      '<div id="photo-status-' + i + '" style="font-size:.78rem;color:var(--teal-dk);min-height:1em;margin-top:.2rem"></div>' +
      '<div class="edit-card-actions">' +
        '<button class="btn-save" onclick="saveContact(' + i + ',this)">ğŸ’¾ Save</button>' +
        '<button class="btn-delete" onclick="deleteContact(' + i + ')">ğŸ—‘ Remove</button>' +
      '</div>' +
    '</div>';
  }).join('');
}

/* â”€â”€ Firebase Storage photo upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// Uploads a contact photo to Firebase Storage and stores the download URL.
// Added 2026-02-28 by Claude â€” photos stored privately, not in the public repo.
function uploadContactPhoto(input, idx) {
  var file = input.files[0];
  if (!file || !_studentUid) return;
  var statusEl = document.getElementById('photo-status-' + idx);
  if (statusEl) statusEl.textContent = 'Uploadingâ€¦';

  var storage  = firebase.storage();
  var path     = 'emergencyContactPhotos/' + _studentUid + '/' + Date.now() + '_' + file.name;
  var storageRef = storage.ref(path);

  storageRef.put(file)
    .then(function(snap) { return snap.ref.getDownloadURL(); })
    .then(function(url) {
      _contacts[idx].photo = url;
      if (statusEl) statusEl.textContent = 'âœ“ Photo uploaded';
      /* Re-render so preview appears */
      renderEditForms();
    })
    .catch(function(err) {
      console.error('[AA] photo upload:', err);
      if (statusEl) statusEl.textContent = 'âš ï¸ Upload failed â€” ' + err.message;
    });
}

function addContactForm() {
  _contacts.push({ name:'', relationship:'', type:'emergency', phone:'', email:'', message:'', photo:'' });
  renderEditForms();
  /* Scroll to new form */
  var cards = document.querySelectorAll('.edit-card');
  if (cards.length) cards[cards.length-1].scrollIntoView({ behavior:'smooth' });
}

function readCardData(card) {
  var idx = parseInt(card.getAttribute('data-idx'), 10);
  return {
    name:         (card.querySelector('[name=name]').value         || '').trim(),
    relationship: (card.querySelector('[name=relationship]').value || '').trim(),
    type:         (card.querySelector('[name=type]').value         || 'emergency'),
    phone:        (card.querySelector('[name=phone]').value        || '').trim(),
    email:        (card.querySelector('[name=email]').value        || '').trim(),
    message:      (card.querySelector('[name=message]').value      || '').trim(),
    photo:        (_contacts[idx] && _contacts[idx].photo) ? _contacts[idx].photo : ''
  };
}

function addByuiContact(name, type, phone, email) {
  _contacts.push({ name: name, relationship: 'BYU-Idaho', type: type, phone: phone, email: email, message: '', photo: '' });
  renderEditForms();
  var cards = document.querySelectorAll('.edit-card');
  if (cards.length) cards[cards.length-1].scrollIntoView({ behavior:'smooth' });
  persistContacts();
}

function saveContact(idx, btn) {
  var card = btn.closest('.edit-card');
  _contacts[idx] = readCardData(card);
  persistContacts();
}

function deleteContact(idx) {
  if (!confirm('Remove this contact?')) return;
  _contacts.splice(idx, 1);
  persistContacts();
}

function persistContacts() {
  var status = document.getElementById('save-status');
  status.textContent = 'Savingâ€¦';
  AA.db.collection('emergencyContacts').doc(_studentUid).set({
    contacts:  _contacts,
    updatedBy: AA.auth.currentUser ? AA.auth.currentUser.uid : '',
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  })
  .then(function() {
    status.textContent = 'âœ“ Saved';
    renderEditForms();
    setTimeout(function(){ status.textContent = ''; }, 3000);
  })
  .catch(function(err) {
    console.error('[AA] emergencyContacts save:', err);
    status.textContent = 'âš ï¸ Save failed â€” please try again.';
  });
}

/* â”€â”€ Seed default contacts (backstage-manager only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// Added 2026-03-01 by Claude: seeds Dorothy (Mom) and Brian (Dad) for Mary.
// Seeds contacts that do not already exist by name (case-insensitive).
function seedDefaultContacts() {
  var defaults = [
    { name: 'Dorothy Brinck', relationship: 'Mom', type: 'family',
      phone: '', email: 'dorothy.brinck@gmail.com', message: '', photo: '' },
    { name: 'Brian Brinck',   relationship: 'Dad', type: 'family',
      phone: '', email: '',                          message: '', photo: '' }
  ];
  var existingNames = _contacts.map(function(c){ return (c.name || '').trim().toLowerCase(); });
  var added = 0;
  defaults.forEach(function(d) {
    if (existingNames.indexOf(d.name.toLowerCase()) === -1) {
      _contacts.push(d);
      added++;
    }
  });
  if (added === 0) {
    document.getElementById('save-status').textContent = 'âš ï¸ Default contacts already present.';
    return;
  }
  persistContacts();
}

/* â”€â”€ Pick from support network â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// Added 2026-03-01 by Claude: reads users/{studentUid}.supportNetwork,
// fetches each member's Firestore doc, and pre-fills a new contact form.
var _networkUsers = []; // cached array of { uid, name, email, role }

function loadSupportNetwork() {
  var body = document.getElementById('network-picker-body');
  if (!body) return;
  if (_networkUsers.length > 0) { renderNetworkPicker(); return; }
  body.innerHTML = '<em style="color:var(--muted);font-size:.85rem">Loading networkâ€¦</em>';

  /* AA is guaranteed ready here â€” loadSupportNetwork() only fires after auth
     completes and _studentUid is set. No waitForAA wrapper needed. */
  AA.db.collection('users').doc(_studentUid).get()
      .then(function(doc) {
        if (!doc.exists) {
          body.innerHTML = '<em style="color:var(--muted);font-size:.85rem">No support network found.</em>';
          return Promise.resolve([]);
        }
        var network = doc.data().supportNetwork || {};
        var uids = Object.keys(network);
        if (uids.length === 0) {
          body.innerHTML = '<em style="color:var(--muted);font-size:.85rem">Support network is empty.</em>';
          return Promise.resolve([]);
        }
        return Promise.all(uids.map(function(uid) {
          return AA.db.collection('users').doc(uid).get()
            .then(function(udoc) {
              var d = udoc.exists ? udoc.data() : {};
              return {
                uid:   uid,
                name:  d.displayName || d.name || uid,
                email: d.email || '',
                role:  (doc.data().supportNetwork)[uid] || 'member'
              };
            });
        }));
      })
      .then(function(users) {
        if (!users || users.length === 0) return;
        _networkUsers = users;
        renderNetworkPicker();
      })
      .catch(function(err) {
        console.error('[AA] loadSupportNetwork:', err);
        body.innerHTML = '<em style="color:var(--muted);font-size:.85rem">Error loading network.</em>';
      });
}

function renderNetworkPicker() {
  var body = document.getElementById('network-picker-body');
  if (!body || _networkUsers.length === 0) return;
  var opts = _networkUsers.map(function(u, i) {
    var label = esc(u.name) + ' (' + esc(u.role) + ')';
    if (u.email) label += ' â€” ' + esc(u.email);
    return '<option value="' + i + '">' + label + '</option>';
  }).join('');
  body.innerHTML =
    '<select id="network-user-select" style="width:100%;padding:.4rem .6rem;border-radius:6px;border:1px solid var(--border);font-size:.85rem;font-family:inherit;margin-bottom:.5rem">' +
      '<option value="">â€” Select a network member â€”</option>' +
      opts +
    '</select>' +
    '<button class="btn-save" onclick="pickFromNetwork()" style="font-size:.82rem;padding:.35rem .8rem">+ Add as Contact</button>';
}

function pickFromNetwork() {
  var sel = document.getElementById('network-user-select');
  if (!sel || sel.value === '') return;
  var u = _networkUsers[parseInt(sel.value, 10)];
  if (!u) return;
  _contacts.push({
    name:         u.name,
    relationship: u.role === 'network-lead' ? 'Network Lead' : 'Support Network',
    type:         'support',
    phone:        '',
    email:        u.email,
    message:      '',
    photo:        ''
  });
  renderEditForms();
  var cards = document.querySelectorAll('.edit-card');
  if (cards.length) cards[cards.length - 1].scrollIntoView({ behavior: 'smooth' });
}

/* â”€â”€ Auth boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
AA.auth.onAuthStateChanged(function(user) {
  if (!user) {
    hide('ec-loading');
    show('auth-gate');
    return;
  }

  _studentUid = window.AA_MIRROR_UID || user.uid;

  /* Mirror mode notice */
  if (window.AA_MIRROR_UID) {
    AA.db.collection('users').doc(window.AA_MIRROR_UID).get()
      .then(function(doc) {
        var name = (doc.exists && (doc.data().displayName || doc.data().name)) || 'student';
        document.getElementById('mirror-name').textContent = name;
        show('mirror-notice');
      }).catch(function() { show('mirror-notice'); });
  }

  /* Check if current user can edit:
     - backstage-manager: always
     - student on own page (no AA_MIRROR_UID): yes â€” students own their contacts
     - network-lead in student's network (mirror mode): yes
     Updated 2026-02-28 by Claude: was false for students on own page; now true. */
  var isAdmin = (typeof window.AA_ROLE !== 'undefined' && window.AA_ROLE === 'backstage-manager');

  if (isAdmin) {
    _canEdit = true;
    showEditSection();
  } else if (!window.AA_MIRROR_UID) {
    /* Student viewing their own emergency contacts â€” can edit */
    _canEdit = true;
    showEditSection();
  } else {
    /* Support network member in mirror mode â€” check if network-lead */
    AA.db.collection('users').doc(_studentUid).get()
      .then(function(doc) {
        if (!doc.exists) return;
        var network = doc.data().supportNetwork || {};
        var myRole  = network[user.uid];
        _canEdit = (myRole === 'network-lead');
        if (_canEdit) showEditSection();
      }).catch(function() {});
  }

  /* Real-time listener */
  if (_unsubContacts) _unsubContacts();
  _unsubContacts = AA.db.collection('emergencyContacts').doc(_studentUid)
    .onSnapshot(function(doc) {
      _contacts = (doc.exists && Array.isArray(doc.data().contacts))
        ? doc.data().contacts : [];
      renderContacts(_contacts);
      /* Only render edit forms on first load â€” after that, explicit user
         actions (add/save/delete) re-render. Prevents onSnapshot from
         wiping unsaved contact forms mid-edit. Fixed 2026-03-01 by Claude. */
      if (_canEdit && !_initialLoadDone) {
        renderEditForms();
        _initialLoadDone = true;
      }
    }, function(err) {
      console.error('[AA] emergencyContacts read:', err);
      hide('ec-loading');
      document.getElementById('ec-subtitle').textContent =
        'Could not load contacts â€” check permissions or try again.';
    });
});
</script>

<!-- Shared header loader -->
<script>
fetch('/Academic-Allies/modular/shared-header.html?v=20260301a')
  .then(function(r){ return r.text(); })
  .then(function(html){
    var container = document.getElementById('site-header');
    container.innerHTML = html;
    container.querySelectorAll('script').forEach(function(old) {
      var s = document.createElement('script');
      Array.from(old.attributes).forEach(function(a){ s.setAttribute(a.name, a.value); });
      s.textContent = old.textContent;
      old.replaceWith(s);
    });
    var drag = document.createElement('script');
    drag.src = '/Academic-Allies/modular/js/draggable.js';
    drag.onload = function(){ if (typeof initDrag === 'function') initDrag(); };
    document.body.appendChild(drag);
  })
  .catch(function(){});
</script>

</body>
</html>
