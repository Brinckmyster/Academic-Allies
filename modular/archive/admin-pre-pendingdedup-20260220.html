<!DOCTYPE html>
<!-- ============================================================
     admin.html â€” Academic Allies Admin Dashboard
     Rebuilt: 2026-02-18 by Claude
     Updated: 2026-02-20 by Claude â€” added Students/Support/Both filter to User Management table
     Updated: 2026-02-20 by Claude â€” added Archive button + Show Archived toggle to User Management table
     Uses aa-firebase.js (compat SDK) for real-time student data.
     Shows: Nope status (live), Flower Quiz progress, role editor.
     ============================================================ -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard â€” Academic Allies</title>
  <link rel="icon" href="/Academic-Allies/favicon.ico">

  <!-- Firebase compat CDN (must match aa-firebase.js) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Shared Firebase layer -->
  <script src="/Academic-Allies/modular/aa-firebase.js"></script>

  <style>
    /* â”€â”€ Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #0f1117;
      color: #e0e0e0;
      min-height: 100vh;
    }

    /* â”€â”€ Auth gate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #auth-gate {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: fixed;
      inset: 0;
      background: #0f1117;
      z-index: 900;
      gap: 24px;
    }
    #auth-gate h2 { color: #fff; font-size: 1.4rem; }
    #auth-gate p  { color: #888; font-size: 0.95rem; }
    #auth-gate .sign-in-btn {
      padding: 14px 32px;
      background: #4285F4;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      letter-spacing: 0.5px;
    }
    #auth-gate .sign-in-btn:hover { background: #3367D6; }

    /* â”€â”€ Access denied â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #access-denied {
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      position: fixed;
      inset: 0;
      background: #0f1117;
      z-index: 800;
      gap: 16px;
      text-align: center;
    }
    #access-denied h2 { color: #f44336; font-size: 1.4rem; }
    #access-denied p  { color: #888; }

    /* â”€â”€ Main layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #main-content {
      display: none;
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 60px;
    }

    /* â”€â”€ Page header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
      padding-bottom: 16px;
      border-bottom: 1px solid #2a2a3a;
    }
    .page-header h1 { font-size: 1.6rem; color: #fff; }
    .admin-badge {
      font-size: 0.7rem;
      background: #7c3aed;
      color: #fff;
      padding: 3px 10px;
      border-radius: 20px;
      margin-left: 12px;
      vertical-align: middle;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .header-actions { display: flex; gap: 10px; align-items: center; }
    .btn {
      padding: 8px 18px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      letter-spacing: 0.3px;
    }
    .btn-secondary { background: #2a2a3a; color: #ccc; }
    .btn-secondary:hover { background: #3a3a4a; }
    .btn-danger    { background: #c0392b; color: #fff; }
    .btn-danger:hover { background: #e74c3c; }

    /* â”€â”€ Section titles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-title {
      font-size: 1rem;
      font-weight: 600;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #2a2a3a;
    }

    /* â”€â”€ Student cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #student-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .student-card {
      background: #1a1a2e;
      border: 1px solid #2a2a3a;
      border-radius: 12px;
      padding: 20px;
      position: relative;
      transition: border-color 0.2s;
    }
    .student-card.nope-active    { border-color: #c0392b; }
    .student-card.semi-active    { border-color: #e67e22; }
    .student-card.recovery-active { border-color: #8e44ad; }

    .card-name {
      font-size: 1.05rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }
    .card-email {
      font-size: 0.78rem;
      color: #666;
      margin-bottom: 16px;
    }

    /* Nope status pill */
    .nope-status {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.3px;
      margin-bottom: 12px;
    }
    .nope-status.status-clear    { background: #1a3a1a; color: #4caf50; border: 1px solid #2e7d32; }
    .nope-status.status-nope     { background: #3a1a1a; color: #ef5350; border: 1px solid #c62828; }
    .nope-status.status-semi     { background: #3a2a1a; color: #ffa726; border: 1px solid #e65100; }
    .nope-status.status-recovery { background: #2a1a3a; color: #ce93d8; border: 1px solid #6a1b9a; }
    .nope-status .dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .status-clear    .dot { background: #4caf50; }
    .status-nope     .dot { background: #ef5350; animation: pulse 1.5s infinite; }
    .status-semi     .dot { background: #ffa726; animation: pulse 2s infinite; }
    .status-recovery .dot { background: #ce93d8; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .nope-time {
      font-size: 0.75rem;
      color: #666;
      margin-bottom: 14px;
    }

    /* Quiz progress */
    .quiz-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      font-size: 0.85rem;
      color: #bbb;
    }
    .quiz-label { min-width: 90px; color: #777; }
    .quiz-bar-wrap {
      flex: 1;
      background: #0f1117;
      border-radius: 4px;
      height: 6px;
      overflow: hidden;
    }
    .quiz-bar {
      height: 100%;
      border-radius: 4px;
      background: linear-gradient(90deg, #7c3aed, #a855f7);
      transition: width 0.4s;
    }
    .quiz-val { min-width: 36px; text-align: right; color: #aaa; }

    /* Energy level */
    .energy-row { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: #bbb; }
    .energy-label { min-width: 90px; color: #777; }
    .energy-pill {
      padding: 2px 10px;
      border-radius: 10px;
      font-size: 0.78rem;
      font-weight: 600;
    }
    .energy-high   { background: #1a3a1a; color: #4caf50; }
    .energy-medium { background: #3a2a1a; color: #ffa726; }
    .energy-low    { background: #3a1a1a; color: #ef5350; }
    .energy-none   { background: #2a2a3a; color: #666; }

    /* Recent log */
    .log-title {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #555;
      margin: 14px 0 8px;
    }
    .log-entry {
      font-size: 0.78rem;
      color: #777;
      padding: 4px 0;
      border-bottom: 1px solid #1e1e2e;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }
    .log-entry:last-child { border-bottom: none; }
    .log-event { color: #999; }
    .log-time  { color: #555; white-space: nowrap; }
    .log-empty { font-size: 0.78rem; color: #444; font-style: italic; }

    /* Loading spinner */
    .loading {
      text-align: center;
      color: #555;
      padding: 40px;
      font-size: 0.9rem;
    }

    /* â”€â”€ User management table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .table-wrap { overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.88rem;
    }
    th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #2a2a3a; }
    th { color: #888; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; }
    tr:hover td { background: #1a1a2e; }
    select {
      background: #0f1117;
      color: #ccc;
      border: 1px solid #3a3a4a;
      border-radius: 4px;
      padding: 5px 8px;
      font-size: 0.82rem;
    }
    .btn-small {
      padding: 5px 12px;
      background: #7c3aed;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.78rem;
    }
    .btn-small:hover { background: #9333ea; }

    /* â”€â”€ Role filter buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .role-filter {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
      align-items: center;
    }
    .role-filter span {
      font-size: 0.78rem;
      color: #666;
      margin-right: 4px;
    }
    .filter-btn {
      padding: 5px 16px;
      border-radius: 20px;
      border: 1px solid #3a3a4a;
      background: #1a1a2e;
      color: #888;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.15s;
      letter-spacing: 0.3px;
    }
    .filter-btn:hover { border-color: #6CA0A3; color: #ccc; }
    .filter-btn.active {
      background: #4a7f82;
      border-color: #4a7f82;
      color: #fff;
      font-weight: 600;
    }

    /* â”€â”€ Refresh bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .refresh-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      font-size: 0.78rem;
      color: #555;
    }
    .live-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.72rem;
      color: #4caf50;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .live-dot {
      width: 6px; height: 6px;
      background: #4caf50;
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }
  </style>
</head>
<body>

  <!-- Auth gate -->
  <div id="auth-gate">
    <h2>ğŸ” Admin Dashboard</h2>
    <p>Sign in with your admin Google account to continue.</p>
    <button class="sign-in-btn" onclick="AA.signInWithGoogle()">Sign in with Google</button>
  </div>

  <!-- Access denied -->
  <div id="access-denied">
    <h2>â›” Access Denied</h2>
    <p>This page requires an admin account.</p>
    <button class="btn btn-secondary" style="margin-top:12px" onclick="AA.signOut().then(()=>location.reload())">Sign Out</button>
  </div>

  <!-- Main content -->
  <div id="main-content">
    <!-- Shared site header -->
    <div id="site-header"></div>

    <!-- Page header -->
    <div class="page-header">
      <div>
        <h1>Admin Dashboard <span class="admin-badge">Admin</span></h1>
      </div>
      <div class="header-actions">
        <span id="admin-email" style="font-size:0.8rem;color:#666;"></span>
        <button class="btn btn-secondary" onclick="refreshQuizData()">â†» Refresh Quiz</button>
        <button class="btn btn-danger" onclick="AA.signOut().then(()=>location.reload())">Sign Out</button>
      </div>
    </div>

    <!-- Student dashboard -->
    <div class="section-title">
      Student Overview
      <span class="live-badge"><span class="live-dot"></span>Nope status live</span>
    </div>

    <div id="student-cards">
      <div class="loading">Loading studentsâ€¦</div>
    </div>

    <!-- User management -->
    <div class="section-title">User Management</div>
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:14px;">
      <div class="role-filter" style="margin-bottom:0;">
        <span>Show:</span>
        <button class="filter-btn active" id="filter-both"    onclick="setFilter('both')">Everyone</button>
        <button class="filter-btn"        id="filter-student" onclick="setFilter('student')">Students</button>
        <button class="filter-btn"        id="filter-support" onclick="setFilter('support')">Support Network</button>
      </div>
      <button id="toggle-archived-btn" onclick="toggleArchived()"
        style="padding:5px 14px;border-radius:20px;border:1px solid #555;background:transparent;color:#666;font-size:0.78rem;cursor:pointer;transition:all 0.15s;letter-spacing:0.3px;">
        ğŸ“¦ Show Archived
      </button>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Since</th>
            <th>Update</th>
            <th>Network</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="user-list">
          <tr><td colspan="5" class="loading">Loadingâ€¦</td></tr>
        </tbody>
      </table>

      <!-- â”€â”€ Invite New User â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div style="margin-top:28px;padding:20px 24px;background:#1a1a2e;border:1px solid #333;border-radius:10px;">
        <h3 style="margin-bottom:16px;color:#6CA0A3;font-size:1rem;letter-spacing:0.05em;text-transform:uppercase;">Invite New User</h3>
        <p style="font-size:13px;color:#888;margin-bottom:14px;">
          Enter their Google email. When they first sign in, they'll automatically get the role you pick here.
        </p>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
          <input type="email" id="invite-email" placeholder="amanda@example.com"
            style="flex:1;min-width:200px;padding:9px 12px;background:#0f1117;border:1px solid #444;border-radius:6px;color:#e0e0e0;font-size:14px;">
          <select id="invite-role"
            style="padding:9px 12px;background:#0f1117;border:1px solid #444;border-radius:6px;color:#e0e0e0;font-size:14px;">
            <option value="student">Student</option>
            <option value="nearby-help">Nearby Help</option>
            <option value="family">Family</option>
            <option value="support">Support</option>
            <option value="admin">Admin (Platform)</option>
          </select>
          <button onclick="inviteUser()"
            style="padding:9px 18px;background:#4a7f82;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;">
            Add
          </button>
        </div>
        <div id="invite-status" style="margin-top:10px;font-size:13px;min-height:18px;"></div>
        <div id="pending-list" style="margin-top:16px;"></div>
      </div>
    </div>
  </div>

  <script>
    /* â”€â”€ Shared header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    fetch('/Academic-Allies/modular/shared-header.html?v=20260220d')
      .then(function(r) { return r.text(); })
      .then(function(html) {
        var container = document.getElementById('site-header');
        container.innerHTML = html;
        container.querySelectorAll('script').forEach(function(old) {
          var s = document.createElement('script');
          Array.from(old.attributes).forEach(function(a) { s.setAttribute(a.name, a.value); });
          s.textContent = old.textContent;
          old.replaceWith(s);
        });
      });

    /* â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var _unsubNope = {};   // uid â†’ unsub function
    var _studentData = {}; // uid â†’ { user, nope, quiz, logs }
    var _allUsers      = []; // full user list for filtering
    var _roleFilter    = 'both';  // 'both' | 'student' | 'support'
    var _showArchived  = false;   // toggle to show/hide archived records

    /* â”€â”€ Auth gate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    AA.auth.onAuthStateChanged(function(user) {
      if (!user) {
        show('auth-gate');
        return;
      }
      if (!AA.isAdmin()) {
        show('access-denied');
        return;
      }
      // Admin confirmed â€” show dashboard
      show('main-content');
      document.getElementById('admin-email').textContent = user.email;
      loadDashboard();
      loadPendingUsers();
    });

    /* â”€â”€ Invite / pending-users functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function inviteUser() {
      var email  = (document.getElementById('invite-email').value || '').trim().toLowerCase();
      var role   = document.getElementById('invite-role').value;
      var status = document.getElementById('invite-status');

      if (!email || !email.includes('@')) {
        status.style.color   = '#ffc107';
        status.textContent   = 'âš ï¸ Please enter a valid email address.';
        return;
      }

      status.style.color = '#aaa';
      status.textContent = 'Savingâ€¦';

      AA.preRegisterEmail(email, role)
        .then(function () {
          status.style.color = '#28a745';
          status.textContent = 'âœ… ' + email + ' added as ' + role +
            '. They\'ll get this role automatically when they first sign in with Google.';
          document.getElementById('invite-email').value = '';
          loadPendingUsers();
        })
        .catch(function (err) {
          status.style.color = '#dc3545';
          status.textContent = 'âŒ Error: ' + err.message;
        });
    }

    function loadPendingUsers() {
      AA.getPendingUsers().then(function (snap) {
        var list = document.getElementById('pending-list');
        if (!list) return;
        if (snap.empty) {
          list.innerHTML = '<p style="font-size:12px;color:#666;">No pending invitations.</p>';
          return;
        }
        var rows = snap.docs.map(function (d) {
          var data = d.data();
          return '<tr>' +
            '<td style="padding:6px 10px;color:#ccc;">' + data.email + '</td>' +
            '<td style="padding:6px 10px;color:#6CA0A3;">' + (data.role || 'student') + '</td>' +
            '<td style="padding:6px 10px;">' +
              '<button onclick="cancelInvite(\'' + d.id.replace(/'/g,"\\'") + '\')" ' +
              'style="padding:3px 10px;background:#c0392b;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">' +
              'Cancel</button></td>' +
            '</tr>';
        }).join('');
        list.innerHTML =
          '<p style="font-size:12px;color:#888;margin-bottom:8px;">Pending invitations:</p>' +
          '<table style="width:100%;font-size:13px;border-collapse:collapse;">' +
          '<tr><th style="text-align:left;padding:4px 10px;color:#666;border-bottom:1px solid #333;">Email</th>' +
          '<th style="text-align:left;padding:4px 10px;color:#666;border-bottom:1px solid #333;">Role</th>' +
          '<th style="border-bottom:1px solid #333;"></th></tr>' +
          rows + '</table>';
      }).catch(function (err) {
        console.warn('[AA Admin] loadPendingUsers error:', err);
      });
    }

    function cancelInvite(email) {
      AA.cancelPendingUser(email)
        .then(function () { loadPendingUsers(); })
        .catch(function (err) { alert('Error cancelling: ' + err.message); });
    }

    function show(id) {
      ['auth-gate','access-denied','main-content'].forEach(function(x) {
        var el = document.getElementById(x);
        if (x === id) {
          el.style.display = (x === 'main-content') ? 'block' : 'flex';
        } else {
          el.style.display = 'none';
        }
      });
    }

    /* â”€â”€ Load dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function loadDashboard() {
      AA.db.collection('users').orderBy('createdAt').get()
        .then(function(snap) {
          // Clear old listeners
          Object.values(_unsubNope).forEach(function(u) { u(); });
          _unsubNope = {};
          _studentData = {};

          if (snap.empty) {
            document.getElementById('student-cards').innerHTML =
              '<div class="loading">No students found yet.</div>';
            document.getElementById('user-list').innerHTML =
              '<tr><td colspan="5" class="loading">No users found.</td></tr>';
            return;
          }

          // Render skeleton cards immediately, then fill in
          var students = [];
          snap.forEach(function(docSnap) { students.push({ id: docSnap.id, data: docSnap.data() }); });

          _allUsers = students;
          renderUserTable(students);

          var studentUsers = students.filter(function(s) { return s.data.role === 'student'; });

          if (studentUsers.length === 0) {
            document.getElementById('student-cards').innerHTML =
              '<div class="loading">No students found yet. Students appear here after they sign in.</div>';
            return;
          }

          // Build card skeletons
          document.getElementById('student-cards').innerHTML = '';
          studentUsers.forEach(function(s) {
            _studentData[s.id] = { user: s.data, nope: null, quiz: null, logs: [] };
            var card = document.createElement('div');
            card.className = 'student-card';
            card.id = 'card-' + s.id;
            card.innerHTML = buildCardHTML(s.id, s.data, null, null, []);
            document.getElementById('student-cards').appendChild(card);

            // Real-time nope listener
            _unsubNope[s.id] = AA.watchNope(s.id, function(nopeData) {
              _studentData[s.id].nope = nopeData;
              refreshCard(s.id);
            });

            // Quiz data (one-time load)
            loadQuizForStudent(s.id);
          });
        })
        .catch(function(err) {
          console.error('[AA Admin] loadDashboard error:', err);
          document.getElementById('student-cards').innerHTML =
            '<div class="loading" style="color:#f44336">Error loading students: ' + err.message + '</div>';
        });
    }

    function loadQuizForStudent(uid) {
      AA.getFlowerQuiz(uid).then(function(doc) {
        _studentData[uid].quiz = doc.exists ? doc.data() : null;
        // Also fetch recent nope logs
        return AA.db.collection('nope').doc(uid).collection('logs')
          .orderBy('timestamp', 'desc').limit(5).get();
      }).then(function(logSnap) {
        var logs = [];
        logSnap.forEach(function(l) { logs.push(l.data()); });
        _studentData[uid].logs = logs;
        refreshCard(uid);
      }).catch(function(err) {
        console.warn('[AA Admin] quiz/log load error for', uid, err);
      });
    }

    function refreshQuizData() {
      Object.keys(_studentData).forEach(function(uid) {
        loadQuizForStudent(uid);
      });
    }

    /* â”€â”€ Card rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function refreshCard(uid) {
      var d = _studentData[uid];
      if (!d) return;
      var card = document.getElementById('card-' + uid);
      if (!card) return;

      // Update card border class
      var mode = d.nope && d.nope.mode;
      card.className = 'student-card';
      if (mode === 'nope')          card.classList.add('nope-active');
      else if (mode === 'semi-nope') card.classList.add('semi-active');
      else if (mode === 'nope-recovery') card.classList.add('recovery-active');

      card.innerHTML = buildCardHTML(uid, d.user, d.nope, d.quiz, d.logs);
    }

    function buildCardHTML(uid, user, nope, quiz, logs) {
      var mode = nope && nope.mode;

      /* Nope status pill */
      var statusClass, statusDot, statusText;
      if (!mode || mode === null) {
        statusClass = 'status-clear';
        statusText  = 'âœ“ Clear';
      } else if (mode === 'nope') {
        statusClass = 'status-nope';
        statusText  = 'â›” NOPE DAY';
      } else if (mode === 'semi-nope') {
        statusClass = 'status-semi';
        statusText  = 'âš ï¸ Semi-Nope';
      } else if (mode === 'nope-recovery') {
        statusClass = 'status-recovery';
        statusText  = 'ğŸ’œ Recovery';
      } else {
        statusClass = 'status-clear';
        statusText  = mode;
      }

      /* Nope time */
      var timeStr = '';
      if (nope && nope.activatedAt) {
        try {
          var t = nope.activatedAt.toDate ? nope.activatedAt.toDate() : new Date(nope.activatedAt);
          timeStr = 'Since ' + formatTime(t);
        } catch(e) { timeStr = ''; }
      }

      /* Flower quiz */
      var flowerCount = quiz && typeof quiz.flowerCount === 'number' ? quiz.flowerCount : null;
      var energyLevel = quiz && quiz.energyLevel ? quiz.energyLevel : null;
      var TOTAL_FLOWERS = 31; // current flower list total
      var pct = flowerCount !== null ? Math.min(100, Math.round(flowerCount / TOTAL_FLOWERS * 100)) : 0;

      var energyClass = 'energy-none', energyLabel = 'Not set';
      if (energyLevel === 'high')   { energyClass = 'energy-high';   energyLabel = 'ğŸŸ¢ High'; }
      if (energyLevel === 'medium') { energyClass = 'energy-medium'; energyLabel = 'ğŸŸ¡ Medium'; }
      if (energyLevel === 'low')    { energyClass = 'energy-low';    energyLabel = 'ğŸ”´ Low'; }

      /* Recent logs */
      var logsHTML = '';
      if (logs && logs.length > 0) {
        logsHTML = logs.map(function(l) {
          var ts = '';
          try {
            var d = l.timestamp && l.timestamp.toDate ? l.timestamp.toDate() : new Date(l.timestamp);
            ts = formatTime(d);
          } catch(e) { ts = ''; }
          return '<div class="log-entry"><span class="log-event">' + escHtml(l.event || 'â€”') +
                 '</span><span class="log-time">' + ts + '</span></div>';
        }).join('');
      } else {
        logsHTML = '<div class="log-empty">No activity logged yet.</div>';
      }

      return [
        '<div class="card-name">', escHtml(user.displayName || user.email), '</div>',
        '<div class="card-email">', escHtml(user.email), '</div>',

        '<div class="nope-status ', statusClass, '">',
          '<span class="dot"></span>', statusText,
        '</div>',

        timeStr ? '<div class="nope-time">' + escHtml(timeStr) + '</div>' : '',

        '<div class="quiz-row">',
          '<span class="quiz-label">Flowers seen</span>',
          '<div class="quiz-bar-wrap"><div class="quiz-bar" style="width:', pct, '%"></div></div>',
          '<span class="quiz-val">', flowerCount !== null ? flowerCount : 'â€”', ' / ', TOTAL_FLOWERS, '</span>',
        '</div>',

        '<div class="energy-row">',
          '<span class="energy-label">Energy today</span>',
          '<span class="energy-pill ', energyClass, '">', energyLabel, '</span>',
        '</div>',

        '<div class="log-title">Recent Activity</div>',
        logsHTML
      ].join('');
    }

    /* â”€â”€ Role filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function setFilter(filter) {
      _roleFilter = filter;
      ['both','student','support'].forEach(function(f) {
        var btn = document.getElementById('filter-' + f);
        if (btn) btn.className = 'filter-btn' + (f === filter ? ' active' : '');
      });
      renderUserTable(_allUsers);
    }

    /* â”€â”€ User management table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderUserTable(users) {
      var filtered = users.filter(function(u) {
        var r = u.data.role;
        var archived = u.data.archived === true;
        // Archive visibility
        if (!_showArchived && archived) return false;
        if (_showArchived  && !archived) return false;
        // Role filter (skip when viewing archived â€” show all roles)
        if (!archived) {
          if (_roleFilter === 'student') return r === 'student';
          if (_roleFilter === 'support') return ['support','family','nearby-help'].indexOf(r) !== -1;
          return true; // 'both'/Everyone: show all roles
        }
        return true;
      });
      var tbody = document.getElementById('user-list');
      if (!filtered.length) {
        var msg = _showArchived ? 'No archived users.' : 'No users match this filter.';
        tbody.innerHTML = '<tr><td colspan="7" class="loading">' + msg + '</td></tr>';
        return;
      }
      tbody.innerHTML = filtered.map(function(u) {
        var d = u.data;
        var since = '';
        try {
          if (d.createdAt) {
            var t = d.createdAt.toDate ? d.createdAt.toDate() : new Date(d.createdAt);
            since = t.toLocaleDateString();
          }
        } catch(e) { since = ''; }

        var opts = ['student','nearby-help','family','support','admin'].map(function(r) {
          return '<option value="' + r + '"' + (d.role === r ? ' selected' : '') + '>' + r + '</option>';
        }).join('');

        var isArchived = d.archived === true;
        var rowStyle   = isArchived ? ' style="opacity:0.45;"' : '';
        var archiveBtn = isArchived
          ? '<button class="btn-small" style="background:#2e7d32;" onclick="restoreUser(\'' + u.id + '\')">â†© Restore</button>'
          : '<button class="btn-small" style="background:#555;" onclick="archiveUser(\'' + u.id + '\')">ğŸ“¦ Archive</button>';

        return [
          '<tr', rowStyle, '>',
            '<td>', escHtml(d.displayName || 'â€”'), isArchived ? ' <span style="font-size:0.7rem;color:#888;">(archived)</span>' : '', '</td>',
            '<td>', escHtml(d.email || 'â€”'), '</td>',
            '<td><select id="role-', u.id, '"', isArchived ? ' disabled' : '', '>', opts, '</select></td>',
            '<td style="color:#555;font-size:0.8rem">', since, '</td>',
            '<td>', isArchived ? '' : '<button class="btn-small" onclick="updateRole(\'' + u.id + '\')">Save</button>', '</td>',
            '<td><a href="/Academic-Allies/modular/components/user-tiers/user-tiers.html?v=20260220d&student=', u.id, '" style="font-size:12px;color:#4a9eff;">Manage Network</a></td>',
            '<td>', archiveBtn, '</td>',
          '</tr>'
        ].join('');
      }).join('');
    }

    window.updateRole = function(uid) {
      var sel = document.getElementById('role-' + uid);
      if (!sel) return;
      AA.db.collection('users').doc(uid).update({ role: sel.value })
        .then(function() { alert('Role updated to: ' + sel.value); })
        .catch(function(err) { alert('Error: ' + err.message); });
    };

    /* â”€â”€ Archive / Restore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    window.archiveUser = function(uid) {
      if (!confirm('Archive this user? They won\'t be deleted â€” you can restore them anytime.')) return;
      AA.db.collection('users').doc(uid).update({ archived: true, archivedAt: new Date() })
        .then(function() {
          // Update local cache
          var u = _allUsers.find(function(x) { return x.id === uid; });
          if (u) u.data.archived = true;
          renderUserTable(_allUsers);
        })
        .catch(function(err) { alert('Error archiving: ' + err.message); });
    };

    window.restoreUser = function(uid) {
      AA.db.collection('users').doc(uid).update({ archived: false, archivedAt: null })
        .then(function() {
          var u = _allUsers.find(function(x) { return x.id === uid; });
          if (u) u.data.archived = false;
          renderUserTable(_allUsers);
        })
        .catch(function(err) { alert('Error restoring: ' + err.message); });
    };

    window.toggleArchived = function() {
      _showArchived = !_showArchived;
      var btn = document.getElementById('toggle-archived-btn');
      if (btn) {
        btn.textContent  = _showArchived ? 'ğŸ‘¥ Show Active' : 'ğŸ“¦ Show Archived';
        btn.style.color  = _showArchived ? '#ffa726' : '#666';
        btn.style.border = _showArchived ? '1px solid #ffa726' : '1px solid #555';
      }
      renderUserTable(_allUsers);
    };

    /* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function formatTime(date) {
      var now = new Date();
      var diff = Math.floor((now - date) / 1000);
      if (diff < 60)  return 'Just now';
      if (diff < 3600) return Math.floor(diff/60) + 'm ago';
      if (diff < 86400) return Math.floor(diff/3600) + 'h ago';
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
    }

    function escHtml(s) {
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;');
    }
  </script>
</body>
</html>
