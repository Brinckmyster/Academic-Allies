<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Support Network â€” Academic Allies</title>
  <link rel="icon" href="/Academic-Allies/favicon.ico">
  <style>
    body { font-family: 'Atkinson Hyperlegible', Arial, sans-serif; background: #FAFAF9; color: #333; margin: 0; padding: 20px; }
    .page-wrap { max-width: 760px; margin: 0 auto; padding-top: 16px; }
    h1 { color: #4a7f82; font-size: 1.6rem; margin: 0 0 4px; }
    .sub { color: #888; font-size: 0.95rem; margin-bottom: 28px; }

    /* Admin picker (Bruise only) */
    #student-picker-wrap { background: #e8f2f3; border: 1px solid #b2d4d7; border-radius: 10px; padding: 14px 18px; margin-bottom: 24px; display: none; }
    #student-picker-wrap label { font-weight: 600; font-size: 0.9rem; color: #4a7f82; display: block; margin-bottom: 8px; }
    #student-picker { padding: 8px 12px; border: 1px solid #b2d4d7; border-radius: 6px; font-size: 14px; background: #fff; width: 100%; max-width: 340px; }

    /* Network cards */
    #network-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 24px; }
    .network-card {
      background: #fff; border: 1px solid #e1e5e9; border-radius: 10px;
      padding: 14px 18px; display: flex; align-items: center; gap: 14px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .network-card.owner-card { border-color: #4a7f82; background: #f0f8f8; }
    .tier-badge {
      display: inline-block; padding: 3px 10px; border-radius: 20px;
      font-size: 0.78rem; font-weight: 700; color: #fff; white-space: nowrap;
    }
    .badge-owner      { background: #4a7f82; }
    .badge-admin      { background: #6366f1; }
    .badge-family     { background: #f59e0b; }
    .badge-support    { background: #10b981; }
    .badge-nearby-help { background: #f97316; }

    .card-info { flex: 1; min-width: 0; }
    .card-name { font-weight: 600; font-size: 1rem; color: #222; }
    .card-email { font-size: 0.82rem; color: #888; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .card-desc  { font-size: 0.8rem; color: #aaa; margin-top: 3px; }

    .card-actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
    .tier-select-sm { padding: 5px 8px; border: 1px solid #ccc; border-radius: 6px; font-size: 13px; background: #fff; }
    .btn-save   { padding: 5px 12px; background: #4a7f82; color: #fff; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; }
    .btn-save:hover { background: #3d6e71; }
    .btn-remove { padding: 5px 10px; background: #fff; color: #c0392b; border: 1px solid #e0b4b4; border-radius: 6px; font-size: 13px; cursor: pointer; }
    .btn-remove:hover { background: #fdf2f2; }

    /* Add person panel */
    .add-panel { background: #fff; border: 1px solid #e1e5e9; border-radius: 10px; padding: 18px 20px; }
    .add-panel h3 { margin: 0 0 14px; font-size: 1rem; color: #4a7f82; }
    .add-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .add-row input  { flex: 1; min-width: 180px; padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
    .add-row select { padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; background: #fff; }
    .add-row button { padding: 8px 18px; background: #4a7f82; color: #fff; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; font-weight: 600; }
    .add-row button:hover { background: #3d6e71; }
    #add-status { margin-top: 10px; font-size: 0.88rem; min-height: 18px; }
    #add-status.ok  { color: #10b981; }
    #add-status.err { color: #c0392b; }

    /* Mirror mode banner */
    #mirror-banner {
      display: none;
      background: linear-gradient(135deg, #e8eeff 0%, #f0f4ff 100%);
      border: 2px solid #a5b4fc;
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 24px;
    }
    #mirror-banner .mirror-icon { font-size: 2rem; float: left; margin-right: 14px; line-height: 1; }
    #mirror-banner h2 { margin: 0 0 4px; font-size: 1.1rem; color: #4338ca; }
    #mirror-banner p  { margin: 0; font-size: 0.88rem; color: #6366f1; }
    .mirror-mode h1   { color: #6366f1; }
    .mirror-mode .sub { color: #818cf8; }

    /* State messages */
    #loading-msg, #signin-msg { text-align: center; padding: 40px; color: #aaa; font-size: 1rem; }
  </style>
</head>
<body>
  <div id="site-header"></div>

  <div class="page-wrap">
    <h1 id="page-title">ğŸ‘¥ My Support Network</h1>
    <p class="sub" id="page-sub">You're the boss â€” assign who can see your info and how much they can help.</p>

    <!-- Mirror mode banner (non-student roles) -->
    <div id="mirror-banner">
      <span class="mirror-icon">ğŸª</span>
      <h2 id="mirror-title">You're in Mirror View</h2>
      <p id="mirror-desc">You have read-only access to the networks you're part of. The student controls their own network.</p>
      <div style="clear:both;"></div>
    </div>

    <!-- Platform admin: pick which student's network to manage -->
    <div id="student-picker-wrap">
      <label for="student-picker">âš™ï¸ Admin view â€” managing network for:</label>
      <select id="student-picker" onchange="switchStudent(this.value)">
        <option value="">â€” select a student â€”</option>
      </select>
    </div>

    <div id="loading-msg">Loading your networkâ€¦</div>
    <div id="signin-msg" style="display:none;">Please sign in to manage your support network.</div>

    <!-- Network member cards -->
    <div id="network-list" style="display:none;"></div>

    <!-- Add someone -->
    <div class="add-panel" id="add-panel" style="display:none;">
      <h3>â• Add someone to your network</h3>
      <div class="add-row">
        <input type="email" id="add-email" placeholder="their-email@example.com">
        <select id="add-tier">
          <option value="nearby-help">Nearby Help</option>
          <option value="family">Family</option>
          <option value="support">Support</option>
          <option value="admin">Admin</option>
        </select>
        <button onclick="addMember()">Add</button>
      </div>
      <div id="add-status"></div>
    </div>
  </div>

  <!-- Load shared header -->
  <script>
    fetch('/Academic-Allies/modular/shared-header.html')
      .then(function(r) { return r.text(); })
      .then(function(html) {
        var c = document.getElementById('site-header');
        c.innerHTML = html;
        c.querySelectorAll('script').forEach(function(old) {
          var s = document.createElement('script');
          Array.from(old.attributes).forEach(function(a) { s.setAttribute(a.name, a.value); });
          s.textContent = old.textContent;
          old.replaceWith(s);
        });
      });
  </script>

  <script>
    /* â”€â”€ Tier display metadata â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var TIERS = {
      'admin':       { label: 'Admin',        badge: 'badge-admin',       desc: 'Trusted support â€” can help manage your data' },
      'family':      { label: 'Family',        badge: 'badge-family',      desc: 'View logs and send messages' },
      'support':     { label: 'Support',       badge: 'badge-support',     desc: 'School staff / counselor â€” read-only' },
      'nearby-help': { label: 'Nearby Help',   badge: 'badge-nearby-help', desc: 'Local friend for emergency alerts' }
    };

    /* Which student's network we're currently viewing/editing */
    var currentStudentUid  = null;
    var currentStudentName = null;
    var isPlatformAdmin    = false;
    var isMirrorMode       = false;   // true for support/family/nearby-help roles

    /* Everyone except student gets mirror (read-only) view.
       Student is sudo â€” they own their own network. */
    var MIRROR_ROLES = ['admin', 'support', 'family', 'nearby-help'];

    /* â”€â”€ Wait for AA to be ready, then boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function waitForAA(cb, tries) {
      tries = tries || 0;
      if (window.AA && window.AA.auth) { cb(); return; }
      if (tries > 40) { showError('Could not connect to Firebase.'); return; }
      setTimeout(function() { waitForAA(cb, tries + 1); }, 200);
    }

    function boot() {
      AA.auth.onAuthStateChanged(function(user) {
        if (!user) {
          document.getElementById('loading-msg').style.display = 'none';
          document.getElementById('signin-msg').style.display  = 'block';
          return;
        }

        /* Check platform role */
        AA.getUserDoc(user.uid).then(function(doc) {
          if (!doc.exists) { showError('Your profile isn\'t set up yet â€” try signing out and back in.'); return; }
          var data = doc.data();
          isPlatformAdmin = (data.role === 'admin');

          if (data.role === 'student') {
            /* Student = sudo. Full boss controls over their own network. */
            loadNetwork(user.uid, data.displayName || user.displayName || 'You');

          } else if (isPlatformAdmin) {
            /* Platform admin = mirror, but with a student picker to choose whose network to view */
            isMirrorMode = true;
            document.getElementById('student-picker-wrap').style.display = 'block';
            loadStudentPicker().then(applyUrlParam);
            activateMirrorBanner('admin', data.displayName || user.displayName || 'You');
            document.getElementById('loading-msg').style.display = 'none';

          } else if (MIRROR_ROLES.indexOf(data.role) !== -1) {
            /* Support / Family / Nearby Help â†’ mirror mode, auto-find their student */
            isMirrorMode = true;
            activateMirrorMode(data.role, data.displayName || user.displayName || 'You');
          }
        });
      });
    }

    /* â”€â”€ Mirror mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var MIRROR_LABELS = {
      'admin':       'Platform Admin',
      'support':     'Support Member',
      'family':      'Family Member',
      'nearby-help': 'Nearby Help'
    };

    /* Just show the banner (used by admin who has their own picker) */
    function activateMirrorBanner(role, name) {
      var label = MIRROR_LABELS[role] || role;
      document.querySelector('.page-wrap').classList.add('mirror-mode');
      document.getElementById('page-title').textContent = 'ğŸª Network Mirror';
      document.getElementById('page-sub').textContent   = 'Read-only view â€” the student is sudo and controls their own network.';
      var banner = document.getElementById('mirror-banner');
      banner.style.display = 'block';
      document.getElementById('mirror-title').textContent =
        'You\'re signed in as ' + esc(name) + ' (' + label + ')';
      document.getElementById('mirror-desc').textContent =
        'Students own their support networks. You can view any network but cannot add, remove, or change roles.';
    }

    /* Full mirror mode: show banner + auto-find which student(s) this person belongs to */
    function activateMirrorMode(role, name) {
      activateMirrorBanner(role, name);

      /* Try to find which student(s) this person is in the network of */
      document.getElementById('loading-msg').textContent = 'Finding your network connectionsâ€¦';

      AA.db.collection('users').get().then(function(snap) {
        var uid    = AA.auth.currentUser.uid;
        var found  = [];
        snap.forEach(function(doc) {
          var d = doc.data();
          if (d.supportNetwork && d.supportNetwork[uid]) {
            found.push({ uid: doc.id, data: d, tier: d.supportNetwork[uid] });
          }
        });

        if (found.length === 0) {
          document.getElementById('loading-msg').textContent =
            'You\'re not currently part of any student\'s support network. ' +
            'Ask your student to add you at this page.';
          return;
        }

        /* Show each student's network in read-only mode */
        document.getElementById('loading-msg').style.display = 'none';
        found.forEach(function(s) {
          loadNetwork(s.uid, s.data.displayName || s.data.email);
        });
      }).catch(function(err) {
        showError('Could not load network connections: ' + err.message);
      });
    }

    /* â”€â”€ Admin: load student picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function loadStudentPicker() {
      return AA.getAllStudents().then(function(students) {
        var sel = document.getElementById('student-picker');
        students.forEach(function(s) {
          var opt = document.createElement('option');
          opt.value       = s.uid;
          opt.textContent = (s.data.displayName || s.data.email) + ' â€” ' + s.data.email;
          sel.appendChild(opt);
        });
      });
    }

    function switchStudent(uid) {
      if (!uid) {
        document.getElementById('network-list').style.display = 'none';
        document.getElementById('add-panel').style.display    = 'none';
        return;
      }
      AA.getUserDoc(uid).then(function(doc) {
        if (!doc.exists) return;
        var d = doc.data();
        loadNetwork(uid, d.displayName || d.email);
      });
    }

    /* â”€â”€ Load and render a student's network â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function loadNetwork(studentUid, studentName) {
      currentStudentUid  = studentUid;
      currentStudentName = studentName;
      document.getElementById('loading-msg').style.display = 'block';
      document.getElementById('network-list').style.display = 'none';
      document.getElementById('add-panel').style.display    = 'none';

      AA.getUserDoc(studentUid).then(function(doc) {
        if (!doc.exists) { showError('No profile found.'); return; }
        var data    = doc.data();
        var network = data.supportNetwork || {};

        /* Collect member uids to look up */
        var memberUids = Object.keys(network);

        /* Fetch display names for all members */
        var fetches = memberUids.map(function(uid) {
          return AA.getUserDoc(uid).then(function(d) {
            return { uid: uid, tier: network[uid], data: d.exists ? d.data() : null };
          });
        });

        Promise.all(fetches).then(function(members) {
          renderNetwork(studentUid, studentName, members);
        });
      }).catch(function(err) {
        showError('Error loading network: ' + err.message);
      });
    }

    /* â”€â”€ Render the network list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderNetwork(studentUid, studentName, members) {
      var list = document.getElementById('network-list');
      list.innerHTML = '';

      /* Owner card â€” always first */
      var ownerCard = document.createElement('div');
      ownerCard.className = 'network-card owner-card';
      ownerCard.innerHTML =
        '<span class="tier-badge badge-owner">Owner</span>' +
        '<div class="card-info">' +
          '<div class="card-name">' + esc(studentName) + ' (You)</div>' +
          '<div class="card-desc">Full control â€” this is your network</div>' +
        '</div>';
      list.appendChild(ownerCard);

      /* Member cards */
      members.forEach(function(m) {
        var tierInfo = TIERS[m.tier] || { label: m.tier, badge: 'badge-support', desc: '' };
        var name  = m.data ? (m.data.displayName || m.data.email) : '(unknown user)';
        var email = m.data ? m.data.email : m.uid;

        var card = document.createElement('div');
        card.className = 'network-card';
        card.id = 'card-' + m.uid;

        /* Build tier selector */
        var tierOpts = Object.keys(TIERS).map(function(t) {
          return '<option value="' + t + '"' + (t === m.tier ? ' selected' : '') + '>' + TIERS[t].label + '</option>';
        }).join('');

        /* Mirror mode: no edit controls */
        var actionsHtml = isMirrorMode
          ? '<div class="card-actions"><span style="font-size:12px;color:#818cf8;">read-only</span></div>'
          : '<div class="card-actions">' +
              '<select class="tier-select-sm" id="tier-' + m.uid + '" onchange="updateBadge(\'' + m.uid + '\', this.value)">' +
                tierOpts +
              '</select>' +
              '<button class="btn-save" onclick="saveTier(\'' + m.uid + '\')">Save</button>' +
              '<button class="btn-remove" onclick="removeMember(\'' + m.uid + '\', \'' + esc(name) + '\')">Remove</button>' +
            '</div>';

        card.innerHTML =
          '<span class="tier-badge ' + tierInfo.badge + '">' + tierInfo.label + '</span>' +
          '<div class="card-info">' +
            '<div class="card-name">' + esc(name) + '</div>' +
            '<div class="card-email">' + esc(email) + '</div>' +
            '<div class="card-desc">' + tierInfo.desc + '</div>' +
          '</div>' +
          actionsHtml;

        list.appendChild(card);
      });

      document.getElementById('loading-msg').style.display  = 'none';
      list.style.display                                      = 'flex';
      /* Only show Add panel if the viewer is the student (boss controls) */
      if (!isMirrorMode) {
        document.getElementById('add-panel').style.display = 'block';
      }
    }

    /* Update the badge color live when tier dropdown changes */
    function updateBadge(memberUid, newTier) {
      var card = document.getElementById('card-' + memberUid);
      if (!card) return;
      var badge    = card.querySelector('.tier-badge');
      var descEl   = card.querySelector('.card-desc');
      var tierInfo = TIERS[newTier] || { label: newTier, badge: 'badge-support', desc: '' };
      badge.className   = 'tier-badge ' + tierInfo.badge;
      badge.textContent = tierInfo.label;
      if (descEl) descEl.textContent = tierInfo.desc;
    }

    /* Save a tier change */
    function saveTier(memberUid) {
      var sel  = document.getElementById('tier-' + memberUid);
      var tier = sel ? sel.value : null;
      if (!tier || !currentStudentUid) return;
      AA.setNetworkMember(currentStudentUid, memberUid, tier)
        .then(function() { flashSaved(memberUid); })
        .catch(function(err) { alert('Save failed: ' + err.message); });
    }

    function flashSaved(memberUid) {
      var btn = document.querySelector('#card-' + memberUid + ' .btn-save');
      if (!btn) return;
      var orig = btn.textContent;
      btn.textContent = 'âœ“ Saved';
      btn.style.background = '#10b981';
      setTimeout(function() { btn.textContent = orig; btn.style.background = ''; }, 1800);
    }

    /* Remove a member */
    function removeMember(memberUid, name) {
      if (!confirm('Remove ' + name + ' from your support network?')) return;
      AA.removeNetworkMember(currentStudentUid, memberUid)
        .then(function() { loadNetwork(currentStudentUid, currentStudentName); })
        .catch(function(err) { alert('Remove failed: ' + err.message); });
    }

    /* â”€â”€ Add a new member â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function addMember() {
      var emailInput = document.getElementById('add-email');
      var tierSelect = document.getElementById('add-tier');
      var status     = document.getElementById('add-status');
      var email      = emailInput.value.trim().toLowerCase();
      var tier       = tierSelect.value;

      status.className = '';
      status.textContent = '';

      if (!email) { setStatus('err', 'Please enter an email address.'); return; }
      if (!currentStudentUid) { setStatus('err', 'No student selected.'); return; }

      setStatus('', 'Looking up ' + email + 'â€¦');

      AA.lookupUserByEmail(email).then(function(result) {
        if (!result) {
          setStatus('err', 'âŒ No Academic Allies account found for ' + email + '. They need to sign in at least once first.');
          return;
        }
        if (result.uid === currentStudentUid) {
          setStatus('err', 'âŒ You can\'t add yourself â€” you\'re already the owner!');
          return;
        }
        return AA.setNetworkMember(currentStudentUid, result.uid, tier)
          .then(function() {
            setStatus('ok', 'âœ… ' + (result.data.displayName || email) + ' added as ' + TIERS[tier].label + '!');
            emailInput.value = '';
            loadNetwork(currentStudentUid, currentStudentName);
          });
      }).catch(function(err) {
        setStatus('err', 'âŒ Error: ' + err.message);
      });
    }

    function setStatus(cls, msg) {
      var s = document.getElementById('add-status');
      s.className   = cls;
      s.textContent = msg;
    }

    function showError(msg) {
      document.getElementById('loading-msg').textContent = msg;
    }

    /* HTML escape helper */
    function esc(str) {
      return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    /* If admin arrived via ?student=uid link, auto-select that student */
    function applyUrlParam() {
      var params = new URLSearchParams(window.location.search);
      var uid    = params.get('student');
      if (!uid || !isPlatformAdmin) return;
      var sel = document.getElementById('student-picker');
      if (sel) { sel.value = uid; switchStudent(uid); }
    }

    /* Boot when AA is ready */
    waitForAA(boot);
  </script>
</body>
</html>
