<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Academic Allies - Your disability accommodations and support network</title>
  <link rel="icon" type="image/x-icon" href="/Academic-Allies/favicon.ico">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Atkinson Hyperlegible', Arial, sans-serif;
      background: #FAFAF9;
      color: #333;
      min-height: 100vh;
    }

    /* â”€â”€ Hero â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hero {
      background: linear-gradient(135deg, #6CA0A3 0%, #4a7f82 100%);
      color: white;
      padding: 32px 24px 28px;
      text-align: center;
    }
    .hero-greeting {
      font-size: 22pt;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .hero-date {
      font-size: 12pt;
      opacity: 0.85;
      margin-bottom: 20px;
    }

    /* â”€â”€ Today's status bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .status-bar {
      display: flex;
      justify-content: center;
      gap: 14px;
      flex-wrap: wrap;
    }
    .status-pill {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.35);
      border-radius: 20px;
      padding: 6px 14px;
      font-size: 11pt;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .status-pill.alert-yellow { background: #fff3cd; border-color: #ffc107; color: #856404; }
    .status-pill.alert-red    { background: #f8d7da; border-color: #dc3545; color: #721c24; }
    .status-pill.alert-green  { background: rgba(255,255,255,0.25); }

    /* â”€â”€ Check-in prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .checkin-prompt {
      max-width: 680px;
      margin: 20px auto 0;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 14px;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      flex-wrap: wrap;
    }
    .checkin-prompt p { font-size: 13pt; opacity: 0.95; }
    .checkin-prompt a {
      background: white;
      color: #4a7f82;
      font-weight: 700;
      padding: 10px 22px;
      border-radius: 20px;
      text-decoration: none;
      font-size: 12pt;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .checkin-prompt a:hover { background: #f0f0f0; }

    /* â”€â”€ Main content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dashboard { max-width: 1100px; margin: 0 auto; padding: 32px 24px; }

    /* â”€â”€ Section headers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-label {
      font-size: 11pt;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: #6CA0A3;
      margin-bottom: 14px;
      margin-top: 32px;
      border-bottom: 2px solid #e8f2f3;
      padding-bottom: 6px;
    }
    .section-label:first-child { margin-top: 0; }

    /* â”€â”€ Module grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .module-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 16px;
    }
    .module-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 28px 12px;
      background: #fff;
      border: 1px solid #e1e5e9;
      border-radius: 14px;
      text-decoration: none;
      color: #333;
      font-weight: 600;
      font-size: 0.9rem;
      transition: box-shadow 0.2s, transform 0.2s, border-color 0.2s;
      cursor: pointer;
    }
    .module-card:hover {
      box-shadow: 0 4px 16px rgba(108,160,163,0.18);
      transform: translateY(-2px);
      border-color: #6CA0A3;
      color: #4a7f82;
    }
    .module-icon { font-size: 2rem; line-height: 1; }
    .module-name { text-align: center; line-height: 1.3; }
    .admin-card { border-style: dashed; opacity: 0.75; }

    /* â”€â”€ Flag summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .flag-summary {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 14px;
    }
    .flag-card {
      background: white;
      border-radius: 14px;
      border: 1px solid #e1e5e9;
      padding: 18px 20px;
    }
    .flag-card .flag-label { font-size: 11pt; color: #888; margin-bottom: 4px; }
    .flag-card .flag-value { font-size: 16pt; font-weight: 700; color: #333; }
    .flag-card .flag-sub   { font-size: 10pt; color: #aaa; margin-top: 2px; }
    .flag-card.green { border-left: 4px solid #28a745; }
    .flag-card.yellow { border-left: 4px solid #ffc107; }
    .flag-card.red    { border-left: 4px solid #dc3545; }

    /* â”€â”€ Resources â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .resource-list {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .resource-link {
      background: white;
      border: 1px solid #e1e5e9;
      border-radius: 10px;
      padding: 12px 18px;
      text-decoration: none;
      color: #4a7f82;
      font-size: 12pt;
      font-weight: 600;
      transition: border-color 0.2s, box-shadow 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .resource-link:hover {
      border-color: #6CA0A3;
      box-shadow: 0 2px 8px rgba(108,160,163,0.15);
    }
    .resource-link .ricon { font-size: 18pt; }

    /* â”€â”€ Support view: student status cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* Added 2026-02-26 by Claude */
    .student-status-card {
      background: #fff;
      border: 1px solid #e1e5e9;
      border-radius: 12px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      text-decoration: none;
      color: inherit;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .student-status-card:hover { border-color: #6CA0A3; box-shadow: 0 3px 10px rgba(108,160,163,0.2); }
    .ssc-dot {
      width: 18px; height: 18px; border-radius: 50%; flex-shrink: 0;
      box-shadow: 0 0 0 3px rgba(0,0,0,0.08);
    }
    .ssc-dot.nope   { background: #dc3545; animation: pulse-dot 1.4s ease-in-out infinite; }
    .ssc-dot.red    { background: #dc3545; }
    .ssc-dot.orange { background: #fd7e14; }
    .ssc-dot.yellow { background: #ffc107; }
    .ssc-dot.green  { background: #28a745; }
    .ssc-dot.unknown { background: #ccc; }
    @keyframes pulse-dot {
      0%, 100% { box-shadow: 0 0 0 3px rgba(220,53,69,0.2); }
      50%       { box-shadow: 0 0 0 7px rgba(220,53,69,0.1); }
    }
    .ssc-info { flex: 1; min-width: 0; }
    .ssc-name { font-weight: 700; font-size: 1rem; color: #222; }
    .ssc-status { font-size: 0.85rem; color: #666; margin-top: 3px; }
    .ssc-time   { font-size: 0.78rem; color: #aaa; margin-top: 2px; }
    .ssc-link   { font-size: 0.8rem; color: #4a7f82; font-weight: 600; flex-shrink: 0; }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .site-footer {
      margin-top: 60px;
      border-top: 1px solid #e1e5e9;
      padding: 20px 24px;
      background: #f8f9fa;
    }
    .footer-content {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      align-items: center;
      font-size: 0.875rem;
      color: #666;
    }
    .footer-content a { color: #4a7f82; text-decoration: none; }
    .footer-content a:hover { text-decoration: underline; }

    /* â”€â”€ NOPE button banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .nope-banner {
      display: flex;
      align-items: center;
      gap: 18px;
      margin-bottom: 28px;
      padding: 18px 22px;
      background: #1c0505;
      border: 2px solid #8b0000;
      border-radius: 12px;
    }
    .nope-big-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 16px 32px;
      background: #c0392b;
      color: #fff;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: 0.05em;
      text-decoration: none;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 18px rgba(192,57,43,0.45);
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .nope-big-btn:hover {
      background: #a93226;
      transform: scale(1.04);
      box-shadow: 0 6px 24px rgba(192,57,43,0.6);
    }
    .nope-big-btn:active { transform: scale(0.97); }
    .nope-hint {
      color: #ccc;
      font-size: 13px;
      line-height: 1.5;
    }
    @media (max-width: 600px) {
      .nope-banner { flex-direction: column; align-items: flex-start; gap: 10px; }
    }

    @media (max-width: 600px) {
      .module-grid { grid-template-columns: repeat(2, 1fr); }
      .hero-greeting { font-size: 18pt; }
      .flag-summary { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>

<div id="site-header"></div>
<script>
  fetch("/Academic-Allies/modular/shared-header.html")
    .then(r => r.text())
    .then(html => {
      const c = document.getElementById("site-header");
      c.innerHTML = html;
      c.querySelectorAll("script").forEach(old => {
        const s = document.createElement("script");
        Array.from(old.attributes).forEach(a => s.setAttribute(a.name, a.value));
        s.textContent = old.textContent;
        old.replaceWith(s);
      });
      const d = document.createElement("script");
      d.src = "/Academic-Allies/modular/js/draggable.js";
      d.onload = () => { if(typeof initDrag === "function") initDrag(); };
      document.body.appendChild(d);
    });
</script>

<!-- â”€â”€ Hero â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="hero">
  <div class="hero-greeting">ğŸ‘‹ Hi, <span id="heroName">there</span></div>
  <div class="hero-date" id="heroDate"></div>

  <div class="status-bar" id="statusBar">
    <div class="status-pill" id="pillCheckin">ğŸ“‹ No check-in yet today</div>
    <div class="status-pill" id="pillFlag" style="display:none;"></div>
    <div class="status-pill">ğŸ”‹ Academic Allies</div>
  </div>

  <div class="checkin-prompt" id="checkinPrompt">
    <p>Ready to do your daily check-in?</p>
    <a href="/Academic-Allies/modular/checkin.html">Check In Now â†’</a>
  </div>
</div>

<!-- â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<main class="dashboard">

  <!-- NOPE button â€” always accessible, clearly placed -->
  <div class="nope-banner" id="nopeBanner">
    <a href="/Academic-Allies/modular/nope-mode.html" class="nope-big-btn" aria-label="Activate Nope Day â€” everything goes quiet">
      ğŸ›‘ NOPE
    </a>
    <span class="nope-hint">Need to opt out completely? Tap NOPE. Your team will be notified.</span>
  </div>

  <!-- Core modules -->
  <div class="section-label">Your Tools</div>
  <div class="module-grid">
    <a class="module-card" href="/Academic-Allies/modular/checkin.html">
      <span class="module-icon">ğŸ“‹</span><span class="module-name">Daily Check-In</span>
    </a>
    <a class="module-card" href="/Academic-Allies/modular/emergency.html">
      <span class="module-icon">ğŸš¨</span><span class="module-name">Emergency Contacts</span>
    </a>
    <a class="module-card" href="/Academic-Allies/modular/components/meal-planner-mary/index.html">
      <span class="module-icon">ğŸ½ï¸</span><span class="module-name">Meal Planner</span>
    </a>
    <a class="module-card" href="/Academic-Allies/modular/components/spoon-planner/spoon-planner.html">
      <span class="module-icon">ğŸ¥„</span><span class="module-name">Spoon Planner</span>
    </a>
    <a class="module-card" id="spoonpalCard" href="/Academic-Allies/modular/components/spoon-planner/spoon-pal.html"
      style="display:none;">
      <span class="module-icon">ğŸ¥„âœ¨</span><span class="module-name">SpoonPal</span>
    </a>
    <a class="module-card" href="/Academic-Allies/modular/components/calendar/calendar.html">
      <span class="module-icon">ğŸ“…</span><span class="module-name">Calendar</span>
    </a>
    <a class="module-card" href="/Academic-Allies/modular/components/message-system/message-system.html">
      <span class="module-icon">ğŸ’¬</span><span class="module-name">Messages</span>
    </a>
    <a class="module-card" href="/Academic-Allies/modular/accommodations.html">
      <span class="module-icon">ğŸ“</span><span class="module-name">Accommodations</span>
    </a>
    <a class="module-card" href="/Academic-Allies/modular/components/recovery-mode.html">
      <span class="module-icon"><img src="/Academic-Allies/modular/icons/mode-recovery.png" width="48" height="48" alt="Recovery Mode" style="display:block;"></span><span class="module-name">Recovery Mode</span>
    </a>
    <a class="module-card" href="/Academic-Allies/modular/components/support-dashboard/support-dashboard.html" id="supportDashCard" style="display:none;">
      <span class="module-icon">ğŸª</span><span class="module-name">Support Dashboard</span>
    </a>
    <a class="module-card" href="/Academic-Allies/modular/components/user-tiers/user-tiers.html" id="networkCard" style="display:none;">
      <span class="module-icon">ğŸ¤</span><span class="module-name">My Support Network</span>
    </a>
    <!-- Updated 2026-02-26 by Claude â€” Admin â†’ Backstage Manager -->
    <a class="module-card admin-card" href="/Academic-Allies/modular/admin.html" id="adminCard" style="display:none;">
      <span class="module-icon">âš™ï¸</span><span class="module-name">Backstage Manager</span>
    </a>
  </div>

  <!-- Today's snapshot -->
  <div class="section-label">Today's Snapshot</div>
  <div class="flag-summary" id="todaySnapshot">
    <div class="flag-card green">
      <div class="flag-label">Check-ins today</div>
      <div class="flag-value" id="snapCount">â€”</div>
      <div class="flag-sub">Last: <span id="snapLast">none yet</span></div>
    </div>
    <div class="flag-card" id="snapMoodCard">
      <div class="flag-label">Last mood</div>
      <div class="flag-value" id="snapMood">â€”</div>
      <div class="flag-sub" id="snapSleepText">Sleep: â€”</div>
    </div>
    <div class="flag-card" id="snapFlagCard">
      <div class="flag-label">Flag status</div>
      <div class="flag-value" id="snapFlag">ğŸŸ¢ Clear</div>
      <div class="flag-sub" id="snapFlagSub">No alerts today</div>
    </div>
    <div class="flag-card">
      <div class="flag-label">Support contacted</div>
      <div class="flag-value" id="snapSupport">â€”</div>
      <div class="flag-sub">From today's check-in</div>
    </div>
  </div>

  <!-- Support view: shown for non-student signed-in users -->
  <!-- Added 2026-02-26 by Claude -->
  <div id="support-view" style="display:none;">
    <div class="section-label">ğŸ‘ Students You Support</div>
    <div id="support-status-cards">
      <p style="color:#aaa;font-size:0.9rem;padding:10px 0;">Loading student statusâ€¦</p>
    </div>
  </div>

  <!-- Resources -->
  <div class="section-label">Resources &amp; Reference</div>
  <div class="resource-list">
    <a class="resource-link" href="/Academic-Allies/modular/static/sitemap.html">
      <span class="ricon">ğŸ—ºï¸</span> Site Map
    </a>
    <a class="resource-link" href="/Academic-Allies/modular/icon-gallery.html">
      <span class="ricon">ğŸ–¼ï¸</span> Icon Gallery
    </a>
    <a class="resource-link" href="/Academic-Allies/modular/static/docs/TEAM-PROFILES.html">
      <span class="ricon">ğŸ‘¥</span> About the Team
    </a>
    <a class="resource-link" href="https://ppl-ai-code-interpreter-files.s3.amazonaws.com/web/direct-files/b1abf4ce293b528e9b1e94ec963ca455/f919b088-56e0-4106-b66f-efffb2426b57/index.html?utm_source=perplexity" target="_blank">
      <span class="ricon">ğŸ”—</span> Original Web Help
    </a>
    <a class="resource-link" href="/Academic-Allies/modular/components/recovery-mode.html">
      <img src="/Academic-Allies/modular/icons/mode-recovery.png" width="24" height="24" alt="Recovery Mode" style="display:inline-block;vertical-align:middle;"> Recovery Mode
    </a>
  </div>

</main>

<footer class="site-footer">
  <div class="footer-content">
    <a href="/Academic-Allies/modular/static/sitemap.html">Site Map</a>
    <a href="/Academic-Allies/modular/static/docs/TEAM-PROFILES.html">About the Team</a>
    <span>&copy; 2025 Academic Allies &mdash; Licensed under <a href="/Academic-Allies/LICENSE">MIT</a></span>
    <a href="#" id="footerSignOut" style="display:none; color:#dc3545;"
       onclick="if(typeof signOut==='function'){signOut();}else{sessionStorage.removeItem('academicAlliesUser');location.reload();} return false;">Sign Out</a>
  </div>
</footer>

<script>
// â”€â”€ Greeting & date â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  var now = new Date();
  var h = now.getHours();
  var greeting = h < 12 ? 'Good morning' : h < 17 ? 'Good afternoon' : 'Good evening';

  var user = sessionStorage.getItem("academicAlliesUser");
  var firstName = 'there';
  if (user) {
    try {
      var u = JSON.parse(user);
      firstName = (u.name || '').split(' ')[0] || 'there';
    } catch(e) {}
    // Role-specific cards are shown by shared-header auth callback, not here
    var out = document.getElementById("footerSignOut");
    if (out) out.style.display = "inline";
  }

  document.getElementById('heroName').textContent = firstName;
  document.getElementById('heroGreeting') && (document.querySelector('.hero-greeting').firstChild.textContent = greeting + ', ');
  // Fix greeting text
  document.querySelector('.hero-greeting').innerHTML = greeting + ', <span id="heroName2">' + firstName + '</span>';

  document.getElementById('heroDate').textContent = now.toLocaleDateString('en-US', {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
  });

  // â”€â”€ Today's check-in data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var dateKey = now.toISOString().split('T')[0];
  var raw = localStorage.getItem('checkins_' + dateKey);
  var log = raw ? JSON.parse(raw) : [];

  if (log.length > 0) {
    var last = log[log.length - 1];
    var lastTime = new Date(last.savedAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

    // Hide check-in prompt since they've already checked in
    document.getElementById('checkinPrompt').style.display = 'none';

    // Update status pill
    document.getElementById('pillCheckin').textContent = 'ğŸ“‹ Checked in today (' + log.length + ')';

    // Snapshot: count + last time
    document.getElementById('snapCount').textContent = log.length;
    document.getElementById('snapLast').textContent = lastTime;

    // Mood
    document.getElementById('snapMood').textContent = last.mood || 'â€”';
    var sleepTxt = last.sleep === 'yes' ? 'âœ… 6+ hrs' : last.sleep === 'no' ? 'âŒ Under 6 hrs' : 'â€” not recorded';
    document.getElementById('snapSleepText').textContent = 'Sleep: ' + sleepTxt;

    // Support
    var supTxt = last.support === 'yes' ? 'âœ… Yes' : last.support === 'no' ? 'âŒ Not yet' : 'â€” not recorded';
    document.getElementById('snapSupport').textContent = supTxt;

    // Flag â€” show worst flag from today
    var worstFlag = 'green';
    log.forEach(function(e) {
      if (e.flag === 'red') worstFlag = 'red';
      else if (e.flag === 'yellow' && worstFlag !== 'red') worstFlag = 'yellow';
    });

    var flagCard = document.getElementById('snapFlagCard');
    var flagEl = document.getElementById('snapFlag');
    var flagSub = document.getElementById('snapFlagSub');
    var flagPill = document.getElementById('pillFlag');

    if (worstFlag === 'red') {
      flagEl.textContent = 'ğŸ”´ Red Flag';
      flagSub.textContent = 'Emergency â€” please reach out';
      flagCard.className = 'flag-card red';
      flagPill.textContent = 'ğŸ”´ Red flag â€” check emergency contacts';
      flagPill.className = 'status-pill alert-red';
      flagPill.style.display = 'flex';
    } else if (worstFlag === 'yellow') {
      flagEl.textContent = 'ğŸŸ¡ Yellow Flag';
      flagSub.textContent = 'Team notified to check in';
      flagCard.className = 'flag-card yellow';
      flagPill.textContent = 'ğŸŸ¡ Yellow flag today';
      flagPill.className = 'status-pill alert-yellow';
      flagPill.style.display = 'flex';
    } else {
      flagEl.textContent = 'ğŸŸ¢ Clear';
      flagSub.textContent = 'No alerts today';
      flagCard.className = 'flag-card green';
    }
  }
})();
</script>

<!-- â”€â”€ Support view: show student status cards for non-student roles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     Added 2026-02-26 by Claude
     For support/family/nearby-help/admin: finds students they're connected to,
     reads each student's NOPE status and today's check-in flag from Firestore,
     then renders a live status card for each one on the home page.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
(function () {
  'use strict';

  var SUPPORT_ROLES = ['support', 'family', 'nearby-help', 'network-lead', 'backstage-manager'];

  function waitForAA(cb, tries) {
    tries = tries || 0;
    if (window.AA && window.AA.auth && window.AA.db) { cb(); return; }
    if (tries > 50) return;
    setTimeout(function () { waitForAA(cb, tries + 1); }, 200);
  }

  function esc(s) {
    return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  waitForAA(function () {
    window.AA.auth.onAuthStateChanged(function (user) {
      if (!user) return;
      window.AA.db.collection('users').doc(user.uid).get().then(function (doc) {
        if (!doc.exists) return;
        var role = doc.data().role || 'pending';
        if (SUPPORT_ROLES.indexOf(role) === -1) return; /* student: normal view */

        /* â”€â”€ Find which students this user is connected to â”€â”€ */
        window.AA.db.collection('users').where('role', '==', 'student').get()
          .then(function (snap) {
            var myStudents = [];
            snap.forEach(function (d) {
              var data = d.data();
              /* Admin sees ALL students; support roles only see students who added them */
              var inNetwork = data.supportNetwork && data.supportNetwork[user.uid];
              if (role === 'backstage-manager' || inNetwork) {
                myStudents.push({ uid: d.id, name: data.displayName || data.email || d.id });
              }
            });

            if (myStudents.length === 0) {
              document.getElementById('support-status-cards').innerHTML =
                '<p style="color:#aaa;font-size:0.9rem;padding:10px 0;">You\'re not in any student\'s support network yet. ' +
                'Ask your student to add you from their <a href="/Academic-Allies/modular/components/user-tiers/user-tiers.html" ' +
                'style="color:#4a7f82;">Support Network</a> page.</p>';
              document.getElementById('support-view').style.display = 'block';
              return;
            }

            /* â”€â”€ Hide student-only UI elements â”€â”€ */
            var nopeBanner   = document.getElementById('nopeBanner');
            var checkinPrompt = document.getElementById('checkinPrompt');
            var todaySnapshot = document.getElementById('todaySnapshot');
            if (nopeBanner)    nopeBanner.style.display    = 'none';
            if (checkinPrompt) checkinPrompt.style.display = 'none';
            if (todaySnapshot) todaySnapshot.style.display = 'none';
            /* Hide student-only section labels (check-ins/snapshot label) */
            var labels = document.querySelectorAll('.section-label');
            labels.forEach(function (el) {
              if (el.nextElementSibling && el.nextElementSibling.id === 'todaySnapshot') {
                el.style.display = 'none';
              }
            });

            document.getElementById('support-view').style.display = 'block';
            var container = document.getElementById('support-status-cards');
            container.innerHTML = '';

            var today = new Date().toISOString().split('T')[0];

            myStudents.forEach(function (s) {
              /* Create card placeholder immediately */
              var card = document.createElement('a');
              card.className = 'student-status-card';
              card.href = '/Academic-Allies/modular/components/user-tiers/user-tiers.html?student=' + s.uid;
              card.title = 'View ' + s.name + '\'s network';
              card.innerHTML =
                '<span class="ssc-dot unknown" id="dot-' + s.uid + '"></span>' +
                '<div class="ssc-info">' +
                  '<div class="ssc-name">' + esc(s.name) + '</div>' +
                  '<div class="ssc-status" id="status-' + s.uid + '">Loadingâ€¦</div>' +
                  '<div class="ssc-time"  id="time-'   + s.uid + '"></div>' +
                '</div>' +
                '<span class="ssc-link">View network â†’</span>';
              container.appendChild(card);

              /* Fetch NOPE status and today's check-in in parallel */
              var nopePromise    = window.AA.db.collection('nope').doc(s.uid).get();
              var checkinPromise = window.AA.db.collection('checkins').doc(s.uid)
                .collection('days').doc(today).get();

              Promise.all([nopePromise, checkinPromise]).then(function (results) {
                var nopeDoc    = results[0];
                var checkinDoc = results[1];

                var dot    = document.getElementById('dot-'    + s.uid);
                var status = document.getElementById('status-' + s.uid);
                var time   = document.getElementById('time-'   + s.uid);

                /* NOPE mode overrides everything */
                var nopeData = nopeDoc.exists ? nopeDoc.data() : null;
                if (nopeData && (nopeData.mode === 'nope' || nopeData.mode === 'semi-nope')) {
                  var modeLabel = nopeData.mode === 'nope' ? 'â›” NOPE mode is active' : 'ğŸŸ¡ Semi-Nope mode is active';
                  dot.className    = 'ssc-dot nope';
                  status.textContent = modeLabel;
                  if (nopeData.updatedAt && nopeData.updatedAt.toDate) {
                    time.textContent = 'Since ' + nopeData.updatedAt.toDate().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
                  }
                  return;
                }

                /* Check-in flag for today */
                var entries = checkinDoc.exists ? (checkinDoc.data().entries || []) : [];
                if (entries.length === 0) {
                  dot.className    = 'ssc-dot unknown';
                  status.textContent = 'ğŸ“‹ No check-in today yet';
                  time.textContent   = '';
                  return;
                }

                /* Find worst flag */
                var worst = 'green';
                entries.forEach(function (e) {
                  if (e.flag === 'red') worst = 'red';
                  else if (e.flag === 'orange' && worst !== 'red') worst = 'orange';
                  else if (e.flag === 'yellow' && worst === 'green') worst = 'yellow';
                });

                var lastEntry = entries[entries.length - 1];
                var lastTime  = '';
                if (lastEntry.savedAt) {
                  lastTime = new Date(lastEntry.savedAt).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
                }

                var labels = {
                  red:    'ğŸ”´ Red flag â€” needs attention',
                  orange: 'ğŸŸ  Orange flag â€” check in',
                  yellow: 'ğŸŸ¡ Yellow flag â€” heads up',
                  green:  'ğŸŸ¢ Checked in â€” all clear'
                };

                dot.className      = 'ssc-dot ' + worst;
                status.textContent = labels[worst] || 'ğŸŸ¢ Checked in';
                time.textContent   = entries.length + ' check-in' + (entries.length === 1 ? '' : 's') + ' today' +
                                     (lastTime ? ' Â· last at ' + lastTime : '');

              }).catch(function () {
                var status = document.getElementById('status-' + s.uid);
                if (status) status.textContent = 'Status unavailable';
              });
            });
          });
      });
    });
  });
})();
</script>

</body>
</html>
