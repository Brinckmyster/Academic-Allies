<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Academic Allies</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" href="icons/academic-allies.png" />
  <link rel="apple-touch-icon" href="icons/academic-allies.png" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background: #f5f7fa; }
    header { display: flex; align-items: center; background: #2d3a4a; color: #fff; padding: 1rem; }
    .logo { width: 40px; height: 40px; margin-right: 1rem; cursor: pointer; }
    .status-circle { width: 32px; height: 32px; border-radius: 50%; display: inline-block; margin-left: 1rem; border: 3px solid #888; vertical-align: middle; transition: background 0.2s; }
    nav { display: flex; gap: 1rem; margin-left: auto; }
    .nav-btn { background: none; border: none; color: #fff; font-size: 1rem; cursor: pointer; padding: 0.5rem 1rem; border-radius: 5px; transition: background 0.2s; }
    .nav-btn.active, .nav-btn:focus { background: #4f6d7a; outline: none; }
    main { max-width: 900px; margin: 2rem auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px #0001; padding: 2rem; }
    section { display: none; }
    section.active { display: block; }
    .google-btn { background: #fff; border: 1px solid #888; color: #333; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; margin-top: 1rem; }
    .google-btn:hover { background: #f0f0f0; }
    .user-info { margin-top: 1rem; }
    .calendar-list { margin: 1rem 0; }
    .calendar-event { border-bottom: 1px solid #eee; padding: 0.5rem 0; }
    .log-list { max-height: 200px; overflow-y: auto; background: #f9f9f9; border-radius: 6px; padding: 1rem; margin-bottom: 1rem; }
    .log-entry { font-size: 0.95rem; color: #333; margin-bottom: 0.5rem; }
    .message-list { max-height: 200px; overflow-y: auto; background: #f9f9f9; border-radius: 6px; padding: 1rem; margin-bottom: 1rem; }
    .message-entry { margin-bottom: 0.5rem; }
    .admin-panel { background: #f5f7fa; border-radius: 8px; padding: 1rem; margin-top: 1rem; }
    .hidden { display: none; }
    .msg-input-box { display: flex; gap: 0.5rem; }
    .msg-input-box input, .msg-input-box select { flex: 1; padding: 0.5rem; border-radius: 4px; border: 1px solid #aaa; }
    .msg-input-box button { padding: 0.5rem 1rem; border-radius: 4px; border: none; background: #4f6d7a; color: #fff; cursor: pointer; }
    .msg-input-box button:disabled { background: #aaa; }
    .tier-list { margin: 1rem 0; }
    .tier-row { display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem; }
    .tier-row select { min-width: 100px; }
    .tier-row button { padding: 0.2rem 0.7rem; }
    .tier-desc { font-size: 0.92em; color: #555; margin-left: 0.5em; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <header>
    <img src="icons/academic-allies.png" alt="Academic Allies Logo" class="logo" id="homeIcon" title="Go to Dashboard" />
    <h1 style="font-size:1.5rem; margin:0;">Academic Allies</h1>
    <span class="status-circle" id="statusCircle" aria-label="Sign-in Status"></span>
    <nav>
      <button class="nav-btn active" data-section="dashboard">Dashboard</button>
      <button class="nav-btn" data-section="messages">Messages</button>
      <button class="nav-btn" data-section="admin">Admin Panel</button>
      <button class="nav-btn" data-section="settings">Settings</button>
    </nav>
  </header>
  <main>
    <!-- Dashboard Section -->
    <section id="dashboard" class="active">
      <h2>Dashboard</h2>
      <div>
        <h3>Google Calendar Events</h3>
        <div>
          <button id="calendarAuthBtn" class="google-btn">Connect Google Calendar</button>
          <button id="calendarSignOutBtn" class="google-btn" style="display:none;">Disconnect Calendar</button>
        </div>
        <div class="calendar-list" id="calendarEvents"></div>
        <div id="calendarError" style="color:#c00;"></div>
      </div>
    </section>
    <!-- Messages Section -->
    <section id="messages">
      <h2>Messages</h2>
      <div class="message-list" id="messageList"></div>
      <div class="msg-input-box" id="msgInputBox">
        <select id="recipientSelect" aria-label="Message Recipient"></select>
        <input type="text" id="messageInput" placeholder="Type your message..." autocomplete="off" aria-label="Message Text" />
        <button id="sendMessageBtn">Send</button>
      </div>
    </section>
    <!-- Admin Panel Section -->
    <section id="admin">
      <h2>Admin Panel</h2>
      <div class="admin-panel" id="adminPanel" style="display:none;">
        <h3>User Logs</h3>
        <div class="log-list" id="logList"></div>
        <h3>Manage Supporters & Tiers</h3>
        <div class="tier-list" id="tierList"></div>
        <div>
          <input type="email" id="newSupporterEmail" placeholder="Supporter email" aria-label="Add Supporter Email" />
          <select id="newSupporterTier" aria-label="Assign Tier">
            <option value="tier1">Tier 1 – Family</option>
            <option value="tier2">Tier 2 – Support</option>
            <option value="tier3">Tier 3 – Admin</option>
            <option value="tier4">Tier 4 – Nearby Help</option>
            <option value="tier5">Tier 5 – General</option>
          </select>
          <button id="addSupporterBtn">Add Supporter</button>
        </div>
        <div style="margin-top:1rem;" id="maryOverrideBox" class="hidden">
          <label>
            <input type="checkbox" id="maryOverride" />
            Mary controls all admin rights (if checked, only Mary is admin)
          </label>
        </div>
      </div>
      <div id="notAdminMsg" class="hidden">You do not have admin privileges.</div>
    </section>
    <!-- Settings Section -->
    <section id="settings">
      <h2>Settings</h2>
      <div id="authSection">
        <button class="google-btn" id="signInBtn">Sign in with Google</button>
        <button class="google-btn" id="signOutBtn" style="display:none;">Sign out</button>
        <div class="user-info" id="userInfo"></div>
      </div>
    </section>
  </main>
  <script>
    // --- Firebase Config: Academic Allies Project ---
    const firebaseConfig = {
      apiKey: "AIzaSyDk9mwSZgk9I65RpYlus7by9mB8tN_oskE",
      authDomain: "academic-allies-464901.firebaseapp.com",
      projectId: "academic-allies-464901",
      storageBucket: "academic-allies-464901.firebasestorage.app",
      messagingSenderId: "93996985456",
      appId: "1:93996985456:web:c697df7623bbceeb1d18b5"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- Tier System Definitions ---
    const TIER_LABELS = {
      "tier1": "Family",
      "tier2": "Support",
      "tier3": "Admin",
      "tier4": "Nearby Help",
      "tier5": "General"
    };
    const TIER_DESCRIPTIONS = {
      "tier1": "Trusted family members",
      "tier2": "Friends, mentors, optionally staff",
      "tier3": "Designated adult (parent/guardian/trusted)",
      "tier4": "Roommates, classmates, RAs, in-person help",
      "tier5": "General supporters"
    };

    // --- Navigation Logic: Panels Switch & Home Icon ---
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
        document.getElementById(this.dataset.section).classList.add('active');
      });
    });
    document.getElementById('homeIcon').onclick = function() {
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.querySelector('.nav-btn[data-section="dashboard"]').classList.add('active');
      document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
      document.getElementById('dashboard').classList.add('active');
    };

    // --- Status Circle Logic (Always in Header) ---
    function updateStatusCircle() {
      const circle = document.getElementById('statusCircle');
      if (auth.currentUser) {
        circle.style.background = '#2ecc40';
        circle.title = "Signed in";
      } else {
        circle.style.background = '#ff4136';
        circle.title = "Not signed in";
      }
    }

    // --- Google Sign-In Persistent Auth ---
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const userInfo = document.getElementById('userInfo');

    function showUser(user) {
      if (user) {
        userInfo.textContent = `Signed in as ${user.displayName || user.email}`;
        signInBtn.style.display = 'none';
        signOutBtn.style.display = '';
      } else {
        userInfo.textContent = '';
        signInBtn.style.display = '';
        signOutBtn.style.display = 'none';
      }
      updateStatusCircle();
    }

    auth.onAuthStateChanged(user => {
      showUser(user);
      setupAdminPanel(user);
      loadMessages();
      loadLogs();
      loadSupporters();
      setupRecipientOptions(user);
    });

    signInBtn.addEventListener('click', () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(err => alert("Sign-in error: " + err.message));
    });

    signOutBtn.addEventListener('click', () => {
      auth.signOut();
    });

    window.addEventListener('DOMContentLoaded', updateStatusCircle);

    // --- Google Calendar Integration (Robust, with Listeners) ---
    const CLIENT_ID = "93996985456-ftjjdrj4t32h106o7cmstiuqut32vf0g.apps.googleusercontent.com";
    const API_KEY = "AIzaSyDk9mwSZgk9I65RpYlus7by9mB8tN_oskE";
    const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest";
    const SCOPES = "https://www.googleapis.com/auth/calendar.readonly";
    let gapiInited = false;
    let calendarAuthed = false;

    function updateCalendarUI() {
      document.getElementById('calendarAuthBtn').style.display = calendarAuthed ? 'none' : '';
      document.getElementById('calendarSignOutBtn').style.display = calendarAuthed ? '' : 'none';
    }

    function listUpcomingEvents() {
      gapi.client.calendar.events.list({
        'calendarId': 'primary',
        'timeMin': (new Date()).toISOString(),
        'showDeleted': false,
        'singleEvents': true,
        'maxResults': 5,
        'orderBy': 'startTime'
      }).then(function(response) {
        const events = response.result.items;
        const eventsDiv = document.getElementById('calendarEvents');
        eventsDiv.innerHTML = '';
        if (events.length === 0) {
          eventsDiv.innerHTML = '<div>No upcoming events found.</div>';
        } else {
          events.forEach(event => {
            let when = event.start.dateTime || event.start.date;
            eventsDiv.innerHTML += `<div class="calendar-event"><strong>${event.summary || '(No title)'}</strong><br/><span>${when}</span></div>`;
          });
        }
        document.getElementById('calendarError').textContent = "";
      }, function(error) {
        document.getElementById('calendarError').textContent = "Failed to load calendar events.";
      });
    }

    function gapiLoaded() {
      gapi.load('client:auth2', initializeGapiClient);
    }

    function initializeGapiClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: [DISCOVERY_DOC],
        scope: SCOPES
      }).then(() => {
        gapiInited = true;
        const authInstance = gapi.auth2.getAuthInstance();
        calendarAuthed = authInstance.isSignedIn.get();
        updateCalendarUI();
        if (calendarAuthed) listUpcomingEvents();
        authInstance.isSignedIn.listen(isSignedIn => {
          calendarAuthed = isSignedIn;
          updateCalendarUI();
          if (isSignedIn) listUpcomingEvents();
          else document.getElementById('calendarEvents').innerHTML = '';
        });
      }, function(error) {
        document.getElementById('calendarError').textContent = "Google Calendar failed to initialize.";
      });
    }

    document.getElementById('calendarAuthBtn').onclick = () => {
      if (!gapiInited) {
        gapiLoaded();
      } else {
        gapi.auth2.getAuthInstance().signIn().then(() => {
          calendarAuthed = true;
          updateCalendarUI();
          listUpcomingEvents();
        });
      }
    };
    document.getElementById('calendarSignOutBtn').onclick = () => {
      if (gapiInited) {
        gapi.auth2.getAuthInstance().signOut().then(() => {
          calendarAuthed = false;
          updateCalendarUI();
          document.getElementById('calendarEvents').innerHTML = '';
        });
      }
    };
    window.onload = function() {
      gapiLoaded();
    };

    // --- Supporters & Tiers Management ---
    let supporters = [];
    function loadSupporters() {
      db.collection("supporters").onSnapshot(snapshot => {
        supporters = [];
        snapshot.forEach(doc => {
          let data = doc.data();
          supporters.push({email: data.email, tier: data.tier});
        });
        renderTierList();
        setupRecipientOptions(auth.currentUser);
      });
    }

    function renderTierList() {
      const tierListDiv = document.getElementById('tierList');
      tierListDiv.innerHTML = '';
      supporters.forEach(sup => {
        const row = document.createElement('div');
        row.className = "tier-row";
        row.innerHTML = `<span>${sup.email}</span>
          <select>
            <option value="tier1" ${sup.tier === "tier1" ? "selected" : ""}>Tier 1 – Family</option>
            <option value="tier2" ${sup.tier === "tier2" ? "selected" : ""}>Tier 2 – Support</option>
            <option value="tier3" ${sup.tier === "tier3" ? "selected" : ""}>Tier 3 – Admin</option>
            <option value="tier4" ${sup.tier === "tier4" ? "selected" : ""}>Tier 4 – Nearby Help</option>
            <option value="tier5" ${sup.tier === "tier5" ? "selected" : ""}>Tier 5 – General</option>
          </select>
          <span class="tier-desc">${TIER_DESCRIPTIONS[sup.tier]}</span>
          <button>Remove</button>`;
        row.querySelector('select').onchange = function() {
          db.collection("supporters").doc(sup.email).set({email: sup.email, tier: this.value});
        };
        row.querySelector('button').onclick = function() {
          db.collection("supporters").doc(sup.email).delete();
        };
        tierListDiv.appendChild(row);
      });
    }
    document.getElementById('addSupporterBtn').onclick = function() {
      const email = document.getElementById('newSupporterEmail').value.trim();
      const tier = document.getElementById('newSupporterTier').value;
      if (email) {
        db.collection("supporters").doc(email).set({email, tier});
        document.getElementById('newSupporterEmail').value = '';
      }
    };

    // --- Admin Panel & Mary Override (only visible to Mary) ---
    const adminEmailsBase = ["brinckmyster@gmail.com", "mbrinck90@gmail.com"];
    function setupAdminPanel(user) {
      let adminEmails = [...adminEmailsBase];
      const maryOverrideBox = document.getElementById('maryOverrideBox');
      if (user && user.email === "mbrinck90@gmail.com") {
        maryOverrideBox.classList.remove('hidden');
        const maryOverride = document.getElementById('maryOverride');
        if (maryOverride && maryOverride.checked) {
          adminEmails = ["mbrinck90@gmail.com"];
        }
      } else {
        maryOverrideBox.classList.add('hidden');
      }
      const isAdmin = user && adminEmails.includes(user.email);
      document.getElementById('adminPanel').style.display = isAdmin ? '' : 'none';
      document.getElementById('notAdminMsg').classList.toggle('hidden', isAdmin);
      if (isAdmin) {
        loadLogs();
        renderTierList();
      }
    }
    const maryOverride = document.getElementById('maryOverride');
    if (maryOverride) {
      maryOverride.onchange = function() {
        setupAdminPanel(auth.currentUser);
      };
    }

    // --- Logs ---
    function loadLogs() {
      const logList = document.getElementById('logList');
      db.collection("logs").orderBy("timestamp", "desc").limit(50).onSnapshot(snapshot => {
        logList.innerHTML = '';
        snapshot.forEach(doc => {
          const log = doc.data();
          logList.innerHTML += `<div class="log-entry">${log.timestamp ? log.timestamp.toDate().toLocaleString() : ''} — ${log.message}</div>`;
        });
      });
    }
    function logAction(message) {
      const user = auth.currentUser;
      db.collection("logs").add({
        user: user ? (user.displayName || user.email) : "Anon",
        message: message,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    auth.onAuthStateChanged(user => {
      if (user) logAction("Signed in");
      else logAction("Signed out");
    });

    // --- Messaging: Five-Tier Routing, Mary Sees All, Supporters See Only Their Messages ---
    const messageList = document.getElementById('messageList');
    const messageInput = document.getElementById('messageInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const recipientSelect = document.getElementById('recipientSelect');

    function setupRecipientOptions(user) {
      recipientSelect.innerHTML = '';
      if (!user) return;
      const isMary = user.email === "mbrinck90@gmail.com";
      if (isMary) {
        recipientSelect.innerHTML += `<option value="all">All Supporters</option>`;
        Object.keys(TIER_LABELS).forEach(tier => {
          recipientSelect.innerHTML += `<option value="${tier}">Tier: ${TIER_LABELS[tier]}</option>`;
        });
        supporters.forEach(sup => {
          recipientSelect.innerHTML += `<option value="user:${sup.email}">${sup.email} (${TIER_LABELS[sup.tier]})</option>`;
        });
      } else {
        // Supporters can message Mary and other supporters
        recipientSelect.innerHTML += `<option value="user:mbrinck90@gmail.com">Mary (Student)</option>`;
        supporters.forEach(sup => {
          if (sup.email !== user.email) {
            recipientSelect.innerHTML += `<option value="user:${sup.email}">${sup.email} (${TIER_LABELS[sup.tier]})</option>`;
          }
        });
      }
    }

    function getUserTier(email) {
      const s = supporters.find(s => s.email === email);
      return s ? s.tier : null;
    }

    function loadMessages() {
      auth.onAuthStateChanged(user => {
        if (!user) {
          messageList.innerHTML = '<div>Please sign in to view messages.</div>';
          return;
        }
        db.collection("messages").orderBy("timestamp", "asc").onSnapshot(snapshot => {
          messageList.innerHTML = '';
          snapshot.forEach(doc => {
            const msg = doc.data();
            // Mary sees all messages
            if (
              user.email === "mbrinck90@gmail.com" ||
              (msg.recipients && (
                msg.recipients.includes("all") ||
                Object.keys(TIER_LABELS).some(tier => msg.recipients.includes(tier) && getUserTier(user.email) === tier) ||
                msg.recipients.includes(`user:${user.email}`)
              ))
            ) {
              messageList.innerHTML += `<div class="message-entry"><strong>${msg.user || 'Anon'}:</strong> ${msg.text}</div>`;
            }
          });
          messageList.scrollTop = messageList.scrollHeight;
        });
      });
    }

    sendMessageBtn.onclick = () => {
      const user = auth.currentUser;
      const text = messageInput.value.trim();
      const recipient = recipientSelect.value;
      if (!user || !text || !recipient) return;
      let recipients = [];
      if (recipient === "all") {
        recipients = ["all"];
      } else if (Object.keys(TIER_LABELS).includes(recipient)) {
        recipients = [recipient];
      } else if (recipient.startsWith("user:")) {
        recipients = [recipient];
      }
      db.collection("messages").add({
        user: user.displayName || user.email || "Anon",
        text: text,
        recipients: recipients,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      messageInput.value = '';
      logAction("Sent a message");
    };
  </script>
</body>
</html>
