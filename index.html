<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Academic Allies</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Content Security Policy allowing Google and Firebase -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' https://accounts.google.com https://apis.google.com https://www.gstatic.com https://www.googleapis.com 'unsafe-inline';
          frame-src https://accounts.google.com;
          style-src 'self' 'unsafe-inline';
          connect-src 'self' https://accounts.google.com https://www.googleapis.com https://*.firebaseio.com;
          img-src 'self' data:;
        ">

  <link rel="icon" href="icons/home.png">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="css/style.css">

  <style>
    body { margin:0; font-family:sans-serif; background:#f8fafc; }
    /* Fixed status circle (top left) */
    #statusCircle {
      position: fixed;
      top: 1rem;
      left: 1rem;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #3b82f6;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    }
    /* Fixed home icon (top right) */
    .home-icon {
      position: fixed;
      top: 1rem;
      right: 1rem;
      width: 40px;
      height: 40px;
      z-index: 1000;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    }
    .google-integration {
      background: #fff;
      border-radius:1rem;
      padding:1.5rem;
      max-width:400px;
      margin:7rem auto 2rem auto;
      box-shadow:0 2px 8px rgba(0,0,0,0.07);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .google-btn {
      background: #3b82f6;
      color:#fff;
      border:none;
      border-radius:0.5em;
      padding:0.6em 1.4em;
      font-size:1em;
      cursor:pointer;
      transition:background 0.2s;
      display:flex;
      align-items:center;
      margin-bottom:1em;
    }
    .google-btn:focus { outline:2px solid #6366f1; }
    .google-icon {
      display:inline-block;
      width:1.2em;
      height:1.2em;
      background:url('https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg') no-repeat center/contain;
      vertical-align:middle;
      margin-right:0.5em;
    }
    .google-user { margin-left:1em; font-weight:600; color:#22223b; }
    .hidden { display:none !important; }
    /* Responsive for mobile */
    @media (max-width: 600px) {
      .google-integration { max-width:95vw; }
      #statusCircle, .home-icon { width:44px; height:44px; }
    }
  </style>
</head>
<body>
  <!-- Always visible: status circle and home icon -->
  <div id="statusCircle" title="Status"></div>
  <img src="icons/home.png" alt="Home" class="home-icon">

  <!-- Pre-auth UI: Only Google sign-in visible -->
  <div id="pre-auth">
    <section id="google-integration" class="google-integration" aria-label="Google Sign-In">
      <button id="google-signin-btn" class="google-btn">
        <span class="google-icon"></span>Sign in with Google
      </button>
      <span id="google-user" class="google-user hidden"></span>
      <button id="google-signout-btn" class="google-btn hidden">Sign out</button>
    </section>
  </div>

  <!-- Post-auth UI: Hidden until sign-in -->
  <div id="post-auth" class="hidden">
    <section id="settings-root" aria-label="App Settings">
      <form id="settings-form" class="settings-form">
        <label for="showEmoji">
          <input type="checkbox" id="showEmoji" name="showEmoji">
          Enable Emoji in Status Circle
        </label>
      </form>
    </section>
    <section id="modes-root" aria-label="App Mode Switcher">
      <div data-include="components/modes/modes.html"></div>
    </section>
    <section id="user-tiers-root" aria-label="User Roles and Permissions">
      <div data-include="components/user-tiers/user-tiers.html"></div>
    </section>
    <section id="spoon-planner-root" aria-label="Daily Spoon Planner">
      <div data-include="components/spoon-planner/spoon-planner.html"></div>
    </section>
    <section id="meal-planner-root" aria-label="Meal Planner">
      <div data-include="components/meal-planner/meal-planner.html"></div>
    </section>
    <section id="message-system-root" aria-label="Support Messages">
      <div data-include="components/message-system/message-system.html"></div>
    </section>
    <!-- Add any other features/components here -->
  </div>

  <!-- Google Identity, Firebase, and GAPI scripts -->
  <script src="https://accounts.google.com/gsi/client"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>

  <script>
    // Config
    const firebaseConfig = {
      apiKey: "AIzaSyBVQFGHbFGHbFGHbFGHbFGHbFGHbFGHbFGH",
      authDomain: "academic-allies-464901.firebaseapp.com",
      projectId: "academic-allies-464901",
      storageBucket: "academic-allies-464901.appspot.com",
      messagingSenderId: "123456789012",
      appId: "1:123456789012:web:abcdef123456789012345678"
    };
    const GOOGLE_CLIENT_ID = "93996985456-ftjjdrj4t32h106o7cmstiuqut32vf0g.apps.googleusercontent.com";

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.getAuth(app);

    // Helper to show/hide sections
    function showPostAuthUI(user) {
      document.getElementById('pre-auth').classList.add('hidden');
      document.getElementById('post-auth').classList.remove('hidden');
      document.getElementById('google-user').textContent = user.name || user.email;
      document.getElementById('google-user').classList.remove('hidden');
      document.getElementById('google-signout-btn').classList.remove('hidden');
      document.getElementById('google-signin-btn').classList.add('hidden');
    }
    function showPreAuthUI() {
      document.getElementById('pre-auth').classList.remove('hidden');
      document.getElementById('post-auth').classList.add('hidden');
      document.getElementById('google-user').classList.add('hidden');
      document.getElementById('google-signout-btn').classList.add('hidden');
      document.getElementById('google-signin-btn').classList.remove('hidden');
    }

    // Google Sign-In logic
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('google-signin-btn').onclick = function() {
        // Ensure GSI is loaded before initializing
        if (typeof google === "undefined" || !google.accounts || !google.accounts.id) {
          alert("Google Identity Services failed to load. Check your internet connection or CSP.");
          return;
        }
        google.accounts.id.initialize({
          client_id: GOOGLE_CLIENT_ID,
          callback: handleCredentialResponse
        });
        google.accounts.id.prompt();
      };
      document.getElementById('google-signout-btn').onclick = async function() {
        await firebase.signOut(auth);
        showPreAuthUI();
      };
    });

    async function handleCredentialResponse(resp) {
      const userInfo = parseJwt(resp.credential);
      try {
        const cred = firebase.GoogleAuthProvider.credential(resp.credential);
        await firebase.signInWithCredential(auth, cred);
        showPostAuthUI(userInfo);
      } catch (e) {
        alert("Google sign-in failed.");
        showPreAuthUI();
      }
    }
    function parseJwt(t) {
      try {
        const p = t.split('.')[1].replace(/-/g,'+').replace(/_/g,'/');
        return JSON.parse(decodeURIComponent(atob(p).split('').map(c=>'%' + ('00'+c.charCodeAt(0).toString(16)).slice(-2)).join('')));
      } catch { return {}; }
    }

    // Dynamically load HTML includes for post-auth features
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('[data-include]').forEach(async (el) => {
        const file = el.getAttribute('data-include');
        const res = await fetch(file);
        if (res.ok) el.innerHTML = await res.text();
      });
    });
  </script>
</body>
</html>
