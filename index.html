<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Academic Allies</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Content Security Policy allowing Google and Firebase -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' https://accounts.google.com https://apis.google.com https://www.gstatic.com https://www.googleapis.com 'unsafe-inline';
          frame-src https://accounts.google.com;
          style-src 'self' 'unsafe-inline';
          connect-src 'self' https://accounts.google.com https://www.googleapis.com https://*.firebaseio.com;
          img-src 'self' data:;
        ">

  <link rel="icon" href="icons/academic-allies.png">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="css/style.css">

  <style>
    body { margin:0; font-family:sans-serif; background:#f8fafc; }
    /* Fixed status circle (top LEFT) */
    #statusCircle {
      position: fixed;
      top: 1rem;
      left: 1rem;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #3b82f6;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    }
    /* Fixed home icon (top RIGHT) */
    .home-icon {
      position: fixed;
      top: 1rem;
      right: 1rem;
      width: 40px;
      height: 40px;
      z-index: 1000;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      padding: 8px;
    }
    .google-integration {
      background: #fff;
      border-radius:1rem;
      padding:1.5rem;
      max-width:400px;
      margin:7rem auto 2rem auto;
      box-shadow:0 2px 8px rgba(0,0,0,0.07);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .google-btn {
      background: #4285f4;
      color:#fff;
      border:none;
      border-radius:6px;
      padding:12px 24px;
      font-size:16px;
      font-weight:500;
      cursor:pointer;
      transition:background 0.2s;
      display:flex;
      align-items:center;
      margin-bottom:1em;
      min-width:200px;
      justify-content:center;
    }
    .google-btn:hover { background: #357ae8; }
    .google-btn:focus { outline:2px solid #6366f1; }
    .google-icon {
      display:inline-block;
      width:20px;
      height:20px;
      background:url('https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg') no-repeat center/contain;
      vertical-align:middle;
      margin-right:8px;
    }
    .google-user { margin-top:1em; font-weight:600; color:#22223b; }
    .hidden { display:none !important; }
    /* Responsive for mobile */
    @media (max-width: 600px) {
      .google-integration { max-width:95vw; margin:6rem auto 2rem auto; }
      #statusCircle, .home-icon { width:44px; height:44px; }
      .home-icon { padding:6px; }
    }
  </style>
</head>
<body>
  <!-- Always visible: status circle (LEFT) and home icon (RIGHT) -->
  <div id="statusCircle" title="Status"></div>
  <img src="icons/academic-allies.png" alt="Home" class="home-icon">

  <!-- Pre-auth UI: Only Google sign-in visible -->
  <div id="pre-auth">
    <section id="google-integration" class="google-integration" aria-label="Google Sign-In">
      <button id="google-signin-btn" class="google-btn">
        <span class="google-icon"></span>Sign in with Google
      </button>
      <span id="google-user" class="google-user hidden"></span>
      <button id="google-signout-btn" class="google-btn hidden">Sign out</button>
    </section>
  </div>

  <!-- Post-auth UI: Hidden until sign-in -->
  <div id="post-auth" class="hidden">
    <section id="settings-root" aria-label="App Settings">
      <form id="settings-form" class="settings-form">
        <label for="showEmoji">
          <input type="checkbox" id="showEmoji" name="showEmoji">
          Enable Emoji in Status Circle
        </label>
      </form>
    </section>
    <section id="modes-root" aria-label="App Mode Switcher">
      <div data-include="components/modes/modes.html"></div>
    </section>
    <section id="user-tiers-root" aria-label="User Roles and Permissions">
      <div data-include="components/user-tiers/user-tiers.html"></div>
    </section>
    <section id="spoon-planner-root" aria-label="Daily Spoon Planner">
      <div data-include="components/spoon-planner/spoon-planner.html"></div>
    </section>
    <section id="meal-planner-root" aria-label="Meal Planner">
      <div data-include="components/meal-planner/meal-planner.html"></div>
    </section>
    <section id="message-system-root" aria-label="Support Messages">
      <div data-include="components/message-system/message-system.html"></div>
    </section>
    <!-- Add any other features/components here -->
  </div>

  <!-- Load Google Identity and Firebase scripts in correct order -->
  <script src="https://accounts.google.com/gsi/client"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>

  <script>
    // Configuration - Replace with your actual values
    const firebaseConfig = {
      apiKey: "AIzaSyBVQFGHbFGHbFGHbFGHbFGHbFGHbFGHbFGH",
      authDomain: "academic-allies-464901.firebaseapp.com",
      projectId: "academic-allies-464901",
      storageBucket: "academic-allies-464901.appspot.com",
      messagingSenderId: "123456789012",
      appId: "1:123456789012:web:abcdef123456789012345678"
    };
    const GOOGLE_CLIENT_ID = "93996985456-q2tc0c02de3r2ikqu6bheogbektlsso7.apps.googleusercontent.com";

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.getAuth(app);

    // UI state management
    function showPostAuthUI(user) {
      document.getElementById('pre-auth').classList.add('hidden');
      document.getElementById('post-auth').classList.remove('hidden');
      document.getElementById('google-user').textContent = user.name || user.email;
      document.getElementById('google-user').classList.remove('hidden');
      document.getElementById('google-signout-btn').classList.remove('hidden');
      document.getElementById('google-signin-btn').classList.add('hidden');
    }

    function showPreAuthUI() {
      document.getElementById('pre-auth').classList.remove('hidden');
      document.getElementById('post-auth').classList.add('hidden');
      document.getElementById('google-user').classList.add('hidden');
      document.getElementById('google-signout-btn').classList.add('hidden');
      document.getElementById('google-signin-btn').classList.remove('hidden');
    }

    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
      // Google Sign-In button handler
      document.getElementById('google-signin-btn').addEventListener('click', function() {
        console.log('Sign-in button clicked');
        
        // Check if Google Identity Services is loaded
        if (typeof google === "undefined" || !google.accounts || !google.accounts.id) {
          console.error('Google Identity Services not loaded');
          alert("Google Identity Services failed to load. Please check your internet connection.");
          return;
        }

        try {
          google.accounts.id.initialize({
            client_id: GOOGLE_CLIENT_ID,
            callback: handleCredentialResponse,
            auto_select: false,
            cancel_on_tap_outside: false
          });
          
          google.accounts.id.prompt();
        } catch (error) {
          console.error('Error initializing Google Sign-In:', error);
          alert("Failed to initialize Google Sign-In. Please try again.");
        }
      });

      // Sign-out button handler
      document.getElementById('google-signout-btn').addEventListener('click', async function() {
        try {
          await firebase.signOut(auth);
          showPreAuthUI();
        } catch (error) {
          console.error('Sign-out error:', error);
        }
      });

      // Load component includes
      document.querySelectorAll('[data-include]').forEach(async (el) => {
        const file = el.getAttribute('data-include');
        try {
          const res = await fetch(file);
          if (res.ok) {
            el.innerHTML = await res.text();
          }
        } catch (error) {
          console.log('Could not load component:', file);
        }
      });
    });

    // Handle Google credential response
    async function handleCredentialResponse(response) {
      console.log('Credential response received');
      
      try {
        const userInfo = parseJwt(response.credential);
        console.log('User info:', userInfo);
        
        const credential = firebase.GoogleAuthProvider.credential(response.credential);
        await firebase.signInWithCredential(auth, credential);
        
        showPostAuthUI(userInfo);
      } catch (error) {
        console.error('Sign-in error:', error);
        alert("Google sign-in failed. Please try again.");
        showPreAuthUI();
      }
    }

    // Parse JWT token
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      } catch (error) {
        console.error('Error parsing JWT:', error);
        return {};
      }
    }
  </script>
</body>
</html>
